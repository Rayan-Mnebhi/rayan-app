<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rayan - Plataforma de Gesti√≥n de Estudios</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#B94A48">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Rayan">
    <link rel="apple-touch-icon" href="icon-512.png">
    <meta name="description" content="Plataforma completa de gesti√≥n acad√©mica con horarios, tareas, calendario y m√°s">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs (compat version) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Google API Client Library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; cursor: default; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; overflow-x: hidden; }
        
        /* Cursores correctos para cada tipo de elemento */
        a, button, .nav-item, [onclick], [role="button"] { cursor: pointer !important; }
        input, textarea, select, [contenteditable="true"] { cursor: text !important; }
        input[type="checkbox"], input[type="radio"], input[type="range"] { cursor: pointer !important; }
        
        .sidebar { 
            position: fixed; 
            left: 0; 
            top: 0; 
            bottom: 0; 
            width: 256px; 
            background: white; 
            border-right: 1px solid #e5e7eb; 
            overflow-y: auto; 
            z-index: 40;
            display: flex;
            flex-direction: column;
        }
        
        .main-content { 
            margin-left: 256px; 
            min-height: 100vh; 
            background: #f9fafb; 
        }
        
        .nav-item { 
            display: flex; 
            align-items: center; 
            padding: 12px 20px; 
            color: #6b7280; 
            cursor: pointer; 
            border-left: 3px solid transparent; 
            transition: all 0.2s;
            user-select: none;
        }
        
        .nav-item:hover { background: #f3f4f6; color: #111827; }
        .nav-item.active { background: #eff6ff; color: #3b82f6; border-left-color: #3b82f6; font-weight: 500; }
        .nav-item i { width: 20px; margin-right: 12px; font-size: 18px; }
        
        .calculator-tab {
            padding: 0.75rem 1.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            background: white;
            color: #4b5563;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .calculator-tab:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        .calculator-tab.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .sidebar-bottom {
            margin-top: auto;
        }
        
        /* Bot√≥n para ABRIR sidebar (fuera del sidebar) */
        #openSidebarBtn {
            display: none;
            position: fixed;
            bottom: 1.5rem;
            left: 1.5rem;
            z-index: 998;
            background: white;
            border: none;
            padding: 0.75rem;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #openSidebarBtn:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            transform: translateY(-2px);
        }
        
        #openSidebarBtn:active {
            transform: translateY(0) scale(0.95);
        }
        
        /* Bot√≥n toggle dentro del sidebar (CERRAR) */
        .mobile-sidebar-toggle {
            display: none;
            background: transparent;
            border: none;
            padding: 1rem;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            border-top: 1px solid #e2e8f0;
        }
        
        .mobile-sidebar-toggle:hover svg {
            stroke: #2d3748;
        }
        
        .mobile-sidebar-toggle:active {
            transform: scale(0.95);
        }
        
        @media (max-width: 768px) {
            .sidebar { width: 200px; }
            .main-content { margin-left: 200px; }
        }
        
        /* ========================================
           RESPONSIVE DESIGN - MOBILE FIRST
           ======================================== */
        
        /* Mobile: Sidebar colapsable (incluye pantallas plegables cerradas) */
        @media (max-width: 1023px) {
            /* Mostrar bot√≥n ABRIR en m√≥vil */
            #openSidebarBtn {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Esconder bot√≥n ABRIR cuando sidebar est√° abierto */
            .sidebar.open ~ #openSidebarBtn {
                display: none;
            }
            
            .mobile-sidebar-toggle {
                display: block;
            }
            
            .sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                bottom: 0;
                width: 280px;
                max-width: 85vw;
                transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                z-index: 1001;
                box-shadow: 2px 0 20px rgba(0,0,0,0.2);
                background: white;
            }
            
            .sidebar.open {
                left: 0;
            }
            
            .main-content {
                margin-left: 0 !important;
                padding-top: 1rem;
                width: 100% !important;
                min-height: 100vh;
            }
            
            /* Ajustar tama√±o de tarjetas en m√≥vil */
            .page-content {
                padding: 1rem !important;
            }
            
            /* Grid de cursos en 1 columna en m√≥viles peque√±os */
            @media (max-width: 640px) {
                #coursesList {
                    grid-template-columns: 1fr !important;
                }
                
                /* Dashboard stats en 2 columnas */
                .grid.grid-cols-4 {
                    grid-template-columns: repeat(2, 1fr) !important;
                }
            }
            
            /* Grid de cursos en 2 columnas para pantallas medianas (Fold abierto) */
            @media (min-width: 641px) and (max-width: 1023px) {
                #coursesList {
                    grid-template-columns: repeat(2, 1fr) !important;
                }
                
                /* Dashboard stats en 2 columnas */
                .grid.grid-cols-4 {
                    grid-template-columns: repeat(2, 1fr) !important;
                }
            }
            
            /* Calendario m√°s compacto */
            #calendarGrid {
                font-size: 0.75rem;
            }
            
            /* Horario semanal responsive */
            .schedule-grid {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Touch-friendly buttons */
            button, .nav-item, [onclick] {
                min-height: 44px;
                min-width: 44px;
            }
            
            input, textarea, select {
                font-size: 16px !important; /* Evita zoom en iOS */
            }
        }
        
        /* Desktop: TEMPORAL - sidebar colapsable para debugging */
        @media (min-width: 1024px) {
            .sidebar {
                width: 280px;
                position: fixed;
                /* NO forzar left: 0, dejar que la clase .open lo controle */
                z-index: 1001;
            }
            
            /* Asegurar que sidebar empiece oculto tambi√©n en PC */
            .sidebar:not(.open) {
                left: -100%;
            }
            
            /* Mostrar botones en PC para testing */
            #openSidebarBtn {
                display: flex !important;
                align-items: center;
                justify-content: center;
                background: #4299e1;
                color: white;
            }
            
            #openSidebarBtn svg {
                stroke: white;
            }
            
            .mobile-sidebar-toggle {
                display: block !important;
            }
            
            .main-content {
                margin-left: 0;
            }
        }
        
        /* ========================================
           SISTEMA DE TEMAS PERSONALIZABLES
           ======================================== */
        
        :root {
            --color-primary: #3b82f6;
            --color-secondary: #8b5cf6;
            --color-bg: #f9fafb;
            --color-sidebar: #ffffff;
            --color-text: #111827;
            --gradient-enabled: 0;
            --gradient-color1: #3b82f6;
            --gradient-color2: #8b5cf6;
            --gradient-angle: 135deg;
        }
        
        body {
            background: var(--color-bg);
            color: var(--color-text);
        }
        
        body.gradient-enabled {
            background: linear-gradient(
                var(--gradient-angle),
                var(--gradient-color1),
                var(--gradient-color2)
            );
            background-attachment: fixed;
        }
        
        .sidebar {
            background: var(--color-sidebar);
        }
        
        .nav-item.active {
            background: color-mix(in srgb, var(--color-primary) 10%, transparent);
            color: var(--color-primary);
            border-left-color: var(--color-primary);
        }
        
        .bg-blue-500, .bg-purple-500 {
            background-color: var(--color-primary) !important;
        }
        
        .text-blue-500, .text-purple-500 {
            color: var(--color-primary) !important;
        }
        
        .hover\:bg-blue-600:hover {
            background-color: color-mix(in srgb, var(--color-primary) 90%, black) !important;
        }
        
        .theme-preset-btn {
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .theme-preset-btn:hover {
            border-color: var(--color-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .theme-preset-btn:active {
            transform: translateY(0) scale(0.98);
        }
        
        #themePreview {
            transition: all 0.3s ease;
        }
        
        /* ========================================
           PIZARRA DIGITAL STYLES
           ======================================== */
        
        .pizarra-tool {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pizarra-tool:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .pizarra-tool.active {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }
        
        .pizarra-action {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pizarra-action:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        #pizarraCanvas {
            touch-action: none;
        }
    </style>
</head>
<body>
    <!-- Pantalla de Login -->
    <div id="loginScreen" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div style="background: white; padding: 3rem; border-radius: 1.5rem; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center; max-width: 400px; width: 90%;">
            <img src="icon-512.png" alt="Rayan Logo" style="width: 120px; height: 120px; margin: 0 auto 2rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <h1 style="font-size: 2rem; font-weight: bold; color: #1a202c; margin-bottom: 0.5rem;">Rayan</h1>
            <p style="color: #718096; margin-bottom: 2rem;">Gesti√≥n Estudiantil Inteligente</p>
            
            <button onclick="signInWithGoogle()" style="width: 100%; background: white; border: 2px solid #e2e8f0; padding: 1rem; border-radius: 0.75rem; font-size: 1rem; font-weight: 600; color: #2d3748; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continuar con Google
            </button>
            
            <p style="color: #a0aec0; font-size: 0.875rem; margin-top: 1.5rem;">
                Tus datos est√°n seguros y sincronizados en la nube üîí
            </p>
        </div>
    </div>
    
    <!-- Aplicaci√≥n Principal -->
    <div id="mainApp" style="display: none; min-height: 100vh;">
    
    <!-- Bot√≥n para ABRIR sidebar (fuera del sidebar, siempre visible en m√≥vil) -->
    <button id="openSidebarBtn" onclick="openMobileSidebar()" aria-label="Abrir men√∫">
        <svg width="24" height="24" fill="none" stroke="#718096" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
            <line x1="4" y1="12" x2="20" y2="12"></line>
            <line x1="4" y1="6" x2="20" y2="6"></line>
            <line x1="4" y1="18" x2="20" y2="18"></line>
        </svg>
    </button>
    
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center">
                    <i class="fas fa-graduation-cap text-white text-xl"></i>
                </div>
                <div>
                    <div class="font-bold text-lg text-gray-900">Rayan</div>
                    <div class="text-xs text-gray-500">AI-Powered Learning</div>
                </div>
            </div>
        </div>
        
        <nav class="py-4">
            <a class="nav-item active" data-page="dashboard"><i class="fas fa-home"></i>Dashboard</a>
            <a class="nav-item" data-page="tareas"><i class="fas fa-check-square"></i>Tareas</a>
            <a class="nav-item" data-page="integraciones"><i class="fas fa-calendar-week"></i>Horario</a>
            <a class="nav-item" data-page="organizador"><i class="fas fa-magic"></i>Organizador</a>
            <a class="nav-item" data-page="chat"><i class="fas fa-calculator"></i>Calculadora</a>
            <a class="nav-item" data-page="calendario"><i class="fas fa-calendar"></i>Calendario</a>
            <a class="nav-item" data-page="cursos"><i class="fas fa-book"></i>Cursos</a>
            <a class="nav-item" data-page="selectividad"><i class="fas fa-graduation-cap"></i>Selectividad</a>
            <a class="nav-item" data-page="pizarra"><i class="fas fa-chalkboard"></i>Pizarra</a>
            <a class="nav-item" data-page="pizarra-infinita"><i class="fas fa-expand"></i>Pizarra ‚àû</a>
            <a class="nav-item" data-page="compartir"><i class="fas fa-share-alt"></i>Compartir</a>
            <a class="nav-item" data-page="temas"><i class="fas fa-palette"></i>Temas</a>
            <a class="nav-item" data-page="configuracion"><i class="fas fa-cog"></i>Configuraci√≥n</a>
        </nav>
        
        <div class="sidebar-bottom p-4 border-t border-gray-200">
            <!-- Notificaciones PWA -->
            <div class="bg-blue-50 p-4 rounded-xl mb-3">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-bell text-blue-500"></i>
                    <span class="font-semibold text-blue-500 text-sm">Notificaciones</span>
                </div>
                <p class="text-xs text-gray-600 mb-3">Activa las notificaciones para no olvidar tus tareas</p>
                <button onclick="enableNotifications()" class="w-full bg-blue-500 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-blue-600 transition">
                    <i class="fas fa-bell"></i> Activar
                </button>
            </div>
            
            <div class="bg-purple-50 p-4 rounded-xl mb-3">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-magic text-purple-500"></i>
                    <span class="font-semibold text-purple-500 text-sm">Organizador</span>
                </div>
                <p class="text-xs text-gray-600 mb-3">¬øNecesitas ayuda organizando tu estudio?</p>
                <button onclick="navigateTo('organizador')" class="w-full bg-purple-500 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-purple-600 transition">
                    <i class="fas fa-magic"></i> Organizar
                </button>
            </div>
            
            <div class="flex items-center gap-3 p-3 cursor-pointer hover:bg-gray-50 rounded-lg" onclick="signOut()">
                <div class="w-9 h-9 bg-gray-200 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-gray-600"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-medium text-sm truncate" id="userName">Usuario</div>
                    <div class="text-xs text-gray-500">Estudiante</div>
                </div>
            </div>
            
            <!-- Bot√≥n para CERRAR sidebar (dentro del sidebar) -->
            <button onclick="closeMobileSidebar()" class="mobile-sidebar-toggle" aria-label="Cerrar men√∫">
                <svg width="24" height="24" fill="none" stroke="#718096" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard -->
        <div id="page-dashboard" class="page-content p-8">
            <h1 class="text-3xl font-bold mb-2">Dashboard</h1>
            <p class="text-gray-600 mb-8">Resumen de tu progreso acad√©mico</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl p-6 border border-gray-200">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-sm text-gray-600 font-medium">Tareas Pendientes</h3>
                        <i class="fas fa-clock text-gray-400"></i>
                    </div>
                    <p class="text-4xl font-bold mb-1" id="dashPendingCount">0</p>
                    <p class="text-xs" id="dashPendingText">¬°Excelente! No tienes tareas pendientes</p>
                </div>
                <div class="bg-white rounded-xl p-6 border border-gray-200">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-sm text-gray-600 font-medium">Completadas Hoy</h3>
                        <i class="fas fa-check-circle text-gray-400"></i>
                    </div>
                    <p class="text-4xl font-bold mb-1" id="dashCompletedCount">0</p>
                    <p class="text-xs text-gray-600" id="dashCompletedText">A√∫n no has completado tareas hoy</p>
                </div>
                <div class="bg-white rounded-xl p-6 border border-gray-200">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-sm text-gray-600 font-medium">Tareas Vencidas</h3>
                        <i class="fas fa-exclamation-triangle text-gray-400"></i>
                    </div>
                    <p class="text-4xl font-bold text-red-600 mb-1" id="dashOverdueCount">0</p>
                    <p class="text-xs text-gray-600" id="dashOverdueText">Todo al d√≠a</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <div class="flex items-center gap-2 mb-5">
                        <i class="fas fa-exclamation-circle text-yellow-500 text-xl"></i>
                        <h3 class="text-lg font-semibold">Tareas de Alta Prioridad</h3>
                    </div>
                    <p class="text-gray-600 text-sm mb-5">Tareas urgentes que requieren tu atenci√≥n</p>
                    <div id="dashHighPriorityTasks" class="space-y-3">
                        <div class="text-center py-16">
                            <i class="fas fa-check-circle text-6xl text-gray-200 mb-4"></i>
                            <h4 class="text-lg font-semibold mb-2">¬°Excelente!</h4>
                            <p class="text-gray-600">No tienes tareas de alta prioridad pendientes.</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <div class="flex items-center gap-2 mb-5">
                        <i class="fas fa-calendar-alt text-blue-500 text-xl"></i>
                        <h3 class="text-lg font-semibold">Pr√≥ximas Tareas</h3>
                    </div>
                    <p class="text-gray-600 text-sm mb-5">Tareas que vencen en los pr√≥ximos 7 d√≠as</p>
                    <div id="dashUpcomingTasks" class="space-y-3">
                        <div class="text-center py-16">
                            <i class="fas fa-calendar text-6xl text-gray-200 mb-4"></i>
                            <h4 class="text-lg font-semibold mb-2">Sin tareas pr√≥ximas</h4>
                            <p class="text-gray-600">No tienes tareas que venzan en los pr√≥ximos 7 d√≠as.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Widgets Adicionales -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Widget: Pr√≥xima Clase -->
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 border-2 border-blue-200">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="fas fa-clock text-blue-600 text-xl"></i>
                        <h3 class="text-lg font-semibold text-blue-900">Pr√≥xima Clase</h3>
                    </div>
                    <div id="widgetProximaClase">
                        <p class="text-sm text-gray-600">Cargando...</p>
                    </div>
                </div>
                
                <!-- Widget: D√≠as hasta PAU -->
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-6 border-2 border-purple-200">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="fas fa-graduation-cap text-purple-600 text-xl"></i>
                        <h3 class="text-lg font-semibold text-purple-900">D√≠as hasta PAU</h3>
                    </div>
                    <div id="widgetDiasPAU" class="text-center">
                        <p class="text-5xl font-bold text-purple-600" id="widgetDiasNumber">--</p>
                        <p class="text-sm text-gray-600 mt-2">d√≠as restantes</p>
                    </div>
                </div>
                
                <!-- Widget: Progreso Semanal -->
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-6 border-2 border-green-200">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="fas fa-chart-line text-green-600 text-xl"></i>
                        <h3 class="text-lg font-semibold text-green-900">Esta Semana</h3>
                    </div>
                    <div id="widgetProgreso">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-700">Tareas completadas</span>
                            <span class="text-sm font-bold text-green-600" id="widgetTareasCompletadas">0/0</span>
                        </div>
                        <div class="w-full bg-white rounded-full h-3 border border-green-200">
                            <div id="widgetProgresoBar" class="bg-green-500 h-3 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Configuraci√≥n de Notificaciones -->
            <div class="bg-gradient-to-r from-orange-50 to-yellow-50 rounded-xl p-6 border-2 border-orange-200 mb-8">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                    <div>
                        <h3 class="text-lg font-semibold text-orange-900 mb-2">
                            <i class="fas fa-bell text-orange-600 mr-2"></i>
                            Notificaciones Inteligentes
                        </h3>
                        <p class="text-sm text-gray-600">Recibe alertas de clases, tareas y recordatorios</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="configurarNotificaciones()" class="bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600 transition font-medium">
                            <i class="fas fa-cog mr-2"></i>Configurar
                        </button>
                        <button id="testNotifBtn" onclick="enviarNotificacionPrueba()" class="bg-white text-orange-600 px-6 py-3 rounded-lg hover:bg-orange-50 transition font-medium border-2 border-orange-300">
                            <i class="fas fa-paper-plane mr-2"></i>Prueba
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow-sm">
                <h3 class="text-lg font-semibold mb-5">
                    <i class="fas fa-bolt text-yellow-500 mr-2"></i>
                    Acciones R√°pidas
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button onclick="navigateTo('tareas')" class="bg-white border border-gray-300 px-6 py-4 rounded-lg hover:bg-gray-50 transition text-left">
                        <i class="fas fa-plus text-blue-500 mr-2"></i>
                        <span class="font-medium">Nueva Tarea</span>
                    </button>
                    <button onclick="navigateTo('organizador')" class="bg-white border border-gray-300 px-6 py-4 rounded-lg hover:bg-gray-50 transition text-left">
                        <i class="fas fa-magic text-purple-500 mr-2"></i>
                        <span class="font-medium">Organizador</span>
                    </button>
                    <button onclick="navigateTo('calendario')" class="bg-white border border-gray-300 px-6 py-4 rounded-lg hover:bg-gray-50 transition text-left">
                        <i class="fas fa-calendar text-blue-500 mr-2"></i>
                        <span class="font-medium">Ver Calendario</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Tareas -->
        <div id="page-tareas" class="page-content p-8" style="display:none;">
            <h1 class="text-3xl font-bold mb-2">Gesti√≥n de Tareas</h1>
            <p class="text-gray-600 mb-8">Organiza y realiza seguimiento de tus tareas acad√©micas</p>
            
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <input type="text" id="searchTasks" placeholder="Buscar tareas..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" onkeyup="filterTasks()">
                <select id="filterStatus" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" onchange="filterTasks()">
                    <option value="all">Todos los estados</option>
                    <option value="pending">Pendiente</option>
                    <option value="in_progress">En progreso</option>
                    <option value="completed">Completada</option>
                </select>
                <select id="filterPriority" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" onchange="filterTasks()">
                    <option value="all">Todas las prioridades</option>
                    <option value="high">Alta</option>
                    <option value="medium">Media</option>
                    <option value="low">Baja</option>
                </select>
                <button onclick="openTaskModal()" class="bg-blue-500 text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-600 transition whitespace-nowrap">
                    <i class="fas fa-plus mr-2"></i>Nueva Tarea
                </button>
            </div>
            
            <!-- Empty State -->
            <div id="tasksEmptyState" class="bg-white rounded-xl p-8 shadow-sm text-center">
                <i class="fas fa-book-open text-6xl text-gray-200 mb-4"></i>
                <h3 class="text-xl font-semibold mb-2">No hay tareas</h3>
                <p class="text-gray-600 mb-5">Comienza creando tu primera tarea.</p>
                <button onclick="openTaskModal()" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-600 transition">
                    <i class="fas fa-plus mr-2"></i>Crear Primera Tarea
                </button>
            </div>
            
            <!-- Tasks List -->
            <div id="tasksList" class="space-y-4" style="display:none;"></div>
        </div>
        
        
        <!-- P√°gina de Configuraci√≥n -->
        <div id="page-configuracion" class="page-content p-8" style="display:none;">
            <h1 class="text-3xl font-bold mb-2">
                <i class="fas fa-cog text-gray-700"></i> Configuraci√≥n
            </h1>
            <p class="text-gray-600 mb-8">Personaliza la apariencia de toda la aplicaci√≥n</p>
            
            <!-- Fondo de la App -->
            <div class="bg-white rounded-xl p-6 shadow-sm mb-6">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-image text-purple-500"></i>
                    Fondo de la Aplicaci√≥n
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Tipo de fondo -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Fondo</label>
                        <select id="tipoFondo" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cambiarTipoFondo()">
                            <option value="color">Color S√≥lido</option>
                            <option value="gradiente">Degradado</option>
                            <option value="imagen">Imagen</option>
                        </select>
                    </div>
                    
                    <!-- Color s√≥lido -->
                    <div id="configColorSolido">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Color de Fondo</label>
                        <input type="color" id="fondoColor" value="#f9fafb" class="w-16 h-10 rounded cursor-pointer border-2">
                    </div>
                    
                    <!-- Degradado -->
                    <div id="configGradiente" style="display:none;" class="md:col-span-2">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Color 1</label>
                                <input type="color" id="gradienteColor1App" value="#667eea" class="w-16 h-10 rounded cursor-pointer border-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Color 2</label>
                                <input type="color" id="gradienteColor2App" value="#764ba2" class="w-16 h-10 rounded cursor-pointer border-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Direcci√≥n</label>
                                <select id="gradienteDireccion" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    <option value="to bottom">Arriba ‚Üí Abajo</option>
                                    <option value="to right">Izquierda ‚Üí Derecha</option>
                                    <option value="to bottom right">Diagonal ‚Üò</option>
                                    <option value="135deg" selected>Diagonal ‚Üô</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Presets de degradados -->
                        <label class="block text-sm font-medium text-gray-700 mb-2">Degradados Predefinidos</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <button onclick="aplicarGradientePreset('sunset')" class="h-20 rounded-lg" style="background: linear-gradient(135deg, #ff6b6b, #ffa500);"></button>
                            <button onclick="aplicarGradientePreset('ocean')" class="h-20 rounded-lg" style="background: linear-gradient(135deg, #667eea, #764ba2);"></button>
                            <button onclick="aplicarGradientePreset('forest')" class="h-20 rounded-lg" style="background: linear-gradient(135deg, #11998e, #38ef7d);"></button>
                            <button onclick="aplicarGradientePreset('fire')" class="h-20 rounded-lg" style="background: linear-gradient(135deg, #f12711, #f5af19);"></button>
                            <button onclick="aplicarGradientePreset('purple')" class="h-20 rounded-lg" style="background: linear-gradient(135deg, #8e2de2, #4a00e0);"></button>
                            <button onclick="aplicarGradientePreset('pink')" class="h-20 rounded-lg" style="background: linear-gradient(135deg, #ff6a88, #ffc868);"></button>
                            <button onclick="aplicarGradientePreset('blue')" class="h-20 rounded-lg" style="background: linear-gradient(135deg, #4facfe, #00f2fe);"></button>
                            <button onclick="aplicarGradientePreset('green')" class="h-20 rounded-lg" style="background: linear-gradient(135deg, #43e97b, #38f9d7);"></button>
                        </div>
                    </div>
                    
                    <!-- Imagen -->
                    <div id="configImagen" style="display:none;" class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">URL de Imagen</label>
                        <input type="text" id="fondoImagenURL" placeholder="https://ejemplo.com/imagen.jpg" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-2">
                        <p class="text-xs text-gray-500">Usa im√°genes de Unsplash, Pexels, o tu propia URL</p>
                    </div>
                </div>
                
                <!-- Vista Previa -->
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Vista Previa</label>
                    <div id="fondoPreview" class="w-full h-40 rounded-lg border-2 border-gray-300 flex items-center justify-center">
                        <span class="text-gray-600">Vista previa del fondo</span>
                    </div>
                </div>
                
                <!-- Botones -->
                <div class="flex gap-3 mt-6">
                    <button onclick="aplicarFondoConfig()" class="flex-1 bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition font-medium">
                        <i class="fas fa-check mr-2"></i>Aplicar Fondo
                    </button>
                    <button onclick="resetFondoConfig()" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition font-medium">
                        <i class="fas fa-undo mr-2"></i>Resetear
                    </button>
                </div>
            </div>
            
            <!-- Otras configuraciones -->
            <div class="bg-white rounded-xl p-6 shadow-sm">
                <h2 class="text-xl font-bold mb-4">‚öôÔ∏è Otras Opciones</h2>
                <div class="space-y-4">
                    <label class="flex items-center gap-3">
                        <input type="checkbox" id="configAnimaciones" checked class="w-5 h-5">
                        <span>Activar animaciones</span>
                    </label>
                    <label class="flex items-center gap-3">
                        <input type="checkbox" id="configSonidos" class="w-5 h-5">
                        <span>Sonidos de notificaci√≥n</span>
                    </label>
                    <label class="flex items-center gap-3">
                        <input type="checkbox" id="configAutoguardado" checked class="w-5 h-5">
                        <span>Autoguardado autom√°tico</span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Task Modal -->
        <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" style="display:none;">
            <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-2xl font-bold" id="modalTitle">Nueva Tarea</h2>
                    <button onclick="closeTaskModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="p-6">
                    <form id="taskForm" onsubmit="saveTask(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo *</label>
                            <input type="text" id="taskTitle" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Ej: Estudiar para el examen de matem√°ticas">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label>
                            <textarea id="taskDescription" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="A√±ade detalles sobre la tarea..."></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Materia</label>
                                <input type="text" id="taskSubject" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Ej: Matem√°ticas">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de vencimiento *</label>
                                <input type="date" id="taskDueDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prioridad *</label>
                                <select id="taskPriority" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="low">Baja</option>
                                    <option value="medium" selected>Media</option>
                                    <option value="high">Alta</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Estado *</label>
                                <select id="taskStatus" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="pending" selected>Pendiente</option>
                                    <option value="in_progress">En progreso</option>
                                    <option value="completed">Completada</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 justify-end">
                            <button type="button" onclick="closeTaskModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                Cancelar
                            </button>
                            <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">
                                <i class="fas fa-save mr-2"></i>Guardar Tarea
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Integraciones -->
        <div id="page-integraciones" class="page-content p-8" style="display:none;">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                <div>
                    <h1 class="text-3xl font-bold mb-2">
                        <i class="fas fa-calendar-week text-blue-500"></i> Horario Semanal
                    </h1>
                    <p class="text-gray-600">Organiza tus clases y actividades semanales</p>
                </div>
                <button onclick="openScheduleModal()" class="bg-blue-500 text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-600 transition">
                    <i class="fas fa-plus mr-2"></i>A√±adir Clase
                </button>
            </div>
            
            <!-- Vista selector -->
            <div class="flex gap-3 mb-6">
                <button onclick="changeScheduleView('week')" id="viewWeekBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition">
                    <i class="fas fa-calendar-week mr-2"></i>Semana Completa
                </button>
                <button onclick="changeScheduleView('today')" id="viewTodayBtn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition">
                    <i class="fas fa-calendar-day mr-2"></i>Solo Hoy
                </button>
            </div>
            
            <!-- Horario Grid -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div id="scheduleWeekView" class="overflow-x-auto">
                    <table class="w-full min-w-[800px]">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 w-24">Hora</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Lunes</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Martes</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Mi√©rcoles</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Jueves</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Viernes</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleTableBody">
                            <!-- Rows will be generated here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="scheduleTodayView" style="display:none;" class="p-6">
                    <h3 class="text-lg font-semibold mb-4" id="todayDayName">Hoy</h3>
                    <div id="todayScheduleList" class="space-y-3">
                        <!-- Today's classes will appear here -->
                    </div>
                </div>
            </div>
            
            <!-- Empty State -->
            <div id="scheduleEmptyState" class="bg-white rounded-xl p-12 text-center mt-6" style="display:none;">
                <i class="fas fa-calendar-week text-6xl text-gray-200 mb-4"></i>
                <h3 class="text-xl font-semibold mb-2">No tienes clases programadas</h3>
                <p class="text-gray-600 mb-5">Comienza a√±adiendo tus horarios de clases</p>
                <button onclick="openScheduleModal()" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-600 transition">
                    <i class="fas fa-plus mr-2"></i>A√±adir Primera Clase
                </button>
            </div>
        </div>
        
        <!-- Modal A√±adir/Editar Clase -->
        <div id="scheduleModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" style="display:none;">
            <div class="bg-white rounded-xl max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold" id="scheduleModalTitle">A√±adir Clase</h2>
                    <button onclick="closeScheduleModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="scheduleForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Materia/Actividad*</label>
                        <input type="text" id="scheduleSubject" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ej: Matem√°ticas">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">D√≠a de la Semana*</label>
                        <select id="scheduleDay" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">Selecciona un d√≠a</option>
                            <option value="1">Lunes</option>
                            <option value="2">Martes</option>
                            <option value="3">Mi√©rcoles</option>
                            <option value="4">Jueves</option>
                            <option value="5">Viernes</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hora Inicio*</label>
                            <input type="time" id="scheduleStartTime" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hora Fin*</label>
                            <input type="time" id="scheduleEndTime" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Profesor</label>
                        <input type="text" id="scheduleTeacher" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nombre del profesor">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Aula/Lugar</label>
                        <input type="text" id="scheduleRoom" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ej: Aula 201">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Color</label>
                        <div class="grid grid-cols-6 gap-2">
                            <!-- Rojos -->
                            <label class="cursor-pointer" title="Rojo claro">
                                <input type="radio" name="scheduleColor" value="red-light" class="hidden peer">
                                <div class="w-full h-10 bg-red-400 rounded-lg peer-checked:ring-4 peer-checked:ring-red-300 transition"></div>
                            </label>
                            <label class="cursor-pointer" title="Rojo oscuro">
                                <input type="radio" name="scheduleColor" value="red-dark" class="hidden peer">
                                <div class="w-full h-10 bg-red-600 rounded-lg peer-checked:ring-4 peer-checked:ring-red-400 transition"></div>
                            </label>
                            
                            <!-- Azules -->
                            <label class="cursor-pointer" title="Azul claro">
                                <input type="radio" name="scheduleColor" value="blue-light" class="hidden peer" checked>
                                <div class="w-full h-10 bg-blue-400 rounded-lg peer-checked:ring-4 peer-checked:ring-blue-300 transition"></div>
                            </label>
                            <label class="cursor-pointer" title="Azul oscuro">
                                <input type="radio" name="scheduleColor" value="blue-dark" class="hidden peer">
                                <div class="w-full h-10 bg-blue-600 rounded-lg peer-checked:ring-4 peer-checked:ring-blue-400 transition"></div>
                            </label>
                            
                            <!-- Verdes -->
                            <label class="cursor-pointer" title="Verde claro">
                                <input type="radio" name="scheduleColor" value="green-light" class="hidden peer">
                                <div class="w-full h-10 bg-green-400 rounded-lg peer-checked:ring-4 peer-checked:ring-green-300 transition"></div>
                            </label>
                            <label class="cursor-pointer" title="Verde oscuro">
                                <input type="radio" name="scheduleColor" value="green-dark" class="hidden peer">
                                <div class="w-full h-10 bg-green-600 rounded-lg peer-checked:ring-4 peer-checked:ring-green-400 transition"></div>
                            </label>
                            
                            <!-- Amarillos -->
                            <label class="cursor-pointer" title="Amarillo claro">
                                <input type="radio" name="scheduleColor" value="yellow-light" class="hidden peer">
                                <div class="w-full h-10 bg-yellow-300 rounded-lg peer-checked:ring-4 peer-checked:ring-yellow-200 transition"></div>
                            </label>
                            <label class="cursor-pointer" title="Amarillo oscuro">
                                <input type="radio" name="scheduleColor" value="yellow-dark" class="hidden peer">
                                <div class="w-full h-10 bg-yellow-500 rounded-lg peer-checked:ring-4 peer-checked:ring-yellow-300 transition"></div>
                            </label>
                            
                            <!-- Naranjas -->
                            <label class="cursor-pointer" title="Naranja claro">
                                <input type="radio" name="scheduleColor" value="orange-light" class="hidden peer">
                                <div class="w-full h-10 bg-orange-400 rounded-lg peer-checked:ring-4 peer-checked:ring-orange-300 transition"></div>
                            </label>
                            <label class="cursor-pointer" title="Naranja oscuro">
                                <input type="radio" name="scheduleColor" value="orange-dark" class="hidden peer">
                                <div class="w-full h-10 bg-orange-600 rounded-lg peer-checked:ring-4 peer-checked:ring-orange-400 transition"></div>
                            </label>
                            
                            <!-- Grises -->
                            <label class="cursor-pointer" title="Gris claro">
                                <input type="radio" name="scheduleColor" value="gray-light" class="hidden peer">
                                <div class="w-full h-10 bg-gray-400 rounded-lg peer-checked:ring-4 peer-checked:ring-gray-300 transition"></div>
                            </label>
                            <label class="cursor-pointer" title="Gris oscuro">
                                <input type="radio" name="scheduleColor" value="gray-dark" class="hidden peer">
                                <div class="w-full h-10 bg-gray-600 rounded-lg peer-checked:ring-4 peer-checked:ring-gray-400 transition"></div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="saveScheduleItem(event)" class="flex-1 bg-blue-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-600 transition">
                            <i class="fas fa-save mr-2"></i>Guardar
                        </button>
                        <button type="button" onclick="closeScheduleModal()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition">
                            Cancelar
                        </button>
                    </div>
                    
                    <div id="deleteScheduleBtn" style="display:none;" class="pt-4 border-t border-gray-200 mt-4">
                        <button type="button" onclick="deleteScheduleItem(editingScheduleId)" class="w-full bg-red-100 text-red-600 px-6 py-3 rounded-lg font-medium hover:bg-red-200 transition">
                            <i class="fas fa-trash mr-2"></i>Eliminar Clase
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Organizador Inteligente -->
        <div id="page-organizador" class="page-content p-8" style="display:none;">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                <div>
                    <h1 class="text-3xl font-bold mb-2">
                        <i class="fas fa-magic text-purple-500"></i> Organizador Inteligente
                    </h1>
                    <p class="text-gray-600">Escribe m√∫ltiples comandos en lenguaje natural y d√©jame organizarlo todo por ti</p>
                </div>
            </div>
            
            <!-- Examples -->
            <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl p-6 mb-6">
                <h3 class="font-semibold mb-3 flex items-center gap-2">
                    <i class="fas fa-lightbulb text-yellow-500"></i>
                    Ejemplos de comandos:
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <div class="bg-white rounded-lg p-3">
                        <p class="font-medium text-purple-600 mb-1">üìù Crear tareas:</p>
                        <p class="text-gray-700">‚Ä¢ "Crea una tarea de matem√°ticas para ma√±ana"<br>‚Ä¢ "A√±ade tarea urgente: estudiar f√≠sica"</p>
                    </div>
                    <div class="bg-white rounded-lg p-3">
                        <p class="font-medium text-blue-600 mb-1">üìÖ Crear eventos:</p>
                        <p class="text-gray-700">‚Ä¢ "Examen de historia el 15/12/2025"<br>‚Ä¢ "Reuni√≥n de grupo el viernes a las 10am"</p>
                    </div>
                    <div class="bg-white rounded-lg p-3">
                        <p class="font-medium text-green-600 mb-1">üìö Crear cursos:</p>
                        <p class="text-gray-700">‚Ä¢ "Crea un curso de Literatura"<br>‚Ä¢ "A√±ade materia: Qu√≠mica con Prof. Garc√≠a"</p>
                    </div>
                    <div class="bg-white rounded-lg p-3">
                        <p class="font-medium text-orange-600 mb-1">üîî Todo junto:</p>
                        <p class="text-gray-700">‚Ä¢ Escribe m√∫ltiples comandos separados por saltos de l√≠nea o bullets (-, *, ‚Ä¢)</p>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="mb-4 flex flex-wrap gap-2">
                <button onclick="insertarPlantilla('tareas')" class="bg-purple-100 text-purple-700 px-3 py-2 rounded-lg text-sm hover:bg-purple-200 transition">
                    <i class="fas fa-tasks mr-1"></i>Plantilla: Tareas
                </button>
                <button onclick="insertarPlantilla('examenes')" class="bg-blue-100 text-blue-700 px-3 py-2 rounded-lg text-sm hover:bg-blue-200 transition">
                    <i class="fas fa-calendar-check mr-1"></i>Plantilla: Ex√°menes
                </button>
                <button onclick="insertarPlantilla('curso')" class="bg-green-100 text-green-700 px-3 py-2 rounded-lg text-sm hover:bg-green-200 transition">
                    <i class="fas fa-book mr-1"></i>Plantilla: Curso nuevo
                </button>
                <button onclick="limpiarOrganizador()" class="bg-gray-100 text-gray-700 px-3 py-2 rounded-lg text-sm hover:bg-gray-200 transition">
                    <i class="fas fa-eraser mr-1"></i>Limpiar
                </button>
            </div>
            
            <!-- Main Input -->
            <div class="bg-white rounded-xl p-6 shadow-sm mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    <i class="fas fa-pen mr-2"></i>Escribe tus comandos aqu√≠:
                </label>
                <textarea id="organizadorInput" rows="12" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none font-mono text-sm" placeholder="Ejemplo:

- Crear tarea: Estudiar c√°lculo para el viernes, prioridad alta
- Examen de f√≠sica el 20/12/2025 a las 10:00
- A√±adir curso de Programaci√≥n con el profesor L√≥pez
- Tarea urgente para ma√±ana: terminar laboratorio de qu√≠mica

(Puedes usar -, *, ‚Ä¢, o simplemente saltos de l√≠nea)"></textarea>
                
                <div class="flex gap-3 mt-4">
                    <button onclick="procesarComandos()" class="flex-1 bg-gradient-to-r from-purple-500 to-blue-500 text-white px-6 py-3 rounded-lg hover:from-purple-600 hover:to-blue-600 transition font-medium">
                        <i class="fas fa-magic mr-2"></i>Ejecutar Comandos
                    </button>
                </div>
            </div>
            
            <!-- Results -->
            <div id="organizadorResultados" style="display:none;" class="bg-white rounded-xl p-6 shadow-sm">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i class="fas fa-check-circle text-green-500"></i>
                    Resultados de la ejecuci√≥n
                </h3>
                <div id="organizadorResultadosContent" class="space-y-2"></div>
            </div>
        </div>
        
        <!-- Calculadora de Notas -->
        <div id="page-chat" class="page-content p-8" style="display:none;">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                <div>
                    <h1 class="text-3xl font-bold mb-2">
                        <i class="fas fa-calculator text-blue-500"></i> Calculadora de Notas
                    </h1>
                    <p class="text-gray-600">Calcula promedios, notas finales y proyecciones acad√©micas</p>
                </div>
            </div>
            
            <!-- Calculator Type Selector -->
            <div class="bg-white rounded-xl p-6 shadow-sm mb-6">
                <div class="flex flex-wrap gap-3">
                    <button onclick="switchCalculator('promedio')" id="calc-promedio-btn" class="calculator-tab active">
                        <i class="fas fa-chart-line mr-2"></i>Promedio General
                    </button>
                    <button onclick="switchCalculator('ponderado')" id="calc-ponderado-btn" class="calculator-tab">
                        <i class="fas fa-balance-scale mr-2"></i>Promedio Ponderado
                    </button>
                    <button onclick="switchCalculator('proyeccion')" id="calc-proyeccion-btn" class="calculator-tab">
                        <i class="fas fa-bullseye mr-2"></i>Proyecci√≥n Final
                    </button>
                    <button onclick="switchCalculator('necesito')" id="calc-necesito-btn" class="calculator-tab">
                        <i class="fas fa-question-circle mr-2"></i>¬øQu√© necesito?
                    </button>
                </div>
            </div>
            
            <!-- Promedio General -->
            <div id="calc-promedio" class="calculator-section">
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4">Calculadora de Promedio General</h2>
                    <p class="text-gray-600 mb-6">Calcula el promedio simple de todas tus notas</p>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notas (separadas por comas o espacios)</label>
                        <input type="text" id="promedioNotas" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="7.5, 8.0, 6.5, 9.0">
                    </div>
                    
                    <button onclick="calcularPromedio()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">
                        <i class="fas fa-calculator mr-2"></i>Calcular Promedio
                    </button>
                    
                    <div id="resultadoPromedio" class="mt-6" style="display:none;">
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm">Tu promedio es:</p>
                                    <p class="text-4xl font-bold text-blue-600" id="promedioValor">0.0</p>
                                </div>
                                <i class="fas fa-star text-yellow-400 text-5xl"></i>
                            </div>
                            <div class="mt-4 grid grid-cols-3 gap-4 text-center">
                                <div>
                                    <p class="text-2xl font-semibold" id="totalNotas">0</p>
                                    <p class="text-xs text-gray-600">Notas ingresadas</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-semibold" id="notaMasAlta">0.0</p>
                                    <p class="text-xs text-gray-600">Nota m√°s alta</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-semibold" id="notaMasBaja">0.0</p>
                                    <p class="text-xs text-gray-600">Nota m√°s baja</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Promedio Ponderado -->
            <div id="calc-ponderado" class="calculator-section" style="display:none;">
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4">Calculadora de Promedio Ponderado con Grupos</h2>
                    <p class="text-gray-600 mb-6">Organiza tus notas en grupos (ex√°menes, tareas, etc.) cada uno con su propio peso</p>
                    
                    <div id="ponderadoGrupos" class="space-y-4 mb-4">
                        <!-- Grupos se a√±adir√°n aqu√≠ -->
                    </div>
                    
                    <div class="flex gap-3 mb-4">
                        <button onclick="agregarGrupoPonderado()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">
                            <i class="fas fa-folder-plus mr-2"></i>Agregar Grupo
                        </button>
                        <button onclick="calcularPonderado()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">
                            <i class="fas fa-calculator mr-2"></i>Calcular
                        </button>
                        <button onclick="limpiarPonderado()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
                            <i class="fas fa-trash mr-2"></i>Limpiar
                        </button>
                    </div>
                    
                    <div id="resultadoPonderado" class="mt-6" style="display:none;">
                        <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p class="text-gray-600 text-sm">Promedio Ponderado Final:</p>
                                    <p class="text-4xl font-bold text-green-600" id="ponderadoValor">0.0</p>
                                </div>
                                <i class="fas fa-balance-scale text-green-400 text-5xl"></i>
                            </div>
                            <div id="ponderadoDetalles" class="space-y-2 text-sm"></div>
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <p class="text-sm text-gray-600">Peso total: <span id="pesoTotal" class="font-semibold">0%</span></p>
                                <p class="text-xs text-gray-500 mt-1" id="pesoWarning"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Proyecci√≥n Final -->
            <div id="calc-proyeccion" class="calculator-section" style="display:none;">
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4">Proyecci√≥n de Nota Final</h2>
                    <p class="text-gray-600 mb-6">Proyecta tu nota final del curso considerando lo que te falta</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nota actual</label>
                            <input type="number" step="0.1" id="proyeccionActual" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="7.5">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Peso de lo completado (%)</label>
                            <input type="number" step="1" id="proyeccionPesoActual" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="60">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nota estimada en lo que falta</label>
                            <input type="number" step="0.1" id="proyeccionFuturo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="8.0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Peso de lo que falta (%)</label>
                            <input type="number" step="1" id="proyeccionPesoFuturo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="40">
                        </div>
                    </div>
                    
                    <button onclick="calcularProyeccion()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">
                        <i class="fas fa-chart-line mr-2"></i>Calcular Proyecci√≥n
                    </button>
                    
                    <div id="resultadoProyeccion" class="mt-6" style="display:none;">
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p class="text-gray-600 text-sm">Nota final proyectada:</p>
                                    <p class="text-4xl font-bold text-purple-600" id="proyeccionValor">0.0</p>
                                </div>
                                <i class="fas fa-chart-line text-purple-400 text-5xl"></i>
                            </div>
                            <div id="proyeccionConsejos" class="text-sm text-gray-700"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ¬øQu√© necesito? -->
            <div id="calc-necesito" class="calculator-section" style="display:none;">
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4">¬øQu√© nota necesito sacar?</h2>
                    <p class="text-gray-600 mb-6">Calcula qu√© nota necesitas en el examen/tarea final para alcanzar tu objetivo</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nota actual</label>
                            <input type="number" step="0.1" id="necesitoActual" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="6.5">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Peso de lo completado (%)</label>
                            <input type="number" step="1" id="necesitoPesoActual" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="70">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nota objetivo final</label>
                            <input type="number" step="0.1" id="necesitoObjetivo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="7.0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Peso de lo que falta (%)</label>
                            <input type="number" step="1" id="necesitoPesoFaltante" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="30">
                        </div>
                    </div>
                    
                    <button onclick="calcularNecesito()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">
                        <i class="fas fa-bullseye mr-2"></i>Calcular
                    </button>
                    
                    <div id="resultadoNecesito" class="mt-6" style="display:none;">
                        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p class="text-gray-600 text-sm">Necesitas sacar:</p>
                                    <p class="text-4xl font-bold text-orange-600" id="necesitoValor">0.0</p>
                                </div>
                                <i class="fas fa-bullseye text-orange-400 text-5xl"></i>
                            </div>
                            <div id="necesitoAnalisis" class="text-sm text-gray-700"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Calendario -->
        <div id="page-calendario" class="page-content p-8" style="display:none;">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                <h1 class="text-3xl font-bold">Calendario</h1>
                <button onclick="openEventModal()" class="bg-blue-500 text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-600 transition">
                    <i class="fas fa-plus mr-2"></i>Nuevo Evento
                </button>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow-sm">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                    <button onclick="changeMonth(-1)" class="bg-white border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-50 transition">
                        <i class="fas fa-chevron-left mr-2"></i>Anterior
                    </button>
                    <h2 class="text-xl font-semibold" id="currentMonthYear">Noviembre 2025</h2>
                    <button onclick="changeMonth(1)" class="bg-white border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-50 transition">
                        Siguiente<i class="fas fa-chevron-right ml-2"></i>
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <div class="min-w-[600px]">
                        <div class="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200">
                            <div class="bg-gray-50 p-3 text-center font-semibold text-sm">Dom</div>
                            <div class="bg-gray-50 p-3 text-center font-semibold text-sm">Lun</div>
                            <div class="bg-gray-50 p-3 text-center font-semibold text-sm">Mar</div>
                            <div class="bg-gray-50 p-3 text-center font-semibold text-sm">Mi√©</div>
                            <div class="bg-gray-50 p-3 text-center font-semibold text-sm">Jue</div>
                            <div class="bg-gray-50 p-3 text-center font-semibold text-sm">Vie</div>
                            <div class="bg-gray-50 p-3 text-center font-semibold text-sm">S√°b</div>
                        </div>
                        
                        <div id="calendarGrid" class="grid grid-cols-7 gap-px bg-gray-200"></div>
                    </div>
                </div>
                
                <div class="mt-8 pt-8 border-t border-gray-200">
                    <h3 class="text-lg font-semibold mb-4">Pr√≥ximos Eventos</h3>
                    <div id="upcomingEventsList"></div>
                </div>
            </div>
        </div>
        
        <!-- Event Modal -->
        <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" style="display:none;">
            <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-2xl font-bold" id="eventModalTitle">Nuevo Evento</h2>
                    <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="p-6">
                    <form id="eventForm" onsubmit="saveEvent(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo del evento *</label>
                            <input type="text" id="eventTitle" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Ej: Reuni√≥n de estudio">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label>
                            <textarea id="eventDescription" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Detalles del evento..."></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Fecha *</label>
                                <input type="date" id="eventDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Hora</label>
                                <input type="time" id="eventTime" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <select id="eventType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="event">Evento</option>
                                    <option value="class">Clase</option>
                                    <option value="exam">Examen</option>
                                    <option value="study">Sesi√≥n de estudio</option>
                                    <option value="deadline">Fecha l√≠mite</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Color</label>
                                <select id="eventColor" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="blue">Azul</option>
                                    <option value="green">Verde</option>
                                    <option value="red">Rojo</option>
                                    <option value="yellow">Amarillo</option>
                                    <option value="purple">Morado</option>
                                    <option value="pink">Rosa</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 justify-end">
                            <button type="button" onclick="closeEventModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                Cancelar
                            </button>
                            <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">
                                <i class="fas fa-save mr-2"></i>Guardar Evento
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Cursos -->
        <div id="page-cursos" class="page-content p-8" style="display:none;">
            <!-- Courses List View -->
            <div id="coursesListView">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                    <div>
                        <h1 class="text-3xl font-bold">Mis Cursos</h1>
                        <p class="text-gray-600 mt-1">Organiza tus materias y materiales de estudio</p>
                    </div>
                    <button onclick="openCourseModal()" class="bg-blue-500 text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-600 transition">
                        <i class="fas fa-plus mr-2"></i>Nuevo Curso
                    </button>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 border border-gray-200">
                        <p class="text-4xl font-bold text-blue-500 mb-1" id="totalCoursesCount">0</p>
                        <p class="text-sm text-gray-600">Cursos Activos</p>
                    </div>
                    <div class="bg-white rounded-xl p-6 border border-gray-200">
                        <p class="text-4xl font-bold text-green-500 mb-1" id="totalMaterialsCount">0</p>
                        <p class="text-sm text-gray-600">Total Materiales</p>
                    </div>
                    <div class="bg-white rounded-xl p-6 border border-gray-200">
                        <p class="text-4xl font-bold text-purple-500 mb-1" id="totalCreditsCount">0</p>
                        <p class="text-sm text-gray-600">Cr√©ditos Totales</p>
                    </div>
                    <div class="bg-white rounded-xl p-6 border border-gray-200">
                        <p class="text-4xl font-bold text-yellow-500 mb-1" id="uploadedTodayCount">0</p>
                        <p class="text-sm text-gray-600">Subidos Hoy</p>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div id="coursesEmptyState" class="bg-white rounded-xl p-8 shadow-sm text-center">
                    <i class="fas fa-book text-6xl text-gray-200 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2">No tienes cursos registrados</h3>
                    <p class="text-gray-600 mb-5">Comienza creando tu primer curso para organizar tus materiales</p>
                    <button onclick="openCourseModal()" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-600 transition">
                        <i class="fas fa-plus mr-2"></i>Crear Primer Curso
                    </button>
                </div>
                
                <!-- Courses Grid -->
                <div id="coursesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
            
            <!-- Course Detail View -->
            <div id="courseDetailView" style="display:none;">
                <div class="mb-6">
                    <button onclick="backToCoursesListd()" class="text-blue-500 hover:text-blue-600 mb-4">
                        <i class="fas fa-arrow-left mr-2"></i>Volver a Cursos
                    </button>
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h1 class="text-3xl font-bold" id="courseDetailName">Nombre del Curso</h1>
                            <p class="text-gray-600 mt-1" id="courseDetailInfo">Informaci√≥n del curso</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="openMaterialModal()" class="bg-blue-500 text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-600 transition">
                                <i class="fas fa-upload mr-2"></i>Subir Material
                            </button>
                            <button onclick="editCurrentCourse()" class="bg-white border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-50 transition">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Materials Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-lg p-4 border border-gray-200">
                        <p class="text-2xl font-bold text-blue-500" id="courseMaterialsCount">0</p>
                        <p class="text-xs text-gray-600">Materiales</p>
                    </div>
                    <div class="bg-white rounded-lg p-4 border border-gray-200">
                        <p class="text-2xl font-bold text-green-500" id="coursePDFCount">0</p>
                        <p class="text-xs text-gray-600">PDFs</p>
                    </div>
                    <div class="bg-white rounded-lg p-4 border border-gray-200">
                        <p class="text-2xl font-bold text-purple-500" id="courseImagesCount">0</p>
                        <p class="text-xs text-gray-600">Im√°genes</p>
                    </div>
                    <div class="bg-white rounded-lg p-4 border border-gray-200">
                        <p class="text-2xl font-bold text-yellow-500" id="courseVideosCount">0</p>
                        <p class="text-xs text-gray-600">Videos</p>
                    </div>
                </div>
                
                <!-- Search and Filters -->
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <input type="text" id="searchMaterials" placeholder="Buscar materiales..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" onkeyup="filterMaterials()">
                    <select id="filterMaterialType" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" onchange="filterMaterials()">
                        <option value="all">Todos los tipos</option>
                        <option value="pdf">PDF</option>
                        <option value="image">Imagen</option>
                        <option value="video">Video</option>
                        <option value="link">Enlace</option>
                        <option value="document">Documento</option>
                        <option value="other">Otro</option>
                    </select>
                </div>
                
                <!-- Materials List -->
                <div id="materialsEmptyState" class="bg-white rounded-xl p-8 shadow-sm text-center">
                    <i class="fas fa-folder-open text-6xl text-gray-200 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2">No hay materiales en este curso</h3>
                    <p class="text-gray-600 mb-5">Sube tu primer material para comenzar</p>
                    <button onclick="openMaterialModal()" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-600 transition">
                        <i class="fas fa-upload mr-2"></i>Subir Material
                    </button>
                </div>
                
                <div id="materialsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" style="display:none;"></div>
            </div>
        </div>
        
        <!-- Course Modal -->
        <div id="courseModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" style="display:none;">
            <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-2xl font-bold" id="courseModalTitle">Nuevo Curso</h2>
                    <button onclick="closeCourseModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="p-6">
                    <form id="courseForm" onsubmit="saveCourse(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del curso *</label>
                            <input type="text" id="courseName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Ej: Matem√°ticas Avanzadas">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">C√≥digo del curso</label>
                            <input type="text" id="courseCode" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Ej: MAT-301">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label>
                            <textarea id="courseDescription" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Descripci√≥n del curso..."></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Profesor</label>
                                <input type="text" id="courseTeacher" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Nombre del profesor">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cr√©ditos</label>
                                <input type="number" id="courseCredits" min="0" step="0.5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="3">
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Color</label>
                            <select id="courseColor" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="blue">Azul</option>
                                <option value="green">Verde</option>
                                <option value="red">Rojo</option>
                                <option value="yellow">Amarillo</option>
                                <option value="purple">Morado</option>
                                <option value="pink">Rosa</option>
                            </select>
                        </div>
                        
                        <div class="flex gap-3 justify-end">
                            <button type="button" onclick="closeCourseModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                Cancelar
                            </button>
                            <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">
                                <i class="fas fa-save mr-2"></i>Guardar Curso
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Material Modal -->
        <div id="materialModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" style="display:none;">
            <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Subir Material</h2>
                    <button onclick="closeMaterialModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="p-6">
                    <form id="materialForm" onsubmit="saveMaterial(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo *</label>
                            <input type="text" id="materialTitle" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Ej: Apuntes Clase 1">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label>
                            <textarea id="materialDescription" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Descripci√≥n del material..."></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de material *</label>
                            <select id="materialType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" onchange="toggleMaterialInput()">
                                <option value="file">Subir archivo</option>
                                <option value="link">Enlace web</option>
                            </select>
                        </div>
                        
                        <!-- File Upload -->
                        <div id="fileUploadSection" class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar archivo *</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition cursor-pointer" onclick="document.getElementById('materialFile').click()">
                                <input type="file" id="materialFile" class="hidden" onchange="handleFileSelect(event)" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.mp4,.mp3">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                                <p class="text-gray-600 mb-1">Haz clic para seleccionar un archivo</p>
                                <p class="text-xs text-gray-500">PDF, DOC, TXT, Im√°genes, Videos (m√°x. 10MB)</p>
                            </div>
                            <div id="filePreview" class="mt-3" style="display:none;">
                                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                    <i id="fileIcon" class="fas fa-file text-2xl text-blue-500"></i>
                                    <div class="flex-1 min-w-0">
                                        <p id="fileName" class="font-medium text-gray-900 truncate"></p>
                                        <p id="fileSize" class="text-xs text-gray-500"></p>
                                    </div>
                                    <button type="button" onclick="clearFileSelection()" class="text-red-500 hover:text-red-600">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Link Input -->
                        <div id="linkInputSection" class="mb-4" style="display:none;">
                            <label class="block text-sm font-medium text-gray-700 mb-2">URL del enlace *</label>
                            <input type="url" id="materialLink" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="https://ejemplo.com/documento">
                        </div>
                        
                        <div class="flex gap-3 justify-end">
                            <button type="button" onclick="closeMaterialModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                Cancelar
                            </button>
                            <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">
                                <i class="fas fa-save mr-2"></i>Guardar Material
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        
        <!-- P√°gina de Selectividad/PAU -->
        <div id="page-selectividad" class="page-content p-8" style="display:none;">
            <h1 class="text-3xl font-bold mb-2">
                <i class="fas fa-graduation-cap text-blue-600"></i> Centro de Selectividad 2025
            </h1>
            <p class="text-gray-600 mb-8">Todo lo que necesitas para preparar la PAU</p>
            
            <!-- Contador de d√≠as -->
            <div class="bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl p-8 mb-6 text-white shadow-lg">
                <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                    <div class="flex-1 text-center md:text-left">
                        <h2 class="text-2xl font-bold mb-2">‚è∞ Cuenta Regresiva PAU 2025</h2>
                        <p class="text-blue-100 mb-4">Prepar√°ndote para tu futuro</p>
                        <div class="flex gap-4 justify-center md:justify-start flex-wrap">
                            <div class="bg-white/20 backdrop-blur-sm rounded-lg p-4 min-w-[100px]">
                                <div class="text-4xl font-bold" id="diasRestantes">--</div>
                                <div class="text-sm text-blue-100 mt-1">d√≠as</div>
                            </div>
                            <div class="bg-white/20 backdrop-blur-sm rounded-lg p-4 min-w-[100px]">
                                <div class="text-4xl font-bold" id="horasRestantes">--</div>
                                <div class="text-sm text-blue-100 mt-1">horas</div>
                            </div>
                            <div class="bg-white/20 backdrop-blur-sm rounded-lg p-4 min-w-[100px]">
                                <div class="text-4xl font-bold" id="minutosRestantes">--</div>
                                <div class="text-sm text-blue-100 mt-1">minutos</div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <button onclick="abrirConfigFechaPAU()" class="bg-white text-blue-600 px-6 py-3 rounded-lg font-medium hover:bg-blue-50 transition">
                            <i class="fas fa-calendar-alt mr-2"></i>Configurar Fecha
                        </button>
                        <p class="text-sm text-blue-100 mt-2">Fecha actual: <span id="fechaPAUDisplay">5-6 Junio 2025</span></p>
                    </div>
                </div>
            </div>
            
            <!-- Grid de secciones -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Calculadora PAU -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <i class="fas fa-calculator text-green-500"></i>
                        Calculadora de Nota PAU
                    </h2>
                    <p class="text-sm text-gray-600 mb-4">Calcula tu nota de acceso a la universidad</p>
                    
                    <div class="space-y-4">
                        <!-- Nota de Bachillerato -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Nota media de Bachillerato (40%)
                            </label>
                            <input type="number" id="notaBach" step="0.01" min="0" max="10" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg" 
                                   placeholder="Ej: 8.5" onchange="calcularNotaPAU()">
                        </div>
                        
                        <!-- Fase General -->
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-2">Fase General (60%)</h3>
                            <div class="space-y-2">
                                <input type="number" id="notaLengua" step="0.01" min="0" max="10" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" 
                                       placeholder="Lengua" onchange="calcularNotaPAU()">
                                <input type="number" id="notaHistoria" step="0.01" min="0" max="10" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" 
                                       placeholder="Historia de Espa√±a" onchange="calcularNotaPAU()">
                                <input type="number" id="notaIngles" step="0.01" min="0" max="10" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" 
                                       placeholder="Lengua Extranjera (Ingl√©s)" onchange="calcularNotaPAU()">
                                <input type="number" id="notaModalidad" step="0.01" min="0" max="10" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" 
                                       placeholder="Materia de Modalidad" onchange="calcularNotaPAU()">
                            </div>
                        </div>
                        
                        <!-- Resultado -->
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-lg border-2 border-green-200">
                            <div class="flex justify-between items-center">
                                <span class="font-semibold text-gray-700">Nota de Acceso:</span>
                                <span class="text-3xl font-bold text-green-600" id="notaAcceso">--</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-2">Nota m√≠nima: 5.0 para acceso a universidad</p>
                        </div>
                    </div>
                </div>
                
                <!-- Fase Espec√≠fica -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <i class="fas fa-star text-yellow-500"></i>
                        Fase Espec√≠fica (Subir Nota)
                    </h2>
                    <p class="text-sm text-gray-600 mb-4">A√±ade hasta 4 asignaturas ponderadas</p>
                    
                    <div class="space-y-3">
                        <div class="flex gap-2">
                            <input type="number" id="especifica1" step="0.01" min="0" max="10" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" 
                                   placeholder="Asignatura 1" onchange="calcularNotaAdmision()">
                            <select id="ponderacion1" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="calcularNotaAdmision()">
                                <option value="0">0.1</option>
                                <option value="0.2" selected>0.2</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <input type="number" id="especifica2" step="0.01" min="0" max="10" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" 
                                   placeholder="Asignatura 2" onchange="calcularNotaAdmision()">
                            <select id="ponderacion2" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="calcularNotaAdmision()">
                                <option value="0">0.1</option>
                                <option value="0.2" selected>0.2</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <input type="number" id="especifica3" step="0.01" min="0" max="10" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" 
                                   placeholder="Asignatura 3" onchange="calcularNotaAdmision()">
                            <select id="ponderacion3" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="calcularNotaAdmision()">
                                <option value="0">0.1</option>
                                <option value="0.2" selected>0.2</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <input type="number" id="especifica4" step="0.01" min="0" max="10" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" 
                                   placeholder="Asignatura 4" onchange="calcularNotaAdmision()">
                            <select id="ponderacion4" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="calcularNotaAdmision()">
                                <option value="0">0.1</option>
                                <option value="0.2" selected>0.2</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Nota de Admisi√≥n -->
                    <div class="bg-gradient-to-br from-purple-50 to-indigo-50 p-4 rounded-lg border-2 border-purple-200 mt-4">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-gray-700">Nota de Admisi√≥n:</span>
                            <span class="text-3xl font-bold text-purple-600" id="notaAdmision">--</span>
                        </div>
                        <p class="text-xs text-gray-600 mt-2">Nota m√°xima: 14.0 (con fase espec√≠fica)</p>
                    </div>
                </div>
            </div>
            
            <!-- Simulador de Admisi√≥n -->
            <div class="bg-white rounded-xl p-6 shadow-sm mb-6">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-university text-blue-500"></i>
                    Simulador de Admisi√≥n
                </h2>
                <p class="text-sm text-gray-600 mb-4">Compara tu nota con las notas de corte 2024</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Universidad</label>
                        <select id="universidadSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarGrados()">
                            <option value="">Selecciona universidad...</option>
                            <option value="ucm">Universidad Complutense de Madrid (UCM)</option>
                            <option value="uam">Universidad Aut√≥noma de Madrid (UAM)</option>
                            <option value="upm">Universidad Polit√©cnica de Madrid (UPM)</option>
                            <option value="uc3m">Universidad Carlos III (UC3M)</option>
                            <option value="urjc">Universidad Rey Juan Carlos (URJC)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Grado</label>
                        <select id="gradoSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="mostrarNotaCorte()">
                            <option value="">Primero selecciona universidad...</option>
                        </select>
                    </div>
                </div>
                
                <div id="resultadoSimulador" style="display:none;" class="bg-gray-50 p-4 rounded-lg">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h3 class="font-bold text-lg" id="nombreGrado">--</h3>
                            <p class="text-sm text-gray-600" id="nombreUniversidad">--</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">Nota de corte 2024</p>
                            <p class="text-2xl font-bold text-blue-600" id="notaCorte">--</p>
                        </div>
                    </div>
                    <div id="probabilidadEntrada" class="text-center py-4"></div>
                </div>
            </div>
            
            <!-- Grid para Tracking y Checklist -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Tracking de Progreso -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <i class="fas fa-tasks text-orange-500"></i>
                        Progreso de Estudio
                    </h2>
                    <p class="text-sm text-gray-600 mb-4">Marca los temas que has estudiado</p>
                    
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-sm">Matem√°ticas II</span>
                                <span class="text-sm text-gray-600"><span id="progMates">0</span>/14 temas</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="barMates" class="bg-blue-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-sm">F√≠sica</span>
                                <span class="text-sm text-gray-600"><span id="progFisica">0</span>/12 temas</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="barFisica" class="bg-green-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-sm">Historia de Espa√±a</span>
                                <span class="text-sm text-gray-600"><span id="progHistoria">0</span>/16 temas</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="barHistoria" class="bg-purple-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-sm">Lengua</span>
                                <span class="text-sm text-gray-600"><span id="progLengua">0</span>/10 temas</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="barLengua" class="bg-red-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-sm">Ingl√©s</span>
                                <span class="text-sm text-gray-600"><span id="progIngles">0</span>/8 temas</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="barIngles" class="bg-yellow-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="abrirGestionProgreso()" class="w-full mt-4 bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition">
                        <i class="fas fa-edit mr-2"></i>Gestionar Progreso
                    </button>
                </div>
                
                <!-- Checklist Pre-Examen -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <i class="fas fa-clipboard-check text-green-500"></i>
                        Checklist D√≠a del Examen
                    </h2>
                    <p class="text-sm text-gray-600 mb-4">Aseg√∫rate de tener todo preparado</p>
                    
                    <div class="space-y-2">
                        <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="check1" class="w-5 h-5 text-blue-500" onchange="guardarChecklist()">
                            <span class="text-sm">üìã DNI/NIE original</span>
                        </label>
                        <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="check2" class="w-5 h-5 text-blue-500" onchange="guardarChecklist()">
                            <span class="text-sm">‚úçÔ∏è Bol√≠grafos negros o azules (varios)</span>
                        </label>
                        <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="check3" class="w-5 h-5 text-blue-500" onchange="guardarChecklist()">
                            <span class="text-sm">üßÆ Calculadora cient√≠fica (sin wifi)</span>
                        </label>
                        <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="check4" class="w-5 h-5 text-blue-500" onchange="guardarChecklist()">
                            <span class="text-sm">üíß Botella de agua</span>
                        </label>
                        <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="check5" class="w-5 h-5 text-blue-500" onchange="guardarChecklist()">
                            <span class="text-sm">‚åö Reloj (sin conexi√≥n)</span>
                        </label>
                        <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="check6" class="w-5 h-5 text-blue-500" onchange="guardarChecklist()">
                            <span class="text-sm">üç´ Snack ligero</span>
                        </label>
                        <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="check7" class="w-5 h-5 text-blue-500" onchange="guardarChecklist()">
                            <span class="text-sm">üì± M√≥vil apagado (dejar en casa si es posible)</span>
                        </label>
                        <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="check8" class="w-5 h-5 text-blue-500" onchange="guardarChecklist()">
                            <span class="text-sm">üó∫Ô∏è Ubicaci√≥n del centro de examen revisada</span>
                        </label>
                    </div>
                    
                    <div class="mt-4 p-3 bg-green-50 rounded-lg text-center">
                        <span class="text-sm font-medium text-green-700">
                            <span id="checklistCompletados">0</span>/8 completados
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Tips y Consejos -->
            <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl p-6 border-2 border-indigo-200">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-lightbulb text-yellow-500"></i>
                    Tips para la Selectividad
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-lg">
                        <h3 class="font-semibold text-sm mb-2">‚è∞ Gesti√≥n del Tiempo</h3>
                        <p class="text-xs text-gray-600">Lee todas las preguntas antes de empezar. Distribuye el tiempo seg√∫n el valor de cada pregunta.</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg">
                        <h3 class="font-semibold text-sm mb-2">üìñ Lee Bien las Preguntas</h3>
                        <p class="text-xs text-gray-600">Aseg√∫rate de entender exactamente qu√© se pide. Subraya palabras clave.</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg">
                        <h3 class="font-semibold text-sm mb-2">‚úçÔ∏è Estructura tus Respuestas</h3>
                        <p class="text-xs text-gray-600">Introduce, desarrolla y concluye. La presentaci√≥n cuenta.</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg">
                        <h3 class="font-semibold text-sm mb-2">üßò Mant√©n la Calma</h3>
                        <p class="text-xs text-gray-600">Si te bloqueas, pasa a otra pregunta. Respira hondo y vuelve despu√©s.</p>
                    </div>
                </div>
            </div>
        </div>
            
        
        <!-- P√°gina de Pizarra Digital -->
        <div id="page-pizarra" class="page-content p-8" style="display:none;">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                <div>
                    <h1 class="text-3xl font-bold mb-2">
                        <i class="fas fa-chalkboard text-green-600"></i> Pizarra Digital
                    </h1>
                    <p class="text-gray-600">Dibuja, resuelve problemas y crea esquemas</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="guardarPizarra()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                        <i class="fas fa-save mr-2"></i>Guardar
                    </button>
                    <button onclick="cargarPizarra()" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition">
                        <i class="fas fa-folder-open mr-2"></i>Cargar
                    </button>
                    <button onclick="exportarPizarra()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">
                        <i class="fas fa-download mr-2"></i>Exportar
                    </button>
                </div>
            </div>
            
            <!-- Toolbar -->
            <div class="bg-white rounded-xl p-4 shadow-sm mb-4">
                <div class="flex flex-wrap items-center gap-3">
                    <!-- Herramientas de dibujo -->
                    <div class="flex gap-2">
                        <button onclick="cambiarHerramienta('pencil')" id="tool-pencil" class="pizarra-tool active">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button onclick="cambiarHerramienta('marker')" id="tool-marker" class="pizarra-tool">
                            <i class="fas fa-highlighter"></i>
                        </button>
                        <button onclick="cambiarHerramienta('eraser')" id="tool-eraser" class="pizarra-tool">
                            <i class="fas fa-eraser"></i>
                        </button>
                    </div>
                    
                    <div class="w-px h-8 bg-gray-300"></div>
                    
                    <!-- Formas -->
                    <div class="flex gap-2">
                        <button onclick="cambiarHerramienta('line')" id="tool-line" class="pizarra-tool">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button onclick="cambiarHerramienta('circle')" id="tool-circle" class="pizarra-tool">
                            <i class="fas fa-circle"></i>
                        </button>
                        <button onclick="cambiarHerramienta('square')" id="tool-square" class="pizarra-tool">
                            <i class="fas fa-square"></i>
                        </button>
                    </div>
                    
                    <div class="w-px h-8 bg-gray-300"></div>
                    
                    <!-- Grosor -->
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium text-gray-700">Grosor:</label>
                        <input type="range" id="brushSize" min="1" max="50" value="3" class="w-24" oninput="actualizarGrosor()">
                        <span id="brushSizeValue" class="text-sm text-gray-600 w-8">3px</span>
                    </div>
                    
                    <div class="w-px h-8 bg-gray-300"></div>
                    
                    <!-- Color -->
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium text-gray-700">Color:</label>
                        <input type="color" id="brushColor" value="#000000" class="w-12 h-10 rounded cursor-pointer border-2 border-gray-300">
                        <div class="flex gap-1">
                            <button onclick="cambiarColorRapido('#000000')" class="w-6 h-6 rounded-full border-2 border-gray-300 bg-black"></button>
                            <button onclick="cambiarColorRapido('#ef4444')" class="w-6 h-6 rounded-full border-2 border-gray-300 bg-red-500"></button>
                            <button onclick="cambiarColorRapido('#3b82f6')" class="w-6 h-6 rounded-full border-2 border-gray-300 bg-blue-500"></button>
                            <button onclick="cambiarColorRapido('#10b981')" class="w-6 h-6 rounded-full border-2 border-gray-300 bg-green-500"></button>
                            <button onclick="cambiarColorRapido('#f59e0b')" class="w-6 h-6 rounded-full border-2 border-gray-300 bg-yellow-500"></button>
                        </div>
                    </div>
                    
                    <div class="w-px h-8 bg-gray-300"></div>
                    
                    <!-- Acciones -->
                    <div class="flex gap-2">
                        <button onclick="deshacerPizarra()" class="pizarra-action" title="Deshacer">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button onclick="rehacerPizarra()" class="pizarra-action" title="Rehacer">
                            <i class="fas fa-redo"></i>
                        </button>
                        <button onclick="limpiarPizarra()" class="pizarra-action text-red-500" title="Limpiar todo">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Canvas -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="relative" style="height: 600px;">
                    <canvas id="pizarraCanvas" class="border border-gray-200 cursor-crosshair" style="width: 100%; height: 100%;"></canvas>
                </div>
            </div>
            
            <!-- Pizarras guardadas -->
            <div class="mt-6 bg-white rounded-xl p-6 shadow-sm">
                <h2 class="text-xl font-bold mb-4">üìÅ Pizarras Guardadas</h2>
                <div id="pizarrasGuardadas" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-folder-open text-4xl mb-2"></i>
                        <p>No hay pizarras guardadas</p>
                    </div>
                </div>
            </div>
        </div>
        
        
        
        <!-- Pizarra Infinita (tipo Microsoft Whiteboard) -->
        <div id="page-pizarra-infinita" class="page-content" style="display:none; padding: 0; height: 100vh; overflow: hidden;">
            <div style="position: fixed; top: 0; left: 256px; right: 0; height: 60px; background: white; border-bottom: 2px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100;">
                <h1 class="text-xl font-bold">
                    <i class="fas fa-expand text-blue-600"></i> Pizarra Infinita
                </h1>
                <div class="flex gap-3 items-center">
                    <!-- Herramientas -->
                    <button onclick="cambiarHerramientaInfinita('pencil')" id="inf-tool-pencil" class="pizarra-tool active">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                    <button onclick="cambiarHerramientaInfinita('eraser')" id="inf-tool-eraser" class="pizarra-tool">
                        <i class="fas fa-eraser"></i>
                    </button>
                    
                    <div class="w-px h-8 bg-gray-300"></div>
                    
                    <input type="color" id="infinitaBrushColor" value="#000000" class="w-10 h-10 rounded cursor-pointer border-2">
                    <input type="range" id="infinitaBrushSize" min="1" max="30" value="3" class="w-24">
                    
                    <div class="w-px h-8 bg-gray-300"></div>
                    
                    <button onclick="limpiarPizarraInfinita()" class="pizarra-action text-red-500">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button onclick="resetZoomInfinita()" class="pizarra-action">
                        <i class="fas fa-search"></i>
                    </button>
                    <button onclick="guardarPizarraInfinita()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                        <i class="fas fa-save"></i>
                    </button>
                </div>
            </div>
            
            <div id="infinitaContainer" style="position: absolute; top: 60px; left: 256px; right: 0; bottom: 0; overflow: hidden; background: #f5f5f5; cursor: grab;">
                <canvas id="infinitaCanvas" style="position: absolute; cursor: crosshair;"></canvas>
            </div>
        </div>
        
        <!-- P√°gina de Compartir -->
        <div id="page-compartir" class="page-content p-8" style="display:none;">
            <h1 class="text-3xl font-bold mb-2">
                <i class="fas fa-share-alt text-blue-600"></i> Compartir y Exportar
            </h1>
            <p class="text-gray-600 mb-8">Crea im√°genes bonitas para compartir tu progreso</p>
            
            <!-- Opciones de compartir -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <!-- Compartir Horario -->
                <div class="bg-white rounded-xl p-6 shadow-sm border-2 border-blue-100">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-calendar-week text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold">Mi Horario</h2>
                            <p class="text-sm text-gray-600">Comparte tu horario semanal</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Estilo</label>
                        <select id="horarioEstilo" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="clean">Limpio y minimalista</option>
                            <option value="colorful">Colorido</option>
                            <option value="dark">Modo oscuro</option>
                            <option value="gradient">Con degradado</option>
                        </select>
                    </div>
                    
                    <button onclick="compartirHorario()" class="w-full bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition font-medium">
                        <i class="fas fa-download mr-2"></i>Generar Imagen
                    </button>
                </div>
                
                <!-- Compartir Tareas -->
                <div class="bg-white rounded-xl p-6 shadow-sm border-2 border-green-100">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-tasks text-green-600 text-xl"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold">Mis Tareas</h2>
                            <p class="text-sm text-gray-600">Lista de tareas pendientes</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filtro</label>
                        <select id="tareasFiltro" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="all">Todas las tareas</option>
                            <option value="pending">Solo pendientes</option>
                            <option value="high">Alta prioridad</option>
                            <option value="today">Para hoy</option>
                            <option value="week">Esta semana</option>
                        </select>
                    </div>
                    
                    <button onclick="compartirTareas()" class="w-full bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition font-medium">
                        <i class="fas fa-download mr-2"></i>Generar Imagen
                    </button>
                </div>
                
                <!-- Compartir Progreso -->
                <div class="bg-white rounded-xl p-6 shadow-sm border-2 border-purple-100">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chart-line text-purple-600 text-xl"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold">Mi Progreso</h2>
                            <p class="text-sm text-gray-600">Resumen de estad√≠sticas</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Per√≠odo</label>
                        <select id="progresoFiltro" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="week">Esta semana</option>
                            <option value="month">Este mes</option>
                            <option value="all">Todo el tiempo</option>
                        </select>
                    </div>
                    
                    <button onclick="compartirProgreso()" class="w-full bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition font-medium">
                        <i class="fas fa-download mr-2"></i>Generar Imagen
                    </button>
                </div>
                
                <!-- Compartir PAU -->
                <div class="bg-white rounded-xl p-6 shadow-sm border-2 border-orange-100">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-graduation-cap text-orange-600 text-xl"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold">Info PAU</h2>
                            <p class="text-sm text-gray-600">Cuenta regresiva motivacional</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Incluir</label>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="incluirDias" checked class="w-4 h-4">
                                <span class="text-sm">D√≠as restantes</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="incluirNota" checked class="w-4 h-4">
                                <span class="text-sm">Nota estimada</span>
                            </label>
                        </div>
                    </div>
                    
                    <button onclick="compartirPAU()" class="w-full bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600 transition font-medium">
                        <i class="fas fa-download mr-2"></i>Generar Imagen
                    </button>
                </div>
                
            </div>
            
            <!-- Canvas oculto para generar im√°genes -->
            <canvas id="shareCanvas" style="display: none;"></canvas>
            
            <!-- Vista previa -->
            <div id="sharePreview" style="display:none;" class="mt-8">
                <h2 class="text-2xl font-bold mb-4">Vista Previa</h2>
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <img id="sharePreviewImg" class="w-full max-w-2xl mx-auto rounded-lg border border-gray-200">
                    <div class="flex gap-3 mt-6 justify-center">
                        <button onclick="descargarImagen()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition font-medium">
                            <i class="fas fa-download mr-2"></i>Descargar
                        </button>
                        <button onclick="copiarImagen()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition font-medium">
                            <i class="fas fa-copy mr-2"></i>Copiar
                        </button>
                        <button onclick="cerrarPreview()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition font-medium">
                            <i class="fas fa-times mr-2"></i>Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- P√°gina de Temas -->
        <div id="page-temas" class="page-content p-8" style="display:none;">
            <h1 class="text-3xl font-bold mb-2">
                <i class="fas fa-palette text-purple-500"></i> Personalizaci√≥n de Temas
            </h1>
            <p class="text-gray-600 mb-8">Personaliza los colores y el estilo de tu app</p>
            
            <!-- Presets -->
            <div class="bg-white rounded-xl p-6 shadow-sm mb-6">
                <h2 class="text-xl font-semibold mb-4">üé® Temas Predefinidos</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <button onclick="applyPreset('default')" class="theme-preset-btn">
                        <div class="w-full h-24 rounded-lg mb-2 bg-gradient-to-br from-blue-500 to-blue-600"></div>
                        <p class="text-sm font-medium">Por Defecto</p>
                    </button>
                    <button onclick="applyPreset('dark')" class="theme-preset-btn">
                        <div class="w-full h-24 rounded-lg mb-2 bg-gradient-to-br from-gray-800 to-gray-900"></div>
                        <p class="text-sm font-medium">Oscuro</p>
                    </button>
                    <button onclick="applyPreset('sunset')" class="theme-preset-btn">
                        <div class="w-full h-24 rounded-lg mb-2 bg-gradient-to-br from-orange-400 via-pink-500 to-purple-600"></div>
                        <p class="text-sm font-medium">Atardecer</p>
                    </button>
                    <button onclick="applyPreset('ocean')" class="theme-preset-btn">
                        <div class="w-full h-24 rounded-lg mb-2 bg-gradient-to-br from-cyan-400 to-blue-600"></div>
                        <p class="text-sm font-medium">Oc√©ano</p>
                    </button>
                    <button onclick="applyPreset('forest')" class="theme-preset-btn">
                        <div class="w-full h-24 rounded-lg mb-2 bg-gradient-to-br from-green-400 to-green-700"></div>
                        <p class="text-sm font-medium">Bosque</p>
                    </button>
                    <button onclick="applyPreset('fire')" class="theme-preset-btn">
                        <div class="w-full h-24 rounded-lg mb-2 bg-gradient-to-br from-yellow-400 via-orange-500 to-red-600"></div>
                        <p class="text-sm font-medium">Fuego</p>
                    </button>
                    <button onclick="applyPreset('purple')" class="theme-preset-btn">
                        <div class="w-full h-24 rounded-lg mb-2 bg-gradient-to-br from-purple-400 to-purple-700"></div>
                        <p class="text-sm font-medium">Morado</p>
                    </button>
                    <button onclick="applyPreset('neon')" class="theme-preset-btn">
                        <div class="w-full h-24 rounded-lg mb-2 bg-gradient-to-br from-cyan-400 to-fuchsia-600"></div>
                        <p class="text-sm font-medium">Ne√≥n</p>
                    </button>
                    <button onclick="applyPreset('pastel')" class="theme-preset-btn">
                        <div class="w-full h-24 rounded-lg mb-2 bg-gradient-to-br from-pink-200 via-purple-200 to-blue-200"></div>
                        <p class="text-sm font-medium">Pastel</p>
                    </button>
                    <button onclick="applyPreset('sepia')" class="theme-preset-btn">
                        <div class="w-full h-24 rounded-lg mb-2 bg-gradient-to-br from-amber-100 to-amber-300"></div>
                        <p class="text-sm font-medium">Sepia</p>
                    </button>
                </div>
            </div>
            
            <!-- Personalizaci√≥n avanzada -->
            <div class="bg-white rounded-xl p-6 shadow-sm mb-6">
                <h2 class="text-xl font-semibold mb-4">üéõÔ∏è Personalizaci√≥n Avanzada</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Color Primario -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Color Primario</label>
                        <div class="flex gap-3 items-center">
                            <input type="color" id="primaryColor" value="#3b82f6" class="w-16 h-10 rounded cursor-pointer">
                            <input type="text" id="primaryColorHex" value="#3b82f6" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" onchange="updateColorFromHex('primary')">
                        </div>
                    </div>
                    
                    <!-- Color Secundario -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Color Secundario</label>
                        <div class="flex gap-3 items-center">
                            <input type="color" id="secondaryColor" value="#8b5cf6" class="w-16 h-10 rounded cursor-pointer">
                            <input type="text" id="secondaryColorHex" value="#8b5cf6" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" onchange="updateColorFromHex('secondary')">
                        </div>
                    </div>
                    
                    <!-- Color de Fondo -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Color de Fondo</label>
                        <div class="flex gap-3 items-center">
                            <input type="color" id="bgColor" value="#f9fafb" class="w-16 h-10 rounded cursor-pointer">
                            <input type="text" id="bgColorHex" value="#f9fafb" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" onchange="updateColorFromHex('bg')">
                        </div>
                    </div>
                    
                    <!-- Color del Sidebar -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Color del Sidebar</label>
                        <div class="flex gap-3 items-center">
                            <input type="color" id="sidebarColor" value="#ffffff" class="w-16 h-10 rounded cursor-pointer">
                            <input type="text" id="sidebarColorHex" value="#ffffff" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" onchange="updateColorFromHex('sidebar')">
                        </div>
                    </div>
                </div>
                
                <!-- Degradados -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">üåà Degradados</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Habilitar degradado en fondo</label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="enableGradient" class="w-4 h-4" onchange="toggleGradient()">
                                <span class="text-sm">Activar gradiente de fondo</span>
                            </label>
                        </div>
                        
                        <div id="gradientControls" style="display:none;">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Color inicial del degradado</label>
                                    <input type="color" id="gradientColor1" value="#3b82f6" class="w-16 h-10 rounded cursor-pointer">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Color final del degradado</label>
                                    <input type="color" id="gradientColor2" value="#8b5cf6" class="w-16 h-10 rounded cursor-pointer">
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Direcci√≥n: <span id="gradientAngleValue">135</span>¬∞</label>
                                <input type="range" id="gradientAngle" min="0" max="360" value="135" class="w-full" oninput="updateGradientAngle()">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Vista previa -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">üëÄ Vista Previa</h3>
                    <div id="themePreview" class="p-6 rounded-xl border-2 border-gray-200 min-h-[200px]">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center text-white">
                                <i class="fas fa-home"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold">Dashboard</h4>
                                <p class="text-sm text-gray-600">Vista previa de tu tema</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-white p-3 rounded-lg shadow-sm">
                                <p class="text-xs text-gray-600">Tareas</p>
                                <p class="text-2xl font-bold">12</p>
                            </div>
                            <div class="bg-white p-3 rounded-lg shadow-sm">
                                <p class="text-xs text-gray-600">Eventos</p>
                                <p class="text-2xl font-bold">5</p>
                            </div>
                            <div class="bg-white p-3 rounded-lg shadow-sm">
                                <p class="text-xs text-gray-600">Cursos</p>
                                <p class="text-2xl font-bold">8</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Botones de acci√≥n -->
                <div class="flex gap-3">
                    <button onclick="applyCustomTheme()" class="flex-1 bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition font-medium">
                        <i class="fas fa-check mr-2"></i>Aplicar Tema
                    </button>
                    <button onclick="resetTheme()" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition font-medium">
                        <i class="fas fa-undo mr-2"></i>Resetear
                    </button>
                </div>
            </div>
        </div>
        
        </div>
    </div>

    <script>
        console.log('üöÄ Rayan App v2.0 FIXED - ' + new Date().toISOString());
        
        // User Management - DESACTIVADO (ahora se usa Firebase Authentication)
        // const CURRENT_USER_KEY = 'rayan_current_user';
        // let currentUser = JSON.parse(localStorage.getItem(CURRENT_USER_KEY));
        
        // Initialize user
        // if (!currentUser) {
        //     currentUser = { name: 'Usuario', email: 'user@rayan.com' };
        //     localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser));
        // }
        
        // document.getElementById('userName').textContent = currentUser.name;
        
        // Navigation System
        function navigateTo(page) {
            console.log('Navegando a:', page);
            
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(p => {
                p.style.display = 'none';
            });
            
            // Show selected page
            const targetPage = document.getElementById('page-' + page);
            console.log('Target page:', targetPage);
            
            if (targetPage) {
                targetPage.style.display = 'block';
                console.log('P√°gina mostrada:', page);
                console.log('targetPage.style.display:', targetPage.style.display);
                console.log('getComputedStyle display:', window.getComputedStyle(targetPage).display);
                console.log('targetPage.offsetHeight:', targetPage.offsetHeight);
                console.log('targetPage.offsetWidth:', targetPage.offsetWidth);
                
                // Force render after showing - use setTimeout to ensure DOM is updated
                setTimeout(() => {
                    if (page === 'calendario') {
                        console.log('FORZANDO renderizado de calendario...');
                        renderCalendar();
                        renderUpcomingEvents();
                    } else if (page === 'cursos') {
                        console.log('FORZANDO renderizado de cursos...');
                        renderCourses();
                        updateCoursesStats();
                    } else if (page === 'tareas') {
                        loadTasks();
                    } else if (page === 'integraciones') {
                        renderSchedule();
                    } else if (page === 'pizarra') {
                        console.log('Inicializando pizarra...');
                        inicializarPizarra();
                    } else if (page === 'pizarra-infinita') {
                        console.log('Inicializando pizarra infinita...');
                        inicializarPizarraInfinita();
                    } else if (page === 'selectividad') {
                        actualizarContadorPAU();
                    }
                }, 100);
            } else {
                console.error('No se encontr√≥ la p√°gina:', 'page-' + page);
            }
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === page) {
                    item.classList.add('active');
                }
            });
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Chat Functions
        // Claude AI Chat System
        const CHAT_HISTORY_KEY = 'rayan_chat_history';
        let chatHistory = JSON.parse(localStorage.getItem(CHAT_HISTORY_KEY)) || [];
        
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            
            // Save to history
            chatHistory.push({ role: 'user', content: message });
            
            // Show typing indicator
            const typingId = showTypingIndicator();
            
            // Disable send button
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            sendButton.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
            
            try {
                // Call Claude API
                const response = await callClaudeAPI(message);
                
                // Remove typing indicator
                removeTypingIndicator(typingId);
                
                // Add AI response
                addChatMessage(response, 'ai');
                
                // Save to history
                chatHistory.push({ role: 'assistant', content: response });
                localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(chatHistory.slice(-20))); // Keep last 20 messages
                
            } catch (error) {
                removeTypingIndicator(typingId);
                addChatMessage('Lo siento, ha ocurrido un error. Por favor, intenta de nuevo.', 'ai');
                console.error('Error calling Claude:', error);
            }
            
            // Re-enable send button
            sendButton.disabled = false;
            sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
        }
        
        async function callClaudeAPI(userMessage) {
            // Use Claude API available in artifacts - no key needed!
            const context = buildUserContext();
            
            const systemPrompt = `Eres Claude, un asistente de IA integrado en la aplicaci√≥n Rayan.

TUS DATOS ACTUALES DEL USUARIO:
${context}

CAPACIDADES - SIEMPRE CREA ACCIONES CUANDO CORRESPONDA:
1. CREAR TAREAS: Cuando pidan crear/a√±adir/agregar una tarea
2. CREAR EVENTOS: Cuando pidan crear un evento/examen/clase
3. CREAR CURSOS: Cuando pidan crear/a√±adir un curso/materia
4. SUBIR MATERIALES: Cuando pidan subir/a√±adir un enlace/material a un curso
5. ANALIZAR: Cuando pidan an√°lisis/resumen/estad√≠sticas

REGLAS CR√çTICAS PARA ACCIONES:
- SIEMPRE que crees algo, DEBES incluir la etiqueta <ACTION> al final
- NO preguntes confirmaci√≥n, simplemente CREA la acci√≥n
- Usa el formato JSON EXACTO que se muestra abajo

FORMATO DE ACCIONES (copia exactamente):
<ACTION>{"type":"create_task","data":{"title":"T√≠tulo aqu√≠","description":"","subject":"Materia","dueDate":"2025-12-01","priority":"medium","status":"pending"}}</ACTION>

<ACTION>{"type":"create_event","data":{"title":"T√≠tulo aqu√≠","description":"","date":"2025-12-01","time":"10:00","eventType":"event","color":"blue"}}</ACTION>

<ACTION>{"type":"create_course","data":{"name":"Nombre del curso","code":"","description":"","teacher":"","credits":"","color":"blue"}}</ACTION>

<ACTION>{"type":"upload_material","data":{"courseName":"Nombre EXACTO del curso","title":"T√≠tulo del material","description":"","type":"link","link":"https://ejemplo.com"}}</ACTION>

IMPORTANTE PARA MATERIALES:
- courseName debe coincidir EXACTAMENTE con un curso existente (mira los datos arriba)
- Si no existe el curso, primero crea el curso y luego sube el material

Responde en espa√±ol, amigable y SIEMPRE incluye acciones cuando corresponda.`;

            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 2000,
                        system: systemPrompt,
                        messages: [
                            ...chatHistory.slice(-6), // Less context for better focus
                            { role: "user", content: userMessage }
                        ]
                    })
                });
                
                if (!response.ok) {
                    console.log('API failed, using local fallback');
                    throw new Error('API call failed');
                }
                
                const data = await response.json();
                const assistantMessage = data.content[0].text;
                
                console.log('Claude response:', assistantMessage);
                
                // Check for actions
                processAIActions(assistantMessage);
                
                // Remove action tags from display
                return assistantMessage.replace(/<ACTION>.*?<\/ACTION>/g, '').trim();
                
            } catch (error) {
                console.log('Using local simulation');
                // Fallback to ENHANCED local simulation
                return await generateLocalAIResponse(userMessage, context);
            }
        }
        
        async function generateLocalAIResponse(userMessage, context) {
            // ENHANCED local AI simulation with better NLP
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const msg = userMessage.toLowerCase();
            
            console.log('Local AI processing:', msg);
            
            // PRIORITY 1: CREATE TASK
            if ((msg.includes('crea') || msg.includes('a√±ade') || msg.includes('agrega') || msg.includes('nueva')) && 
                (msg.includes('tarea') || msg.includes('homework') || msg.includes('assignment'))) {
                return handleCreateTask(userMessage, msg);
            }
            
            // PRIORITY 2: CREATE EVENT  
            if ((msg.includes('crea') || msg.includes('a√±ade') || msg.includes('agrega') || msg.includes('nuevo')) && 
                (msg.includes('evento') || msg.includes('examen') || msg.includes('clase') || msg.includes('event'))) {
                return handleCreateEvent(userMessage, msg);
            }
            
            // PRIORITY 3: CREATE COURSE
            if ((msg.includes('crea') || msg.includes('a√±ade') || msg.includes('agrega') || msg.includes('nuevo')) && 
                (msg.includes('curso') || msg.includes('materia') || msg.includes('asignatura') || msg.includes('course'))) {
                return handleCreateCourse(userMessage, msg);
            }
            
            // PRIORITY 4: UPLOAD MATERIAL - MEJORADO
            if ((msg.includes('sube') || msg.includes('subir') || msg.includes('a√±ade') || msg.includes('agrega') || 
                 msg.includes('upload') || msg.includes('http')) && 
                (msg.includes('curso') || msg.includes('materia') || msg.includes('material') || msg.includes('enlace'))) {
                return handleUploadMaterial(userMessage, msg);
            }
            
            // PRIORITY 5: ANALYZE
            if (msg.includes('analiza') || msg.includes('an√°lisis') || msg.includes('resumen') || msg.includes('analyze')) {
                if (msg.includes('tarea')) return analyzeTasks();
                if (msg.includes('curso')) return analyzeCourses();
                if (msg.includes('evento')) return analyzeEvents();
                return analyzeAll();
            }
            
            // PRIORITY 6: LIST/SHOW
            if (msg.includes('qu√©') || msg.includes('que') || msg.includes('cu√°l') || msg.includes('cual') || 
                msg.includes('muestra') || msg.includes('lista') || msg.includes('dime') || msg.includes('what')) {
                if (msg.includes('tarea')) return listTasks();
                if (msg.includes('curso')) return listCourses();
                if (msg.includes('evento') || msg.includes('pr√≥ximo') || msg.includes('proximo')) return listEvents();
            }
            
            // PRIORITY 7: GREETINGS
            if (msg.match(/^(hola|hi|hey|hello|buenos|buenas)/)) {
                return '¬°Hola! üëã Puedo ayudarte con:\n\n‚Ä¢ **Crear tareas**: "Crea una tarea de matem√°ticas para ma√±ana"\n‚Ä¢ **Crear eventos**: "Crea un examen de f√≠sica el lunes"\n‚Ä¢ **Crear cursos**: "Crea un curso de Literatura"\n‚Ä¢ **Subir materiales**: "Sube https://ejemplo.com al curso de Matem√°ticas"\n‚Ä¢ **Analizar**: "Analiza mis tareas"\n\n¬øQu√© necesitas?';
            }
            
            // PRIORITY 8: HELP
            if (msg.includes('ayuda') || msg.includes('help') || msg.includes('c√≥mo') || msg.includes('como')) {
                return `üí° **Gu√≠a r√°pida:**\n\n**Para crear:**\n‚Ä¢ "Crea una tarea de [materia] para [fecha]"\n‚Ä¢ "Crea un evento de [t√≠tulo] el [fecha]"\n‚Ä¢ "Crea un curso de [nombre]"\n\n**Para subir materiales:**\n‚Ä¢ "Sube [URL] al curso de [nombre]"\n\n**Para consultar:**\n‚Ä¢ "Analiza mis tareas"\n‚Ä¢ "¬øQu√© cursos tengo?"\n‚Ä¢ "Muestra mis eventos"\n\n¬øQu√© quieres hacer?`;
            }
            
            // DEFAULT: Helpful suggestion
            return `Entiendo que preguntas sobre "${userMessage}".\n\n¬øQuieres que te ayude a:\n‚Ä¢ Crear una tarea/evento/curso?\n‚Ä¢ Analizar tus datos?\n‚Ä¢ Subir un material?\n\nDime qu√© necesitas y lo hago. üòä`;
        }
        
        function analyzeTasks() {
            // Extract info
            const title = extractBetween(original, 'tarea', 'para') || extractBetween(original, 'tarea', 'de') || 'Nueva tarea';
            const subject = extractSubject(msg) || '';
            const dueDate = extractDate(msg) || getTomorrow();
            const priority = msg.includes('urgente') || msg.includes('importante') ? 'high' : msg.includes('baja') ? 'low' : 'medium';
            
            const action = {
                type: 'create_task',
                data: {
                    title: cleanTitle(title),
                    description: '',
                    subject: subject,
                    dueDate: dueDate,
                    priority: priority,
                    status: 'pending'
                }
            };
            
            return `¬°Por supuesto! He creado la tarea "${cleanTitle(title)}" para el ${formatDateES(dueDate)} con prioridad ${priority === 'high' ? 'alta' : priority === 'low' ? 'baja' : 'media'}.\n\n<ACTION>${JSON.stringify(action)}</ACTION>`;
        }
        
        function handleCreateEvent(original, msg) {
            const title = extractBetween(original, 'evento', 'el') || extractBetween(original, 'evento', 'para') || 'Nuevo evento';
            const date = extractDate(msg) || getTomorrow();
            const time = extractTime(msg) || '';
            const eventType = msg.includes('examen') ? 'exam' : msg.includes('clase') ? 'class' : 'event';
            
            const action = {
                type: 'create_event',
                data: {
                    title: cleanTitle(title),
                    description: '',
                    date: date,
                    time: time,
                    eventType: eventType,
                    color: 'blue'
                }
            };
            
            return `¬°Listo! He creado el evento "${cleanTitle(title)}" para el ${formatDateES(date)}${time ? ' a las ' + time : ''}.\n\n<ACTION>${JSON.stringify(action)}</ACTION>`;
        }
        
        function handleCreateCourse(original, msg) {
            const name = extractBetween(original, 'curso', 'con') || extractBetween(original, 'curso', 'de') || 'Nuevo curso';
            const teacher = extractTeacher(original) || '';
            const credits = extractCredits(msg) || '';
            const code = extractCode(original) || '';
            
            const action = {
                type: 'create_course',
                data: {
                    name: cleanTitle(name),
                    code: code,
                    description: '',
                    teacher: teacher,
                    credits: credits,
                    color: 'blue'
                }
            };
            
            return `¬°Perfecto! He creado el curso "${cleanTitle(name)}"${teacher ? ' con el profesor ' + teacher : ''}${credits ? ' (' + credits + ' cr√©ditos)' : ''}.\n\n<ACTION>${JSON.stringify(action)}</ACTION>`;
        }
        
        function handleUploadMaterial(original, msg) {
            console.log('Handling upload material:', original);
            
            // Try multiple patterns to extract course name
            let courseName = null;
            let link = null;
            let title = null;
            
            // Extract link first
            const linkMatch = original.match(/(https?:\/\/[^\s]+)/i);
            if (linkMatch) {
                link = linkMatch[1];
            }
            
            // Pattern 1: "al curso de X" or "al curso X"
            let courseMatch = original.match(/al\s+curso\s+(?:de\s+)?["']?([^"'\n,]+?)["']?(?:\s|$|,)/i);
            if (!courseMatch) {
                // Pattern 2: "curso de X"
                courseMatch = original.match(/curso\s+(?:de\s+)?["']?([^"'\n,]+?)["']?(?:\s+como|$|,)/i);
            }
            if (!courseMatch) {
                // Pattern 3: "en X" where X is a course name
                const availableCourses = courses.map(c => c.name.toLowerCase());
                for (let course of courses) {
                    if (msg.includes(course.name.toLowerCase())) {
                        courseName = course.name;
                        break;
                    }
                }
            } else {
                courseName = courseMatch[1].trim();
            }
            
            // Extract title
            const titleMatch1 = original.match(/como\s+["']?([^"'\n]+?)["']?(?:\s+al|\s+en|$)/i);
            const titleMatch2 = original.match(/t√≠tulo\s+["']?([^"'\n]+?)["']?(?:\s|$)/i);
            if (titleMatch1) {
                title = titleMatch1[1].trim();
            } else if (titleMatch2) {
                title = titleMatch2[1].trim();
            } else if (link) {
                // Generate title from URL
                title = link.split('/').pop().split('?')[0] || 'Material nuevo';
            } else {
                title = 'Material nuevo';
            }
            
            // Validate
            if (!courseName) {
                const courseList = courses.map(c => `‚Ä¢ ${c.name}`).join('\n');
                return `Para subir un material, necesito saber a qu√© curso.\n\n**Tus cursos:**\n${courseList || '(No tienes cursos a√∫n)'}\n\n**Ejemplo:** "Sube https://ejemplo.com al curso de Matem√°ticas"`;
            }
            
            if (!link) {
                return `Necesito el enlace del material.\n\n**Ejemplo:** "Sube https://ejemplo.com/apuntes.pdf al curso de ${courseName}"`;
            }
            
            // Find exact course (case insensitive)
            const course = courses.find(c => c.name.toLowerCase() === courseName.toLowerCase());
            
            if (!course) {
                const similar = courses.find(c => c.name.toLowerCase().includes(courseName.toLowerCase()) || 
                                                  courseName.toLowerCase().includes(c.name.toLowerCase()));
                if (similar) {
                    courseName = similar.name; // Use exact name
                } else {
                    return `No encontr√© el curso "${courseName}".\n\n**Tus cursos:**\n${courses.map(c => `‚Ä¢ ${c.name}`).join('\n')}\n\n¬øQuieres crear este curso primero?`;
                }
            }
            
            const action = {
                type: 'upload_material',
                data: {
                    courseName: course ? course.name : courseName,
                    title: cleanTitle(title),
                    description: '',
                    type: 'link',
                    link: link
                }
            };
            
            console.log('Upload action:', action);
            
            return `‚úÖ Listo! He subido el material **"${cleanTitle(title)}"** al curso **"${course ? course.name : courseName}"**.\n\n<ACTION>${JSON.stringify(action)}</ACTION>`;
        }
        
        function analyzeTasks() {
            if (tasks.length === 0) {
                return 'No tienes tareas registradas a√∫n. ¬øQuieres que te ayude a crear tu primera tarea?';
            }
            
            const pending = tasks.filter(t => t.status === 'pending');
            const completed = tasks.filter(t => t.status === 'completed');
            const overdue = pending.filter(t => new Date(t.dueDate) < new Date());
            const high = pending.filter(t => t.priority === 'high');
            
            let response = `üìä **An√°lisis de tus tareas:**\n\n`;
            response += `‚Ä¢ Total: ${tasks.length} tareas\n`;
            response += `‚Ä¢ Pendientes: ${pending.length}\n`;
            response += `‚Ä¢ Completadas: ${completed.length}\n`;
            if (overdue.length > 0) response += `‚Ä¢ ‚ö†Ô∏è Vencidas: ${overdue.length}\n`;
            if (high.length > 0) response += `‚Ä¢ üî¥ Prioridad alta: ${high.length}\n`;
            
            if (pending.length > 0) {
                response += `\n**Pr√≥ximas tareas:**\n`;
                pending.slice(0, 3).forEach(t => {
                    response += `‚Ä¢ ${t.title} - Vence: ${formatDateES(t.dueDate)}\n`;
                });
            }
            
            if (high.length > 0) {
                response += `\nüí° **Recomendaci√≥n:** Tienes ${high.length} tarea${high.length > 1 ? 's' : ''} de prioridad alta. Te sugiero enfocarte en ella${high.length > 1 ? 's' : ''} primero.`;
            }
            
            return response;
        }
        
        function analyzeCourses() {
            if (courses.length === 0) {
                return 'No tienes cursos registrados. ¬øQuieres crear tu primer curso?';
            }
            
            let response = `üìö **Tus cursos:**\n\n`;
            courses.forEach(course => {
                const mats = materials.filter(m => m.courseId === course.id);
                response += `‚Ä¢ **${course.name}**`;
                if (course.code) response += ` (${course.code})`;
                response += ` - ${mats.length} material${mats.length !== 1 ? 'es' : ''}\n`;
            });
            
            response += `\nüìä Total: ${courses.length} cursos con ${materials.length} materiales`;
            
            return response;
        }
        
        function analyzeEvents() {
            const upcoming = events.filter(e => new Date(e.date) >= new Date());
            
            if (upcoming.length === 0) {
                return 'No tienes eventos pr√≥ximos. ¬øQuieres crear uno?';
            }
            
            let response = `üìÖ **Pr√≥ximos eventos:**\n\n`;
            upcoming.slice(0, 5).forEach(event => {
                response += `‚Ä¢ ${event.title} - ${formatDateES(event.date)}${event.time ? ' a las ' + event.time : ''}\n`;
            });
            
            return response;
        }
        
        function analyzeAll() {
            return `üìä **Resumen general:**\n\n` +
                   `üìù Tareas: ${tasks.length} (${tasks.filter(t => t.status === 'pending').length} pendientes)\n` +
                   `üìö Cursos: ${courses.length} con ${materials.length} materiales\n` +
                   `üìÖ Eventos: ${events.filter(e => new Date(e.date) >= new Date()).length} pr√≥ximos\n\n` +
                   `¬øQuieres un an√°lisis m√°s detallado de algo espec√≠fico?`;
        }
        
        function listTasks() {
            const pending = tasks.filter(t => t.status === 'pending');
            if (pending.length === 0) return 'No tienes tareas pendientes. ¬°Buen trabajo! üéâ';
            
            let response = `üìù **Tareas pendientes:**\n\n`;
            pending.forEach(t => {
                response += `‚Ä¢ ${t.title} - ${formatDateES(t.dueDate)} (${t.priority === 'high' ? 'üî¥ Alta' : t.priority === 'low' ? 'üü¢ Baja' : 'üü° Media'})\n`;
            });
            return response;
        }
        
        function listCourses() {
            if (courses.length === 0) return 'No tienes cursos. ¬øQuieres crear uno?';
            
            let response = `üìö **Tus cursos:**\n\n`;
            courses.forEach(c => {
                response += `‚Ä¢ ${c.name}${c.code ? ' (' + c.code + ')' : ''}\n`;
            });
            return response;
        }
        
        function listEvents() {
            const upcoming = events.filter(e => new Date(e.date) >= new Date()).slice(0, 5);
            if (upcoming.length === 0) return 'No tienes eventos pr√≥ximos.';
            
            let response = `üìÖ **Pr√≥ximos eventos:**\n\n`;
            upcoming.forEach(e => {
                response += `‚Ä¢ ${e.title} - ${formatDateES(e.date)}\n`;
            });
            return response;
        }
        
        function listUpcoming() {
            const upcomingTasks = tasks.filter(t => t.status === 'pending' && new Date(t.dueDate) >= new Date()).slice(0, 3);
            const upcomingEvents = events.filter(e => new Date(e.date) >= new Date()).slice(0, 3);
            
            let response = `üîú **Pr√≥ximamente:**\n\n`;
            
            if (upcomingTasks.length > 0) {
                response += `**Tareas:**\n`;
                upcomingTasks.forEach(t => response += `‚Ä¢ ${t.title} - ${formatDateES(t.dueDate)}\n`);
                response += '\n';
            }
            
            if (upcomingEvents.length > 0) {
                response += `**Eventos:**\n`;
                upcomingEvents.forEach(e => response += `‚Ä¢ ${e.title} - ${formatDateES(e.date)}\n`);
            }
            
            return response || 'No tienes nada pr√≥ximo programado.';
        }
        
        // HELPER FUNCTIONS
        function extractBetween(text, start, end) {
            const regex = new RegExp(start + '\\s+(?:de\\s+)?(?:un\\s+)?(?:una\\s+)?([^' + end + ']+)', 'i');
            const match = text.match(regex);
            return match ? match[1].trim() : null;
        }
        
        function extractSubject(text) {
            const subjects = ['matem√°ticas', 'f√≠sica', 'qu√≠mica', 'historia', 'literatura', 'ingl√©s', 'espa√±ol', 'biolog√≠a', 'geograf√≠a', 'filosof√≠a'];
            for (let subject of subjects) {
                if (text.includes(subject)) return subject.charAt(0).toUpperCase() + subject.slice(1);
            }
            return '';
        }
        
        function extractDate(text) {
            if (text.includes('ma√±ana')) return getTomorrow();
            if (text.includes('hoy')) return getToday();
            if (text.includes('pasado ma√±ana')) return getDateOffset(2);
            
            const dateMatch = text.match(/(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?/);
            if (dateMatch) {
                const day = dateMatch[1].padStart(2, '0');
                const month = dateMatch[2].padStart(2, '0');
                const year = dateMatch[3] || new Date().getFullYear();
                return `${year}-${month}-${day}`;
            }
            
            // Days of week
            const days = ['lunes', 'martes', 'mi√©rcoles', 'miercoles', 'jueves', 'viernes', 's√°bado', 'sabado', 'domingo'];
            for (let i = 0; i < days.length; i++) {
                if (text.includes(days[i])) {
                    return getNextDayOfWeek(i + 1);
                }
            }
            
            return null;
        }
        
        function extractTime(text) {
            const timeMatch = text.match(/(\d{1,2}):(\d{2})|(\d{1,2})\s*(?:am|pm|h)/i);
            if (timeMatch) {
                if (timeMatch[1]) return `${timeMatch[1].padStart(2, '0')}:${timeMatch[2]}`;
                if (timeMatch[3]) return `${timeMatch[3].padStart(2, '0')}:00`;
            }
            return '';
        }
        
        function extractTeacher(text) {
            const match = text.match(/(?:profesor|prof|teacher)\s+([A-Z√Å-√ö][a-z√°-√∫]+(?:\s+[A-Z√Å-√ö][a-z√°-√∫]+)?)/i);
            return match ? match[1] : '';
        }
        
        function extractCredits(text) {
            const match = text.match(/(\d+(?:\.\d+)?)\s*(?:cr√©ditos|creditos|credits)/i);
            return match ? match[1] : '';
        }
        
        function extractCode(text) {
            const match = text.match(/(?:c√≥digo|codigo|code)\s+([A-Z0-9\-]+)/i);
            return match ? match[1] : '';
        }
        
        function cleanTitle(text) {
            return text.replace(/^(?:de|un|una|el|la)\s+/i, '').trim();
        }
        
        function getTomorrow() {
            const date = new Date();
            date.setDate(date.getDate() + 1);
            return date.toISOString().split('T')[0];
        }
        
        function getToday() {
            return new Date().toISOString().split('T')[0];
        }
        
        function getDateOffset(days) {
            const date = new Date();
            date.setDate(date.getDate() + days);
            return date.toISOString().split('T')[0];
        }
        
        function getNextDayOfWeek(targetDay) {
            const today = new Date();
            const currentDay = today.getDay() || 7; // Sunday = 7
            const daysUntilTarget = (targetDay - currentDay + 7) % 7 || 7;
            today.setDate(today.getDate() + daysUntilTarget);
            return today.toISOString().split('T')[0];
        }
        
        function formatDateES(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const months = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
            return `${date.getDate()} ${months[date.getMonth()]}`;
        }
        
        function buildUserContext() {
            const tasksSummary = `Tareas: ${tasks.length} total (${tasks.filter(t => t.status === 'pending').length} pendientes, ${tasks.filter(t => t.status === 'completed').length} completadas)`;
            const coursesSummary = `Cursos: ${courses.length} cursos con ${materials.length} materiales`;
            const eventsSummary = `Eventos: ${events.length} eventos programados`;
            
            let context = `${tasksSummary}\n${coursesSummary}\n${eventsSummary}\n\n`;
            
            // Add recent tasks
            if (tasks.length > 0) {
                context += '√öltimas tareas:\n';
                tasks.slice(-5).forEach(task => {
                    context += `- ${task.title} (${task.subject || 'Sin materia'}, vence: ${task.dueDate}, ${task.status})\n`;
                });
                context += '\n';
            }
            
            // Add courses with materials count
            if (courses.length > 0) {
                context += 'Cursos disponibles (para subir materiales usa el nombre exacto):\n';
                courses.forEach(course => {
                    const courseMaterials = materials.filter(m => m.courseId === course.id);
                    context += `- "${course.name}" (${course.code || 'Sin c√≥digo'}, ${courseMaterials.length} materiales`;
                    if (course.teacher) context += `, Prof: ${course.teacher}`;
                    context += ')\n';
                    
                    // List materials in this course
                    if (courseMaterials.length > 0) {
                        courseMaterials.slice(-3).forEach(mat => {
                            context += `  ‚Ä¢ ${mat.title} (${mat.type})\n`;
                        });
                    }
                });
                context += '\n';
            }
            
            // Add upcoming events
            const upcomingEvents = events.filter(e => new Date(e.date) >= new Date()).slice(0, 5);
            if (upcomingEvents.length > 0) {
                context += 'Pr√≥ximos eventos:\n';
                upcomingEvents.forEach(event => {
                    context += `- ${event.title} (${event.date}${event.time ? ' a las ' + event.time : ''})\n`;
                });
            }
            
            return context;
        }
        
        function processAIActions(message) {
            const actionRegex = /<ACTION>(.*?)<\/ACTION>/g;
            let match;
            let actionsFound = 0;
            
            console.log('Processing message for actions:', message);
            
            while ((match = actionRegex.exec(message)) !== null) {
                actionsFound++;
                console.log(`Found action ${actionsFound}:`, match[1]);
                
                try {
                    const action = JSON.parse(match[1]);
                    console.log('Parsed action:', action);
                    
                    if (action.type === 'create_task') {
                        console.log('Creating task...');
                        createTaskFromAI(action.data);
                    } else if (action.type === 'create_event') {
                        console.log('Creating event...');
                        createEventFromAI(action.data);
                    } else if (action.type === 'create_course') {
                        console.log('Creating course...');
                        createCourseFromAI(action.data);
                    } else if (action.type === 'upload_material') {
                        console.log('Uploading material...');
                        uploadMaterialFromAI(action.data);
                    }
                } catch (error) {
                    console.error('Error processing action:', error, 'Raw:', match[1]);
                }
            }
            
            console.log(`Total actions found: ${actionsFound}`);
        }
        
        function createTaskFromAI(data) {
            const task = {
                id: 'task_' + Date.now(),
                title: data.title,
                description: data.description || '',
                subject: data.subject || '',
                dueDate: data.dueDate,
                priority: data.priority || 'medium',
                status: data.status || 'pending',
                createdAt: new Date().toISOString()
            };
            
            tasks.push(task);
            localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
            renderTasks();
            renderCalendar();
            updateDashboardStats();
            
            showNotification(`‚úÖ Tarea "${task.title}" creada correctamente`, 'success');
        }
        
        function createEventFromAI(data) {
            const event = {
                id: 'evt_' + Date.now(),
                title: data.title,
                description: data.description || '',
                date: data.date,
                time: data.time || '',
                eventType: data.eventType || 'event',
                color: data.color || 'blue',
                createdAt: new Date().toISOString()
            };
            
            events.push(event);
            localStorage.setItem(EVENTS_KEY, JSON.stringify(events));
            renderCalendar();
            
            showNotification(`‚úÖ Evento "${event.title}" creado correctamente`, 'success');
        }
        
        function createCourseFromAI(data) {
            const course = {
                id: 'course_' + Date.now(),
                name: data.name,
                code: data.code || '',
                description: data.description || '',
                teacher: data.teacher || '',
                credits: data.credits || '',
                color: data.color || 'blue',
                createdAt: new Date().toISOString()
            };
            
            courses.push(course);
            localStorage.setItem(COURSES_KEY, JSON.stringify(courses));
            renderCourses();
            
            showNotification(`‚úÖ Curso "${course.name}" creado correctamente`, 'success');
        }
        
        function uploadMaterialFromAI(data) {
            // Find the course by name
            const course = courses.find(c => c.name.toLowerCase() === data.courseName.toLowerCase());
            
            if (!course) {
                showNotification(`‚ùå No se encontr√≥ el curso "${data.courseName}". Por favor, cr√©alo primero.`, 'error');
                return;
            }
            
            const material = {
                id: 'material_' + Date.now(),
                courseId: course.id,
                title: data.title,
                description: data.description || '',
                type: data.type || 'link',
                link: data.link || '',
                createdAt: new Date().toISOString()
            };
            
            materials.push(material);
            localStorage.setItem(MATERIALS_KEY, JSON.stringify(materials));
            
            // Update UI if user is viewing this course
            if (currentCourseId === course.id) {
                renderMaterials();
            }
            renderCourses();
            
            showNotification(`‚úÖ Material "${material.title}" subido al curso "${course.name}"`, 'success');
        }
        
        function showTypingIndicator() {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            const id = 'typing_' + Date.now();
            div.id = id;
            div.className = 'bg-gray-100 rounded-xl p-4 max-w-[90%] md:max-w-[80%] mb-3';
            div.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas fa-robot text-blue-500"></i>
                    <span class="font-semibold text-sm">Claude</span>
                </div>
                <div class="flex gap-1 mt-2">
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }
        
        function removeTypingIndicator(id) {
            const indicator = document.getElementById(id);
            if (indicator) indicator.remove();
        }
        
        function sendQuickMessage(msg) {
            document.getElementById('chatInput').value = msg;
            sendMessage();
        }
        
        function addChatMessage(msg, sender) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `${sender === 'user' ? 'bg-blue-500 text-white ml-auto' : 'bg-gradient-to-r from-blue-50 to-purple-50'} rounded-xl p-4 max-w-[90%] md:max-w-[80%] mb-3`;
            
            if (sender === 'ai') {
                // Format markdown-style text
                const formattedMsg = msg
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>')
                    .replace(/- (.*?)(<br>|$)/g, '‚Ä¢ $1$2');
                
                div.innerHTML = `
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-robot text-blue-500"></i>
                        <span class="font-semibold text-sm">Claude</span>
                    </div>
                    <div>${formattedMsg}</div>
                    <div class="text-[11px] text-gray-400 mt-2">${new Date().toLocaleTimeString('es-ES')}</div>
                `;
            } else {
                div.innerHTML = `
                    <div>${msg}</div>
                    <div class="text-[11px] text-blue-100 mt-2">${new Date().toLocaleTimeString('es-ES')}</div>
                `;
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        function clearChat() {
            if (confirm('¬øLimpiar todo el historial del chat?')) {
                chatHistory = [];
                localStorage.removeItem(CHAT_HISTORY_KEY);
                const container = document.getElementById('chatMessages');
                container.innerHTML = `
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-4 max-w-[90%] md:max-w-[80%]">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-robot text-blue-500"></i>
                            <span class="font-semibold text-sm">Claude</span>
                        </div>
                        <p class="mb-4">Chat limpiado. ¬øEn qu√© puedo ayudarte?</p>
                        <div class="text-[11px] text-gray-400 mt-3">${new Date().toLocaleTimeString('es-ES')}</div>
                    </div>
                `;
                showNotification('Chat limpiado correctamente', 'success');
            }
        }
        
        // HORARIO SEMANAL SYSTEM
        const SCHEDULE_KEY = 'rayan_schedule';
        
        // Pre-cargar horario completo si no existe
        // HORARIO VAC√çO - El usuario lo rellenar√° manualmente
        const defaultSchedule = [];
        
        let schedule = JSON.parse(localStorage.getItem(SCHEDULE_KEY)) || [];
        
        // Si el horario est√° vac√≠o, cargar el horario por defecto (vac√≠o en este caso)
        if (schedule.length === 0) {
            schedule = defaultSchedule;
            localStorage.setItem(SCHEDULE_KEY, JSON.stringify(defaultSchedule));
        }
        if (schedule.length === 0) {
            schedule = defaultSchedule;
            localStorage.setItem(SCHEDULE_KEY, JSON.stringify(defaultSchedule));
        }
        
        let editingScheduleId = null;
        let currentScheduleView = 'week';
        
        const TIME_SLOTS = [
            '08:15', '09:10', '10:05', '11:00', '11:20', 
            '12:15', '13:10', '13:30', '14:25', '15:20'
        ];
        
        function renderSchedule() {
            if (currentScheduleView === 'week') {
                renderWeekSchedule();
            } else {
                renderTodaySchedule();
            }
            
            // Show/hide empty state
            const emptyState = document.getElementById('scheduleEmptyState');
            if (schedule.length === 0 && emptyState) {
                emptyState.style.display = 'block';
                document.getElementById('scheduleWeekView').style.display = 'none';
                document.getElementById('scheduleTodayView').style.display = 'none';
            } else if (emptyState) {
                emptyState.style.display = 'none';
            }
        }
        
        function renderWeekSchedule() {
            const tbody = document.getElementById('scheduleTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            TIME_SLOTS.forEach(time => {
                const row = document.createElement('tr');
                row.className = 'border-t border-gray-200';
                
                // Time cell
                const timeCell = document.createElement('td');
                timeCell.className = 'px-4 py-3 text-sm font-medium text-gray-700 bg-gray-50';
                timeCell.textContent = time;
                row.appendChild(timeCell);
                
                // Day cells (1=Monday to 5=Friday only)
                [1, 2, 3, 4, 5].forEach(day => {
                    const cell = document.createElement('td');
                    cell.className = 'px-2 py-2 border-l border-gray-100 relative';
                    
                    const classesInSlot = schedule.filter(s => {
                        return s.day === day && s.startTime === time;
                    });
                    
                    classesInSlot.forEach(classItem => {
                        const colorClasses = {
                            'red-light': 'bg-red-100 text-red-700 border-red-300',
                            'red-dark': 'bg-red-200 text-red-800 border-red-400',
                            'blue-light': 'bg-blue-100 text-blue-700 border-blue-300',
                            'blue-dark': 'bg-blue-200 text-blue-800 border-blue-400',
                            'green-light': 'bg-green-100 text-green-700 border-green-300',
                            'green-dark': 'bg-green-200 text-green-800 border-green-400',
                            'yellow-light': 'bg-yellow-100 text-yellow-700 border-yellow-300',
                            'yellow-dark': 'bg-yellow-200 text-yellow-800 border-yellow-400',
                            'orange-light': 'bg-orange-100 text-orange-700 border-orange-300',
                            'orange-dark': 'bg-orange-200 text-orange-800 border-orange-400',
                            'gray-light': 'bg-gray-100 text-gray-700 border-gray-300',
                            'gray-dark': 'bg-gray-200 text-gray-800 border-gray-400'
                        };
                        
                        const classDiv = document.createElement('div');
                        classDiv.className = `${colorClasses[classItem.color] || colorClasses['blue-light']} p-2 rounded-lg border text-xs mb-1 cursor-pointer hover:shadow-md transition`;
                        classDiv.onclick = () => editScheduleItem(classItem.id);
                        classDiv.innerHTML = `
                            <div class="font-semibold truncate">${classItem.subject}</div>
                            <div class="text-[10px] opacity-80">${classItem.startTime} - ${classItem.endTime}</div>
                            ${classItem.room ? `<div class="text-[10px] opacity-70">${classItem.room}</div>` : ''}
                        `;
                        cell.appendChild(classDiv);
                    });
                    
                    row.appendChild(cell);
                });
                
                tbody.appendChild(row);
            });
        }
        
        function renderTodaySchedule() {
            const todayList = document.getElementById('todayScheduleList');
            const todayDayName = document.getElementById('todayDayName');
            if (!todayList || !todayDayName) return;
            
            const today = new Date().getDay();
            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            todayDayName.textContent = `Hoy - ${dayNames[today]}`;
            
            const todayClasses = schedule
                .filter(s => s.day === today)
                .sort((a, b) => a.startTime.localeCompare(b.startTime));
            
            if (todayClasses.length === 0) {
                todayList.innerHTML = '<p class="text-gray-600 text-center py-8">No tienes clases hoy üéâ</p>';
                return;
            }
            
            const colorClasses = {
                'red-light': 'bg-red-100 text-red-700 border-red-300',
                'red-dark': 'bg-red-200 text-red-800 border-red-400',
                'blue-light': 'bg-blue-100 text-blue-700 border-blue-300',
                'blue-dark': 'bg-blue-200 text-blue-800 border-blue-400',
                'green-light': 'bg-green-100 text-green-700 border-green-300',
                'green-dark': 'bg-green-200 text-green-800 border-green-400',
                'yellow-light': 'bg-yellow-100 text-yellow-700 border-yellow-300',
                'yellow-dark': 'bg-yellow-200 text-yellow-800 border-yellow-400',
                'orange-light': 'bg-orange-100 text-orange-700 border-orange-300',
                'orange-dark': 'bg-orange-200 text-orange-800 border-orange-400',
                'gray-light': 'bg-gray-100 text-gray-700 border-gray-300',
                'gray-dark': 'bg-gray-200 text-gray-800 border-gray-400'
            };
            
            todayList.innerHTML = todayClasses.map(classItem => `
                <div class="${colorClasses[classItem.color] || colorClasses['blue-light']} p-4 rounded-lg border cursor-pointer hover:shadow-md transition" onclick="editScheduleItem('${classItem.id}')">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-semibold text-lg">${classItem.subject}</h4>
                        <span class="text-sm font-medium">${classItem.startTime} - ${classItem.endTime}</span>
                    </div>
                    ${classItem.teacher ? `<p class="text-sm mb-1"><i class="fas fa-user-tie mr-2"></i>${classItem.teacher}</p>` : ''}
                    ${classItem.room ? `<p class="text-sm"><i class="fas fa-door-open mr-2"></i>${classItem.room}</p>` : ''}
                </div>
            `).join('');
        }
        
        function changeScheduleView(view) {
            currentScheduleView = view;
            
            const weekView = document.getElementById('scheduleWeekView');
            const todayView = document.getElementById('scheduleTodayView');
            const weekBtn = document.getElementById('viewWeekBtn');
            const todayBtn = document.getElementById('viewTodayBtn');
            
            if (view === 'week') {
                weekView.style.display = 'block';
                todayView.style.display = 'none';
                weekBtn.className = 'px-4 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition';
                todayBtn.className = 'px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition';
                renderWeekSchedule();
            } else {
                weekView.style.display = 'none';
                todayView.style.display = 'block';
                weekBtn.className = 'px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition';
                todayBtn.className = 'px-4 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition';
                renderTodaySchedule();
            }
        }
        
        function openScheduleModal(scheduleId = null) {
            editingScheduleId = scheduleId;
            const modal = document.getElementById('scheduleModal');
            const modalTitle = document.getElementById('scheduleModalTitle');
            const deleteBtn = document.getElementById('deleteScheduleBtn');
            
            if (scheduleId) {
                const item = schedule.find(s => s.id === scheduleId);
                if (item) {
                    modalTitle.textContent = 'Editar Clase';
                    document.getElementById('scheduleSubject').value = item.subject;
                    document.getElementById('scheduleDay').value = item.day;
                    document.getElementById('scheduleStartTime').value = item.startTime;
                    document.getElementById('scheduleEndTime').value = item.endTime;
                    document.getElementById('scheduleTeacher').value = item.teacher || '';
                    document.getElementById('scheduleRoom').value = item.room || '';
                    document.querySelector(`input[name="scheduleColor"][value="${item.color}"]`).checked = true;
                    if (deleteBtn) deleteBtn.style.display = 'block';
                }
            } else {
                modalTitle.textContent = 'A√±adir Clase';
                document.getElementById('scheduleSubject').value = '';
                document.getElementById('scheduleDay').value = '';
                document.getElementById('scheduleStartTime').value = '';
                document.getElementById('scheduleEndTime').value = '';
                document.getElementById('scheduleTeacher').value = '';
                document.getElementById('scheduleRoom').value = '';
                document.querySelector('input[name="scheduleColor"][value="blue-light"]').checked = true;
                if (deleteBtn) deleteBtn.style.display = 'none';
            }
            
            modal.style.display = 'flex';
        }
        
        function closeScheduleModal() {
            document.getElementById('scheduleModal').style.display = 'none';
            editingScheduleId = null;
        }
        
        function editScheduleItem(scheduleId) {
            openScheduleModal(scheduleId);
        }
        
        function saveScheduleItem(e) {
            const subject = document.getElementById('scheduleSubject').value;
            const day = document.getElementById('scheduleDay').value;
            const startTime = document.getElementById('scheduleStartTime').value;
            const endTime = document.getElementById('scheduleEndTime').value;
            
            // Validar campos requeridos
            if (!subject || !day || !startTime || !endTime) {
                showNotification('Por favor completa todos los campos requeridos', 'error');
                return;
            }
            
            const dayInt = parseInt(day);
            const teacher = document.getElementById('scheduleTeacher').value;
            const room = document.getElementById('scheduleRoom').value;
            const color = document.querySelector('input[name="scheduleColor"]:checked').value;
            
            if (editingScheduleId) {
                const index = schedule.findIndex(s => s.id === editingScheduleId);
                if (index !== -1) {
                    schedule[index] = {
                        ...schedule[index],
                        subject,
                        day: dayInt,
                        startTime,
                        endTime,
                        teacher,
                        room,
                        color
                    };
                    saveToFirebase('schedule', schedule[index]); // Guardar en Firebase
                }
            } else {
                const newClass = {
                    id: 'schedule_' + Date.now(),
                    subject,
                    day: dayInt,
                    startTime,
                    endTime,
                    teacher,
                    room,
                    color,
                    createdAt: new Date().toISOString()
                };
                schedule.push(newClass);
                saveToFirebase('schedule', newClass); // Guardar en Firebase
            }
            
            // Solo guardar en Firebase (NO localStorage)
            closeScheduleModal();
            renderSchedule();
            showNotification(editingScheduleId ? 'Clase actualizada' : 'Clase a√±adida', 'success');
        }
        
        function deleteScheduleItem(scheduleId) {
            if (confirm('¬øEliminar esta clase del horario?')) {
                schedule = schedule.filter(s => s.id !== scheduleId);
                // Solo eliminar de Firebase (NO localStorage)
                deleteFromFirebase('schedule', scheduleId); // Eliminar de Firebase
                renderSchedule();
                closeScheduleModal();
                showNotification('Clase eliminada', 'success');
            }
        }
        
        // ORGANIZADOR INTELIGENTE - Command Parser
        const REMINDERS_KEY = 'rayan_reminders'; // Preparado para futura funcionalidad
        let reminders = JSON.parse(localStorage.getItem(REMINDERS_KEY)) || [];
        
        function insertarPlantilla(tipo) {
            const input = document.getElementById('organizadorInput');
            const plantillas = {
                'tareas': `- Crear tarea: Estudiar para el examen, fecha: viernes, prioridad: alta
- Tarea: Hacer ejercicios de matem√°ticas, para ma√±ana, prioridad media
- A√±adir tarea urgente: Terminar proyecto de ciencias para el lunes`,
                'examenes': `- Examen de Matem√°ticas el 15/12/2025 a las 10:00
- Examen de F√≠sica el 20/12/2025 a las 12:00  
- Parcial de Historia el pr√≥ximo viernes`,
                'curso': `- Crear curso de Programaci√≥n con el profesor Garc√≠a, 6 cr√©ditos
- A√±adir materia de Bases de Datos
- Curso: Inteligencia Artificial, c√≥digo: IA-301`
            };
            input.value = plantillas[tipo] || '';
        }
        
        function limpiarOrganizador() {
            document.getElementById('organizadorInput').value = '';
            document.getElementById('organizadorResultados').style.display = 'none';
        }
        
        function procesarComandos() {
            const input = document.getElementById('organizadorInput').value;
            
            if (!input.trim()) {
                showNotification('Escribe algunos comandos primero', 'error');
                return;
            }
            
            // Split por bullets o saltos de l√≠nea
            const lineas = input.split(/\n+/).map(l => l.trim()).filter(l => l.length > 0);
            
            const resultados = [];
            let tareasCreadas = 0;
            let eventosCreados = 0;
            let cursosCreados = 0;
            let materialesSubidos = 0;
            let recordatoriosCreados = 0;
            
            lineas.forEach(linea => {
                // Limpiar bullets
                linea = linea.replace(/^[-*‚Ä¢]\s*/, '');
                
                const resultado = procesarLineaComando(linea);
                if (resultado) {
                    resultados.push(resultado);
                    
                    if (resultado.tipo === 'tarea') tareasCreadas++;
                    else if (resultado.tipo === 'evento') eventosCreados++;
                    else if (resultado.tipo === 'curso') cursosCreados++;
                    else if (resultado.tipo === 'material') materialesSubidos++;
                    else if (resultado.tipo === 'recordatorio') recordatoriosCreados++;
                }
            });
            
            // Mostrar resultados
            mostrarResultadosOrganizador(resultados, {
                tareas: tareasCreadas,
                eventos: eventosCreados,
                cursos: cursosCreados,
                materiales: materialesSubidos,
                recordatorios: recordatoriosCreados
            });
            
            // Update UIs
            renderTasks();
            renderCalendar();
            renderCourses();
            updateDashboardStats();
            
            // Success notification
            const total = tareasCreadas + eventosCreados + cursosCreados + materialesSubidos + recordatoriosCreados;
            showNotification(`‚úÖ ${total} acci√≥n(es) ejecutada(s) correctamente`, 'success');
        }
        
        function procesarLineaComando(linea) {
            const lineaLower = linea.toLowerCase();
            
            // DETECTAR TIPO DE COMANDO (orden importa - de m√°s espec√≠fico a menos espec√≠fico)
            
            // 1. CREAR TAREA (tiene m√°xima prioridad)
            if (lineaLower.includes('tarea') || lineaLower.includes('task')) {
                return crearTareaDesdeComando(linea, lineaLower);
            }
            
            // 2. CREAR EVENTO/EXAMEN (solo si NO menciona "tarea")
            if (lineaLower.includes('examen') || lineaLower.includes('evento') || 
                lineaLower.includes('reuni√≥n') || lineaLower.includes('reunion') ||
                lineaLower.includes('clase') || lineaLower.includes('parcial')) {
                return crearEventoDesdeComando(linea, lineaLower);
            }
            
            // 3. CREAR CURSO
            if (lineaLower.includes('curso') || lineaLower.includes('materia') || lineaLower.includes('asignatura')) {
                return crearCursoDesdeComando(linea, lineaLower);
            }
            
            // 4. SUBIR MATERIAL
            if (lineaLower.includes('subir') || lineaLower.includes('material') || lineaLower.includes('http')) {
                return subirMaterialDesdeComando(linea, lineaLower);
            }
            
            // 5. RECORDATORIO (preparado para el futuro)
            if (lineaLower.includes('recordatorio') || lineaLower.includes('recordar') || lineaLower.includes('aviso')) {
                return crearRecordatorioDesdeComando(linea, lineaLower);
            }
            
            return null;
        }
        
        function crearTareaDesdeComando(linea, lineaLower) {
            // Extraer t√≠tulo - prioridad a comillas y "que se llame"
            let titulo = '';
            
            // Patron 1: Entre comillas
            const quotesMatch = linea.match(/["']([^"']+)["']/);
            if (quotesMatch) {
                titulo = quotesMatch[1];
            } 
            // Patron 2: "que se llame X"
            else if (lineaLower.includes('que se llame') || lineaLower.includes('llamada')) {
                const llamadaMatch = linea.match(/(?:que se llame|llamada)\s+["']?([^"',]+?)["']?(?:\s|,|para|$)/i);
                if (llamadaMatch) {
                    titulo = llamadaMatch[1].trim();
                }
            }
            // Patron 3: Limpieza tradicional
            else {
                titulo = linea;
                titulo = titulo.replace(/^(crear|a√±adir|agregar|nueva?)\s+(tarea:?|task:?)\s*/i, '');
                titulo = titulo.replace(/,?\s*(para|fecha:?|vence:?|prioridad:?|urgente|recordatorio).*/i, '');
                titulo = titulo.trim();
            }
            
            // Si qued√≥ vac√≠o o muy corto, usar toda la l√≠nea limpia
            if (!titulo || titulo.length < 3) {
                titulo = linea.replace(/^(crear|a√±adir|agregar|nueva?)\s+(tarea:?|task:?)\s*/i, '').trim();
            }
            
            // Extraer fecha
            let dueDate = getTomorrow();
            if (lineaLower.includes('hoy')) dueDate = getToday();
            else if (lineaLower.includes('ma√±ana')) dueDate = getTomorrow();
            else if (lineaLower.includes('lunes')) dueDate = getNextDayOfWeek(1);
            else if (lineaLower.includes('martes')) dueDate = getNextDayOfWeek(2);
            else if (lineaLower.includes('mi√©rcoles') || lineaLower.includes('miercoles')) dueDate = getNextDayOfWeek(3);
            else if (lineaLower.includes('jueves')) dueDate = getNextDayOfWeek(4);
            else if (lineaLower.includes('viernes')) dueDate = getNextDayOfWeek(5);
            else if (lineaLower.includes('s√°bado') || lineaLower.includes('sabado')) dueDate = getNextDayOfWeek(6);
            else if (lineaLower.includes('domingo')) dueDate = getNextDayOfWeek(7);
            else {
                const fechaMatch = linea.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
                if (fechaMatch) {
                    dueDate = `${fechaMatch[3]}-${fechaMatch[2].padStart(2,'0')}-${fechaMatch[1].padStart(2,'0')}`;
                }
            }
            
            // Extraer prioridad
            let priority = 'medium';
            if (lineaLower.includes('urgente') || lineaLower.includes('alta') || lineaLower.includes('high')) priority = 'high';
            else if (lineaLower.includes('baja') || lineaLower.includes('low')) priority = 'low';
            
            // Extraer materia
            let subject = '';
            const materias = ['matem√°ticas', 'mates', 'f√≠sica', 'fisica', 'qu√≠mica', 'quimica', 'historia', 'literatura', 'ingl√©s', 'ingles', 'espa√±ol', 'espanol'];
            for (let mat of materias) {
                if (lineaLower.includes(mat)) {
                    subject = mat.charAt(0).toUpperCase() + mat.slice(1);
                    break;
                }
            }
            
            // Crear tarea
            const task = {
                id: 'task_' + Date.now(),
                title: titulo,
                description: '',
                subject: subject,
                dueDate: dueDate,
                priority: priority,
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            tasks.push(task);
            localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
            
            // Recordatorio si se menciona
            if (lineaLower.includes('recordatorio') || lineaLower.includes('recordar')) {
                crearRecordatorioParaTarea(task);
            }
            
            return {
                tipo: 'tarea',
                mensaje: `‚úÖ Tarea creada: "${titulo}" para ${formatDateES(dueDate)} (${priority === 'high' ? 'Alta' : priority === 'low' ? 'Baja' : 'Media'})`,
                icono: 'fa-check-square',
                color: 'text-green-600'
            };
        }
        
        function crearEventoDesdeComando(linea, lineaLower) {
            // Extraer t√≠tulo
            let titulo = linea;
            titulo = titulo.replace(/^(crear|a√±adir|agregar|nuevo)\s+(evento|examen|clase|reuni√≥n|reunion|parcial):?\s*/i, '');
            titulo = titulo.replace(/\s+(el|para|a las?|fecha:?).*$/i, '');
            titulo = titulo.trim();
            
            // Si no hay t√≠tulo expl√≠cito, usar la primera parte
            if (!titulo || titulo.length < 3) {
                const match = linea.match(/^([^,]+)/);
                if (match) titulo = match[1].trim();
            }
            
            // Extraer fecha
            let date = getTomorrow();
            const fechaMatch = linea.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
            if (fechaMatch) {
                date = `${fechaMatch[3]}-${fechaMatch[2].padStart(2,'0')}-${fechaMatch[1].padStart(2,'0')}`;
            } else if (lineaLower.includes('hoy')) {
                date = getToday();
            } else if (lineaLower.includes('ma√±ana')) {
                date = getTomorrow();
            } else if (lineaLower.includes('viernes')) {
                date = getNextDayOfWeek(5);
            }
            
            // Extraer hora
            let time = '';
            const horaMatch = linea.match(/(\d{1,2}):(\d{2})|(\d{1,2})\s*(am|pm)/i);
            if (horaMatch) {
                if (horaMatch[1]) {
                    time = `${horaMatch[1].padStart(2,'0')}:${horaMatch[2]}`;
                } else {
                    let hora = parseInt(horaMatch[3]);
                    if (horaMatch[4].toLowerCase() === 'pm' && hora < 12) hora += 12;
                    time = `${hora.toString().padStart(2,'0')}:00`;
                }
            }
            
            // Tipo de evento
            let eventType = 'event';
            if (lineaLower.includes('examen') || lineaLower.includes('parcial')) eventType = 'exam';
            else if (lineaLower.includes('clase')) eventType = 'class';
            
            // Crear evento
            const event = {
                id: 'evt_' + Date.now(),
                title: titulo,
                description: '',
                date: date,
                time: time,
                eventType: eventType,
                color: eventType === 'exam' ? 'red' : 'blue',
                createdAt: new Date().toISOString()
            };
            
            events.push(event);
            localStorage.setItem(EVENTS_KEY, JSON.stringify(events));
            
            return {
                tipo: 'evento',
                mensaje: `üìÖ Evento creado: "${titulo}" el ${formatDateES(date)}${time ? ' a las ' + time : ''}`,
                icono: 'fa-calendar',
                color: 'text-blue-600'
            };
        }
        
        function crearCursoDesdeComando(linea, lineaLower) {
            // Extraer nombre
            let nombre = linea;
            nombre = nombre.replace(/^(crear|a√±adir|agregar|nuevo|nueva)\s+(curso|materia|asignatura):?\s*(de\s+)?/i, '');
            nombre = nombre.replace(/\s+(con|profesor|prof|c√≥digo|codigo|cr√©ditos|creditos).*/i, '');
            nombre = nombre.trim();
            
            // Extraer profesor
            let teacher = '';
            const profMatch = linea.match(/(profesor|prof|teacher)\s+([A-Z√Å-√ö][a-z√°-√∫]+(?:\s+[A-Z√Å-√ö][a-z√°-√∫]+)?)/i);
            if (profMatch) teacher = profMatch[2];
            
            // Extraer c√≥digo
            let code = '';
            const codeMatch = linea.match(/(c√≥digo|codigo|code):?\s*([A-Z0-9\-]+)/i);
            if (codeMatch) code = codeMatch[2];
            
            // Extraer cr√©ditos
            let credits = '';
            const credMatch = linea.match(/(\d+)\s*(cr√©ditos|creditos|credits)/i);
            if (credMatch) credits = credMatch[1];
            
            // Crear curso
            const course = {
                id: 'course_' + Date.now(),
                name: nombre,
                code: code,
                description: '',
                teacher: teacher,
                credits: credits,
                color: 'blue',
                createdAt: new Date().toISOString()
            };
            
            courses.push(course);
            localStorage.setItem(COURSES_KEY, JSON.stringify(courses));
            
            return {
                tipo: 'curso',
                mensaje: `üìö Curso creado: "${nombre}"${teacher ? ' con ' + teacher : ''}${credits ? ' (' + credits + ' cr√©ditos)' : ''}`,
                icono: 'fa-book',
                color: 'text-purple-600'
            };
        }
        
        function subirMaterialDesdeComando(linea, lineaLower) {
            // Extraer enlace
            const linkMatch = linea.match(/(https?:\/\/[^\s]+)/i);
            if (!linkMatch) {
                return {
                    tipo: 'error',
                    mensaje: '‚ùå No se encontr√≥ enlace en el comando',
                    icono: 'fa-exclamation-triangle',
                    color: 'text-red-600'
                };
            }
            
            const link = linkMatch[1];
            
            // Extraer curso
            let courseName = null;
            const cursoMatch = linea.match(/curso\s+(?:de\s+)?["']?([^"'\n,]+?)["']?(?:\s|$|,)/i);
            if (cursoMatch) courseName = cursoMatch[1].trim();
            
            if (!courseName) {
                return {
                    tipo: 'error',
                    mensaje: '‚ùå Especifica el curso (ej: "subir [link] al curso de Matem√°ticas")',
                    icono: 'fa-exclamation-triangle',
                    color: 'text-red-600'
                };
            }
            
            // Buscar curso
            const course = courses.find(c => c.name.toLowerCase().includes(courseName.toLowerCase()));
            if (!course) {
                return {
                    tipo: 'error',
                    mensaje: `‚ùå No se encontr√≥ el curso "${courseName}"`,
                    icono: 'fa-exclamation-triangle',
                    color: 'text-red-600'
                };
            }
            
            // Extraer t√≠tulo
            let titulo = link.split('/').pop().split('?')[0] || 'Material';
            const tituloMatch = linea.match(/como\s+["']?([^"'\n]+?)["']?(?:\s+al|\s+en|$)/i);
            if (tituloMatch) titulo = tituloMatch[1].trim();
            
            // Crear material
            const material = {
                id: 'material_' + Date.now(),
                courseId: course.id,
                title: titulo,
                description: '',
                type: 'link',
                link: link,
                createdAt: new Date().toISOString()
            };
            
            materials.push(material);
            localStorage.setItem(MATERIALS_KEY, JSON.stringify(materials));
            
            return {
                tipo: 'material',
                mensaje: `üìé Material subido: "${titulo}" al curso "${course.name}"`,
                icono: 'fa-paperclip',
                color: 'text-orange-600'
            };
        }
        
        function crearRecordatorioDesdeComando(linea, lineaLower) {
            // PREPARADO PARA FUTURA IMPLEMENTACI√ìN
            // Por ahora solo registramos que se solicit√≥
            
            const recordatorio = {
                id: 'reminder_' + Date.now(),
                mensaje: linea,
                fecha: new Date().toISOString(),
                activo: true,
                // Aqu√≠ ir√°n m√°s campos cuando implementemos recordatorios
            };
            
            reminders.push(recordatorio);
            localStorage.setItem(REMINDERS_KEY, JSON.stringify(reminders));
            
            return {
                tipo: 'recordatorio',
                mensaje: `üîî Recordatorio preparado (funcionalidad pr√≥ximamente): "${linea.substring(0, 50)}..."`,
                icono: 'fa-bell',
                color: 'text-yellow-600'
            };
        }
        
        function crearRecordatorioParaTarea(task) {
            // PREPARADO: Cuando implementemos recordatorios, esto los crear√° autom√°ticamente
            const recordatorio = {
                id: 'reminder_' + Date.now(),
                tipo: 'tarea',
                tareaId: task.id,
                mensaje: `Recordatorio: ${task.title}`,
                fecha: task.dueDate,
                activo: true
            };
            
            reminders.push(recordatorio);
            localStorage.setItem(REMINDERS_KEY, JSON.stringify(reminders));
        }
        
        function mostrarResultadosOrganizador(resultados, stats) {
            const container = document.getElementById('organizadorResultadosContent');
            
            if (resultados.length === 0) {
                container.innerHTML = '<p class="text-gray-600">No se proces√≥ ning√∫n comando v√°lido.</p>';
                document.getElementById('organizadorResultados').style.display = 'block';
                return;
            }
            
            // Resumen
            let html = `<div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-4 mb-4">
                <p class="font-semibold mb-2">üìä Resumen de ejecuci√≥n:</p>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-sm">`;
            
            if (stats.tareas > 0) html += `<div class="bg-white rounded px-3 py-2"><span class="font-semibold text-green-600">${stats.tareas}</span> Tarea(s)</div>`;
            if (stats.eventos > 0) html += `<div class="bg-white rounded px-3 py-2"><span class="font-semibold text-blue-600">${stats.eventos}</span> Evento(s)</div>`;
            if (stats.cursos > 0) html += `<div class="bg-white rounded px-3 py-2"><span class="font-semibold text-purple-600">${stats.cursos}</span> Curso(s)</div>`;
            if (stats.materiales > 0) html += `<div class="bg-white rounded px-3 py-2"><span class="font-semibold text-orange-600">${stats.materiales}</span> Material(es)</div>`;
            if (stats.recordatorios > 0) html += `<div class="bg-white rounded px-3 py-2"><span class="font-semibold text-yellow-600">${stats.recordatorios}</span> Recordatorio(s)</div>`;
            
            html += `</div></div>`;
            
            // Detalle
            html += '<div class="space-y-2">';
            resultados.forEach(r => {
                html += `<div class="flex items-start gap-3 bg-gray-50 rounded-lg p-3">
                    <i class="fas ${r.icono} ${r.color} mt-1"></i>
                    <p class="text-sm text-gray-700">${r.mensaje}</p>
                </div>`;
            });
            html += '</div>';
            
            container.innerHTML = html;
            document.getElementById('organizadorResultados').style.display = 'block';
        }
        
        // Helper functions reutilizadas
        function getTomorrow() {
            const date = new Date();
            date.setDate(date.getDate() + 1);
            return date.toISOString().split('T')[0];
        }
        
        function getToday() {
            return new Date().toISOString().split('T')[0];
        }
        
        function getNextDayOfWeek(targetDay) {
            const today = new Date();
            const currentDay = today.getDay() || 7;
            const daysUntilTarget = (targetDay - currentDay + 7) % 7 || 7;
            today.setDate(today.getDate() + daysUntilTarget);
            return today.toISOString().split('T')[0];
        }
        
        function formatDateES(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const months = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
            return `${date.getDate()} ${months[date.getMonth()]}`;
        }
        
        // Grade Calculator Functions
        function switchCalculator(type) {
            document.querySelectorAll('.calculator-section').forEach(section => section.style.display = 'none');
            document.querySelectorAll('.calculator-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById('calc-' + type).style.display = 'block';
            document.getElementById('calc-' + type + '-btn').classList.add('active');
        }
        
        function calcularPromedio() {
            const input = document.getElementById('promedioNotas').value;
            if (!input.trim()) { showNotification('Por favor ingresa las notas', 'error'); return; }
            
            const notas = input.split(/[,\s]+/).map(n => parseFloat(n.replace(',', '.'))).filter(n => !isNaN(n) && n > 0);
            if (notas.length === 0) { showNotification('No se encontraron notas v√°lidas', 'error'); return; }
            
            const promedio = notas.reduce((a, b) => a + b, 0) / notas.length;
            document.getElementById('promedioValor').textContent = promedio.toFixed(2);
            document.getElementById('totalNotas').textContent = notas.length;
            document.getElementById('notaMasAlta').textContent = Math.max(...notas).toFixed(2);
            document.getElementById('notaMasBaja').textContent = Math.min(...notas).toFixed(2);
            document.getElementById('resultadoPromedio').style.display = 'block';
            showNotification('Promedio calculado', 'success');
        }
        
        // PROMEDIO PONDERADO CON GRUPOS
        let grupoIdCounter = 0;
        
        function agregarGrupoPonderado() {
            const container = document.getElementById('ponderadoGrupos');
            const grupoId = 'grupo_' + (++grupoIdCounter);
            
            const grupoDiv = document.createElement('div');
            grupoDiv.id = grupoId;
            grupoDiv.className = 'border-2 border-blue-200 rounded-lg p-4 bg-blue-50';
            grupoDiv.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3 flex-1">
                        <i class="fas fa-folder text-blue-500 text-lg"></i>
                        <input type="text" class="grupo-nombre flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white" placeholder="Nombre del grupo (ej: Ex√°menes)">
                        <input type="number" step="1" class="grupo-peso w-24 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white" placeholder="%" title="Peso del grupo">
                        <span class="text-sm text-gray-600">%</span>
                    </div>
                    <button onclick="eliminarGrupo('${grupoId}')" class="ml-3 text-red-500 hover:text-red-700 transition">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="grupo-items space-y-2 ml-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                        <input type="text" class="item-nombre px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none bg-white text-sm" placeholder="Nombre del √≠tem">
                        <input type="number" step="0.1" class="item-nota px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none bg-white text-sm" placeholder="Nota">
                        <input type="number" step="1" class="item-peso px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none bg-white text-sm" placeholder="% del grupo">
                    </div>
                </div>
                <button onclick="agregarItemAGrupo('${grupoId}')" class="mt-2 ml-8 text-green-600 hover:text-green-700 text-sm transition">
                    <i class="fas fa-plus mr-1"></i>Agregar √≠tem a este grupo
                </button>
            `;
            
            container.appendChild(grupoDiv);
        }
        
        function agregarItemAGrupo(grupoId) {
            const grupo = document.getElementById(grupoId);
            const itemsContainer = grupo.querySelector('.grupo-items');
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'grid grid-cols-1 md:grid-cols-3 gap-2';
            itemDiv.innerHTML = `
                <input type="text" class="item-nombre px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none bg-white text-sm" placeholder="Nombre del √≠tem">
                <input type="number" step="0.1" class="item-nota px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none bg-white text-sm" placeholder="Nota">
                <div class="flex gap-2">
                    <input type="number" step="1" class="item-peso flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none bg-white text-sm" placeholder="% del grupo">
                    <button onclick="this.parentElement.parentElement.remove()" class="text-red-500 hover:text-red-700 px-2">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            itemsContainer.appendChild(itemDiv);
        }
        
        function eliminarGrupo(grupoId) {
            if (confirm('¬øEliminar este grupo?')) {
                document.getElementById(grupoId).remove();
            }
        }
        
        function limpiarPonderado() {
            if (confirm('¬øLimpiar todos los grupos?')) {
                document.getElementById('ponderadoGrupos').innerHTML = '';
                document.getElementById('resultadoPonderado').style.display = 'none';
                grupoIdCounter = 0; // Reset counter
                showNotification('Grupos limpiados', 'success');
            }
        }
        
        function calcularPonderado() {
            const grupos = document.querySelectorAll('#ponderadoGrupos > div');
            
            if (grupos.length === 0) {
                showNotification('Agrega al menos un grupo', 'error');
                return;
            }
            
            let notaFinal = 0;
            let pesoTotalGrupos = 0;
            const detalles = [];
            
            grupos.forEach((grupo, idx) => {
                const nombreGrupo = grupo.querySelector('.grupo-nombre').value || `Grupo ${idx + 1}`;
                const pesoGrupo = parseFloat(grupo.querySelector('.grupo-peso').value);
                
                if (isNaN(pesoGrupo) || pesoGrupo <= 0) return;
                
                const items = grupo.querySelectorAll('.grupo-items > div');
                let sumaNotasGrupo = 0;
                let sumaPesosGrupo = 0;
                let itemsValidos = 0;
                
                items.forEach(item => {
                    const nota = parseFloat(item.querySelector('.item-nota').value);
                    const pesoItem = parseFloat(item.querySelector('.item-peso').value);
                    
                    if (!isNaN(nota) && !isNaN(pesoItem) && nota > 0 && pesoItem > 0) {
                        sumaNotasGrupo += nota * pesoItem;
                        sumaPesosGrupo += pesoItem;
                        itemsValidos++;
                    }
                });
                
                if (itemsValidos > 0) {
                    const promedioGrupo = sumaNotasGrupo / sumaPesosGrupo;
                    notaFinal += promedioGrupo * pesoGrupo;
                    pesoTotalGrupos += pesoGrupo;
                    
                    detalles.push({
                        nombre: nombreGrupo,
                        promedio: promedioGrupo.toFixed(2),
                        peso: pesoGrupo,
                        pesosInternos: sumaPesosGrupo
                    });
                }
            });
            
            if (pesoTotalGrupos === 0) {
                showNotification('No hay grupos v√°lidos con √≠tems', 'error');
                return;
            }
            
            const promedioFinal = notaFinal / pesoTotalGrupos;
            
            // Mostrar resultado
            document.getElementById('ponderadoValor').textContent = promedioFinal.toFixed(2);
            document.getElementById('pesoTotal').textContent = pesoTotalGrupos.toFixed(0) + '%';
            
            // Mostrar detalles de cada grupo
            const detallesDiv = document.getElementById('ponderadoDetalles');
            detallesDiv.innerHTML = '<p class="font-semibold mb-2">Detalles por grupo:</p>';
            detalles.forEach(d => {
                const warning = d.pesosInternos !== 100 ? ` <span class="text-orange-600">(√≠tems: ${d.pesosInternos.toFixed(0)}%)</span>` : '';
                detallesDiv.innerHTML += `<p class="text-gray-700">‚Ä¢ <strong>${d.nombre}</strong>: ${d.promedio} (${d.peso}% del total)${warning}</p>`;
            });
            
            // Warning del peso total
            const warning = document.getElementById('pesoWarning');
            if (pesoTotalGrupos < 100) {
                warning.textContent = `‚ö†Ô∏è Falta ${(100 - pesoTotalGrupos).toFixed(0)}% del peso total`;
                warning.className = 'text-xs text-orange-600 mt-1';
            } else if (pesoTotalGrupos > 100) {
                warning.textContent = `‚ö†Ô∏è El peso total excede 100% por ${(pesoTotalGrupos - 100).toFixed(0)}%`;
                warning.className = 'text-xs text-red-600 mt-1';
            } else {
                warning.textContent = '‚úì Peso total completo (100%)';
                warning.className = 'text-xs text-green-600 mt-1';
            }
            
            document.getElementById('resultadoPonderado').style.display = 'block';
            showNotification('Promedio ponderado calculado', 'success');
        }
        
        function calcularProyeccion() {
            const actual = parseFloat(document.getElementById('proyeccionActual').value);
            const pesoActual = parseFloat(document.getElementById('proyeccionPesoActual').value);
            const futuro = parseFloat(document.getElementById('proyeccionFuturo').value);
            const pesoFuturo = parseFloat(document.getElementById('proyeccionPesoFuturo').value);
            
            if (isNaN(actual) || isNaN(pesoActual) || isNaN(futuro) || isNaN(pesoFuturo)) {
                showNotification('Completa todos los campos', 'error'); return;
            }
            if (pesoActual + pesoFuturo !== 100) {
                showNotification('Los pesos deben sumar 100%', 'error'); return;
            }
            
            const proyeccion = (actual * pesoActual + futuro * pesoFuturo) / 100;
            document.getElementById('proyeccionValor').textContent = proyeccion.toFixed(2);
            
            let mensaje = proyeccion >= 9 ? 'üéâ ¬°Excelente!' : proyeccion >= 7 ? '‚úÖ Buena proyecci√≥n' : proyeccion >= 5 ? '‚ö†Ô∏è Justa' : 'üî¥ Baja';
            document.getElementById('proyeccionConsejos').textContent = mensaje;
            document.getElementById('resultadoProyeccion').style.display = 'block';
            showNotification('Proyecci√≥n calculada', 'success');
        }
        
        function calcularNecesito() {
            const actual = parseFloat(document.getElementById('necesitoActual').value);
            const pesoActual = parseFloat(document.getElementById('necesitoPesoActual').value);
            const objetivo = parseFloat(document.getElementById('necesitoObjetivo').value);
            const pesoFaltante = parseFloat(document.getElementById('necesitoPesoFaltante').value);
            
            if (isNaN(actual) || isNaN(pesoActual) || isNaN(objetivo) || isNaN(pesoFaltante)) {
                showNotification('Completa todos los campos', 'error'); return;
            }
            if (pesoActual + pesoFaltante !== 100) {
                showNotification('Los pesos deben sumar 100%', 'error'); return;
            }
            
            const necesito = (objetivo * 100 - actual * pesoActual) / pesoFaltante;
            document.getElementById('necesitoValor').textContent = necesito.toFixed(2);
            
            let mensaje = necesito > 10 ? '‚ùå Imposible (>10)' : necesito >= 9.5 ? 'üî¥ Muy dif√≠cil' : necesito >= 8 ? '‚ö†Ô∏è Dif√≠cil' : necesito >= 6 ? '‚úÖ Alcanzable' : necesito >= 0 ? 'üòä F√°cil' : 'üéä Ya alcanzado';
            document.getElementById('necesitoAnalisis').textContent = mensaje;
            document.getElementById('resultadoNecesito').style.display = 'block';
            showNotification('Calculado', 'success');
        }
        
        // Logout function
        async function enableNotifications() {
            const granted = await requestNotificationPermission();
            
            if (granted) {
                showNotification('¬°Notificaciones activadas! üéâ', 'success');
                sendNotification('Rayan - Notificaciones Activadas', {
                    body: 'Ahora recibir√°s recordatorios de tus tareas y eventos',
                    icon: 'icon-192.png'
                });
            } else {
                showNotification('No se pudieron activar las notificaciones', 'error');
            }
        }
        
        function handleLogout() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                localStorage.removeItem(CURRENT_USER_KEY);
                currentUser = { name: 'Usuario', email: 'user@rayan.com' };
                localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser));
                document.getElementById('userName').textContent = currentUser.name;
                alert('Sesi√≥n cerrada. Se ha creado un usuario temporal.');
                navigateTo('dashboard');
            }
        }
        
        // Google Integration System
        const GOOGLE_CONFIG_KEY = 'rayan_google_config';
        const GOOGLE_TOKEN_KEY = 'rayan_google_token';
        const GOOGLE_DATA_KEY = 'rayan_google_data';
        
        // Google API Scopes
        const SCOPES = [
            'https://www.googleapis.com/auth/classroom.courses.readonly',
            'https://www.googleapis.com/auth/classroom.coursework.me.readonly',
            'https://www.googleapis.com/auth/calendar.readonly',
            'https://www.googleapis.com/auth/userinfo.email',
            'https://www.googleapis.com/auth/userinfo.profile'
        ].join(' ');
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        
        // Initialize Google APIs
        function gapiLoaded() {
            if (typeof gapi === 'undefined') {
                console.log('Esperando a que gapi se cargue...');
                setTimeout(gapiLoaded, 100);
                return;
            }
            
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        discoveryDocs: [
                            'https://www.googleapis.com/discovery/v1/apis/classroom/v1/rest',
                            'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'
                        ]
                    });
                    gapiInited = true;
                    console.log('Google API Client inicializado');
                    maybeEnableButtons();
                } catch (error) {
                    console.error('Error inicializando gapi:', error);
                }
            });
        }
        
        function gisLoaded() {
            if (typeof google === 'undefined') {
                console.log('Esperando a que google identity se cargue...');
                setTimeout(gisLoaded, 100);
                return;
            }
            
            const savedConfig = localStorage.getItem(GOOGLE_CONFIG_KEY);
            const clientId = savedConfig ? JSON.parse(savedConfig).clientId : null;
            
            if (clientId) {
                document.getElementById('googleClientId').value = clientId;
                initializeTokenClient(clientId);
            }
            
            gisInited = true;
            console.log('Google Identity Services inicializado');
            maybeEnableButtons();
        }
        
        function initializeTokenClient(clientId) {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: clientId,
                    scope: SCOPES,
                    callback: handleAuthCallback,
                });
                console.log('Token client inicializado con Client ID:', clientId);
            } catch (error) {
                console.error('Error inicializando token client:', error);
                showNotification('Error inicializando Google OAuth: ' + error.message, 'error');
            }
        }
        
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                console.log('Todos los componentes de Google inicializados');
                checkGoogleConnection();
            }
        }
        
        function initiateGoogleSignIn() {
            console.log('Iniciando Google Sign In...');
            
            const clientId = document.getElementById('googleClientId').value.trim();
            
            if (!clientId) {
                showNotification('Por favor ingresa tu Google Client ID', 'error');
                return;
            }
            
            if (!clientId.includes('.apps.googleusercontent.com')) {
                showNotification('El Client ID no tiene el formato correcto', 'error');
                return;
            }
            
            // Check if APIs are loaded
            if (!gapiInited || !gisInited) {
                showNotification('Cargando componentes de Google... Intenta de nuevo en un momento', 'info');
                // Try to initialize again
                setTimeout(() => {
                    gapiLoaded();
                    gisLoaded();
                }, 1000);
                return;
            }
            
            // Save config
            localStorage.setItem(GOOGLE_CONFIG_KEY, JSON.stringify({ clientId }));
            
            // Initialize token client if not already done
            if (!tokenClient) {
                console.log('Inicializando token client...');
                initializeTokenClient(clientId);
                // Wait a bit for initialization
                setTimeout(() => {
                    if (tokenClient) {
                        console.log('Solicitando acceso...');
                        tokenClient.requestAccessToken({ prompt: 'consent' });
                    } else {
                        showNotification('Error: No se pudo inicializar el cliente OAuth', 'error');
                    }
                }, 500);
            } else {
                console.log('Solicitando acceso con token client existente...');
                tokenClient.requestAccessToken({ prompt: 'consent' });
            }
        }
        
        async function handleAuthCallback(response) {
            if (response.error !== undefined) {
                showNotification('Error de autenticaci√≥n: ' + response.error, 'error');
                return;
            }
            
            localStorage.setItem(GOOGLE_TOKEN_KEY, JSON.stringify({
                access_token: response.access_token,
                expires_at: Date.now() + (response.expires_in * 1000)
            }));
            
            gapi.client.setToken(response);
            showNotification('¬°Conectado con Google exitosamente!', 'success');
            
            await updateGoogleConnectionUI();
            await syncClassroom();
            await syncCalendar();
        }
        
        async function checkGoogleConnection() {
            const tokenData = localStorage.getItem(GOOGLE_TOKEN_KEY);
            
            if (!tokenData) return false;
            
            const { access_token, expires_at } = JSON.parse(tokenData);
            
            if (Date.now() >= expires_at) {
                localStorage.removeItem(GOOGLE_TOKEN_KEY);
                return false;
            }
            
            gapi.client.setToken({ access_token });
            await updateGoogleConnectionUI();
            return true;
        }
        
        async function updateGoogleConnectionUI() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        'Authorization': `Bearer ${JSON.parse(localStorage.getItem(GOOGLE_TOKEN_KEY)).access_token}`
                    }
                });
                
                const userInfo = await response.json();
                
                document.getElementById('googleConnectionStatus').style.display = 'flex';
                document.getElementById('googleUserEmail').textContent = userInfo.email;
                document.getElementById('googleSignInBtn').innerHTML = '<i class="fas fa-check mr-2"></i>Conectado';
                document.getElementById('googleSignInBtn').classList.add('bg-green-500', 'hover:bg-green-600');
                document.getElementById('googleSignInBtn').classList.remove('bg-blue-500', 'hover:bg-blue-600');
                
                document.getElementById('classroomStatus').textContent = 'Conectado';
                document.getElementById('classroomStatus').classList.remove('bg-gray-100', 'text-gray-600');
                document.getElementById('classroomStatus').classList.add('bg-green-100', 'text-green-600');
                
                document.getElementById('calendarStatus').textContent = 'Conectado';
                document.getElementById('calendarStatus').classList.remove('bg-gray-100', 'text-gray-600');
                document.getElementById('calendarStatus').classList.add('bg-green-100', 'text-green-600');
                
                document.getElementById('classroomData').style.display = 'block';
                document.getElementById('calendarData').style.display = 'block';
                
            } catch (error) {
                console.error('Error fetching user info:', error);
            }
        }
        
        async function syncClassroom() {
            if (!gapi.client || !gapi.client.classroom) {
                showNotification('Inicializando Google Classroom...', 'info');
                return;
            }
            
            try {
                showNotification('Sincronizando cursos de Classroom...', 'info');
                
                const coursesResponse = await gapi.client.classroom.courses.list({
                    pageSize: 10
                });
                
                const courses = coursesResponse.result.courses || [];
                let allCoursework = [];
                
                for (const course of courses) {
                    try {
                        const courseworkResponse = await gapi.client.classroom.courses.courseWork.list({
                            courseId: course.id,
                            pageSize: 20
                        });
                        
                        const coursework = courseworkResponse.result.courseWork || [];
                        allCoursework = allCoursework.concat(coursework.map(cw => ({
                            ...cw,
                            courseName: course.name
                        })));
                    } catch (error) {
                        console.log('No coursework for course:', course.name);
                    }
                }
                
                const googleData = JSON.parse(localStorage.getItem(GOOGLE_DATA_KEY) || '{}');
                googleData.courses = courses;
                googleData.coursework = allCoursework;
                googleData.lastSync = new Date().toISOString();
                localStorage.setItem(GOOGLE_DATA_KEY, JSON.stringify(googleData));
                
                displayClassroomCourses(courses);
                importCourseworkAsTasks(allCoursework);
                
                showNotification(`${courses.length} cursos sincronizados correctamente`, 'success');
                
            } catch (error) {
                console.error('Error syncing Classroom:', error);
                showNotification('Error al sincronizar Classroom: ' + error.message, 'error');
            }
        }
        
        function displayClassroomCourses(courses) {
            const coursesList = document.getElementById('classroomCoursesList');
            
            if (courses.length === 0) {
                coursesList.innerHTML = '<p class="text-sm text-gray-500">No se encontraron cursos</p>';
                return;
            }
            
            coursesList.innerHTML = courses.map(course => `
                <div class="flex items-center gap-2 p-2 bg-gray-50 rounded">
                    <i class="fas fa-book text-blue-500"></i>
                    <span class="text-sm text-gray-700">${course.name}</span>
                </div>
            `).join('');
        }
        
        function importCourseworkAsTasks(coursework) {
            let imported = 0;
            
            coursework.forEach(cw => {
                const existingTask = tasks.find(t => t.googleClassroomId === cw.id);
                if (existingTask) return;
                
                const task = {
                    id: 'gc_' + cw.id,
                    googleClassroomId: cw.id,
                    title: cw.title,
                    description: cw.description || '',
                    subject: cw.courseName,
                    dueDate: cw.dueDate ? formatGoogleDate(cw.dueDate) : new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    priority: 'medium',
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    source: 'Google Classroom'
                };
                
                tasks.unshift(task);
                imported++;
            });
            
            if (imported > 0) {
                localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
                renderTasks();
                updateDashboardStats();
                showNotification(`${imported} tareas importadas de Classroom`, 'success');
            }
        }
        
        function formatGoogleDate(googleDate) {
            if (!googleDate) return null;
            const year = googleDate.year;
            const month = String(googleDate.month).padStart(2, '0');
            const day = String(googleDate.day).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        async function syncCalendar() {
            if (!gapi.client || !gapi.client.calendar) {
                showNotification('Inicializando Google Calendar...', 'info');
                return;
            }
            
            try {
                showNotification('Sincronizando eventos de Calendar...', 'info');
                
                const timeMin = new Date().toISOString();
                const timeMax = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString();
                
                const response = await gapi.client.calendar.events.list({
                    calendarId: 'primary',
                    timeMin: timeMin,
                    timeMax: timeMax,
                    showDeleted: false,
                    singleEvents: true,
                    maxResults: 20,
                    orderBy: 'startTime'
                });
                
                const events = response.result.items || [];
                
                const googleData = JSON.parse(localStorage.getItem(GOOGLE_DATA_KEY) || '{}');
                googleData.events = events;
                googleData.lastCalendarSync = new Date().toISOString();
                localStorage.setItem(GOOGLE_DATA_KEY, JSON.stringify(googleData));
                
                displayCalendarEvents(events);
                showNotification(`${events.length} eventos sincronizados correctamente`, 'success');
                
            } catch (error) {
                console.error('Error syncing Calendar:', error);
                showNotification('Error al sincronizar Calendar: ' + error.message, 'error');
            }
        }
        
        function displayCalendarEvents(events) {
            const eventsList = document.getElementById('calendarEventsList');
            
            if (events.length === 0) {
                eventsList.innerHTML = '<p class="text-sm text-gray-500">No hay eventos pr√≥ximos</p>';
                return;
            }
            
            eventsList.innerHTML = events.slice(0, 5).map(event => {
                const start = event.start.dateTime || event.start.date;
                const startDate = new Date(start);
                const formattedDate = startDate.toLocaleDateString('es-ES', { 
                    month: 'short', 
                    day: 'numeric',
                    hour: event.start.dateTime ? '2-digit' : undefined,
                    minute: event.start.dateTime ? '2-digit' : undefined
                });
                
                return `
                    <div class="flex items-start gap-2 p-2 bg-gray-50 rounded">
                        <i class="fas fa-calendar-day text-blue-500 mt-1"></i>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm text-gray-700 font-medium truncate">${event.summary || 'Sin t√≠tulo'}</p>
                            <p class="text-xs text-gray-500">${formattedDate}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function disconnectGoogle() {
            if (!confirm('¬øEst√°s seguro de que quieres desconectar tu cuenta de Google? Las tareas importadas no se eliminar√°n.')) {
                return;
            }
            
            const tokenData = localStorage.getItem(GOOGLE_TOKEN_KEY);
            if (tokenData) {
                const { access_token } = JSON.parse(tokenData);
                google.accounts.oauth2.revoke(access_token);
            }
            
            localStorage.removeItem(GOOGLE_TOKEN_KEY);
            localStorage.removeItem(GOOGLE_DATA_KEY);
            
            document.getElementById('googleConnectionStatus').style.display = 'none';
            document.getElementById('googleSignInBtn').innerHTML = '<i class="fab fa-google mr-2"></i>Conectar con Google';
            document.getElementById('googleSignInBtn').classList.remove('bg-green-500', 'hover:bg-green-600');
            document.getElementById('googleSignInBtn').classList.add('bg-blue-500', 'hover:bg-blue-600');
            
            document.getElementById('classroomStatus').textContent = 'Desconectado';
            document.getElementById('classroomStatus').classList.add('bg-gray-100', 'text-gray-600');
            document.getElementById('classroomStatus').classList.remove('bg-green-100', 'text-green-600');
            
            document.getElementById('calendarStatus').textContent = 'Desconectado';
            document.getElementById('calendarStatus').classList.add('bg-gray-100', 'text-gray-600');
            document.getElementById('calendarStatus').classList.remove('bg-green-100', 'text-green-600');
            
            document.getElementById('classroomData').style.display = 'none';
            document.getElementById('calendarData').style.display = 'none';
            
            showNotification('Desconectado de Google correctamente', 'success');
        }
        
        function connectGoogle() {
            initiateGoogleSignIn();
        }
        
        // Test function to debug Google APIs
        function testGoogleAPIs() {
            const results = [];
            
            results.push('=== Estado de Google APIs ===');
            results.push(`gapi disponible: ${typeof gapi !== 'undefined' ? '‚úÖ SI' : '‚ùå NO'}`);
            results.push(`google disponible: ${typeof google !== 'undefined' ? '‚úÖ SI' : '‚ùå NO'}`);
            results.push(`google.accounts disponible: ${typeof google !== 'undefined' && google.accounts ? '‚úÖ SI' : '‚ùå NO'}`);
            results.push(`gapiInited: ${gapiInited ? '‚úÖ SI' : '‚ùå NO'}`);
            results.push(`gisInited: ${gisInited ? '‚úÖ SI' : '‚ùå NO'}`);
            results.push(`tokenClient: ${tokenClient ? '‚úÖ SI' : '‚ùå NO'}`);
            
            const clientId = document.getElementById('googleClientId').value;
            results.push(`Client ID configurado: ${clientId ? '‚úÖ SI' : '‚ùå NO'}`);
            
            if (clientId) {
                results.push(`Client ID: ${clientId.substring(0, 20)}...`);
            }
            
            alert(results.join('\n'));
            console.log('Test Results:', results);
            
            // If not initialized, try to initialize
            if (!gapiInited || !gisInited) {
                showNotification('Intentando inicializar APIs...', 'info');
                setTimeout(() => {
                    gapiLoaded();
                    gisLoaded();
                }, 100);
            }
        }
        
        // Task Management System
        const TASKS_KEY = 'rayan_tasks';
        let tasks = JSON.parse(localStorage.getItem(TASKS_KEY)) || [];
        let editingTaskId = null;
        
        // Load tasks on page load
        function loadTasks() {
            renderTasks();
            updateDashboardStats();
        }
        
        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            const emptyState = document.getElementById('tasksEmptyState');
            
            if (tasks.length === 0) {
                tasksList.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            tasksList.style.display = 'block';
            emptyState.style.display = 'none';
            
            // Apply filters
            const searchTerm = document.getElementById('searchTasks')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('filterStatus')?.value || 'all';
            const priorityFilter = document.getElementById('filterPriority')?.value || 'all';
            
            let filteredTasks = tasks.filter(task => {
                const matchesSearch = task.title.toLowerCase().includes(searchTerm) || 
                                     (task.description && task.description.toLowerCase().includes(searchTerm));
                const matchesStatus = statusFilter === 'all' || task.status === statusFilter;
                const matchesPriority = priorityFilter === 'all' || task.priority === priorityFilter;
                return matchesSearch && matchesStatus && matchesPriority;
            });
            
            if (filteredTasks.length === 0) {
                tasksList.innerHTML = '<div class="bg-white rounded-xl p-8 text-center text-gray-600">No se encontraron tareas con los filtros aplicados</div>';
                return;
            }
            
            tasksList.innerHTML = filteredTasks.map(task => {
                const priorityColors = {
                    high: 'bg-red-100 text-red-700 border-red-200',
                    medium: 'bg-yellow-100 text-yellow-700 border-yellow-200',
                    low: 'bg-green-100 text-green-700 border-green-200'
                };
                
                const statusColors = {
                    pending: 'bg-gray-100 text-gray-700',
                    in_progress: 'bg-blue-100 text-blue-700',
                    completed: 'bg-green-100 text-green-700'
                };
                
                const statusLabels = {
                    pending: 'Pendiente',
                    in_progress: 'En progreso',
                    completed: 'Completada'
                };
                
                const priorityLabels = {
                    high: 'Alta',
                    medium: 'Media',
                    low: 'Baja'
                };
                
                const isOverdue = new Date(task.dueDate) < new Date() && task.status !== 'completed';
                
                return `
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <h3 class="text-lg font-semibold ${task.status === 'completed' ? 'line-through text-gray-400' : ''}">${task.title}</h3>
                                    ${isOverdue ? '<span class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full font-medium">Vencida</span>' : ''}
                                </div>
                                ${task.description ? `<p class="text-gray-600 text-sm mb-3">${task.description}</p>` : ''}
                                <div class="flex flex-wrap gap-2">
                                    ${task.subject ? `<span class="px-3 py-1 bg-purple-100 text-purple-700 text-xs rounded-full font-medium"><i class="fas fa-book mr-1"></i>${task.subject}</span>` : ''}
                                    <span class="px-3 py-1 ${priorityColors[task.priority]} text-xs rounded-full font-medium border">${priorityLabels[task.priority]}</span>
                                    <span class="px-3 py-1 ${statusColors[task.status]} text-xs rounded-full font-medium">${statusLabels[task.status]}</span>
                                    <span class="px-3 py-1 bg-gray-100 text-gray-700 text-xs rounded-full font-medium"><i class="fas fa-calendar mr-1"></i>${formatDate(task.dueDate)}</span>
                                </div>
                            </div>
                            <div class="flex gap-2 ml-4">
                                <button onclick="toggleTaskStatus('${task.id}')" class="w-10 h-10 flex items-center justify-center rounded-lg ${task.status === 'completed' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'} transition" title="${task.status === 'completed' ? 'Marcar como pendiente' : 'Marcar como completada'}">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button onclick="editTask('${task.id}')" class="w-10 h-10 flex items-center justify-center bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteTask('${task.id}')" class="w-10 h-10 flex items-center justify-center bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function openTaskModal(taskId = null) {
            editingTaskId = taskId;
            const modal = document.getElementById('taskModal');
            const modalTitle = document.getElementById('modalTitle');
            
            if (taskId) {
                const task = tasks.find(t => t.id === taskId);
                modalTitle.textContent = 'Editar Tarea';
                document.getElementById('taskTitle').value = task.title;
                document.getElementById('taskDescription').value = task.description || '';
                document.getElementById('taskSubject').value = task.subject || '';
                document.getElementById('taskDueDate').value = task.dueDate;
                document.getElementById('taskPriority').value = task.priority;
                document.getElementById('taskStatus').value = task.status;
            } else {
                modalTitle.textContent = 'Nueva Tarea';
                document.getElementById('taskForm').reset();
                // Set default date to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('taskDueDate').value = tomorrow.toISOString().split('T')[0];
            }
            
            modal.style.display = 'flex';
        }
        
        function closeTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            document.getElementById('taskForm').reset();
            editingTaskId = null;
        }
        
        function saveTask(event) {
            event.preventDefault();
            
            const task = {
                id: editingTaskId || Date.now().toString(),
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                subject: document.getElementById('taskSubject').value,
                dueDate: document.getElementById('taskDueDate').value,
                priority: document.getElementById('taskPriority').value,
                status: document.getElementById('taskStatus').value,
                createdAt: editingTaskId ? tasks.find(t => t.id === editingTaskId).createdAt : new Date().toISOString()
            };
            
            if (editingTaskId) {
                const index = tasks.findIndex(t => t.id === editingTaskId);
                tasks[index] = task;
            } else {
                tasks.unshift(task);
            }
            
            // Solo guardar en Firebase (NO localStorage)
            saveToFirebase('tasks', task); // Guardar en Firebase
            closeTaskModal();
            renderTasks();
            updateDashboardStats();
            
            // Show success message
            const message = editingTaskId ? 'Tarea actualizada correctamente' : 'Tarea creada correctamente';
            showNotification(message, 'success');
        }
        
        function editTask(taskId) {
            openTaskModal(taskId);
        }
        
        function deleteTask(taskId) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta tarea?')) {
                tasks = tasks.filter(t => t.id !== taskId);
                // Solo eliminar de Firebase (NO localStorage)
                deleteFromFirebase('tasks', taskId); // Eliminar de Firebase
                renderTasks();
                updateDashboardStats();
                showNotification('Tarea eliminada correctamente', 'success');
            }
        }
        
        function toggleTaskStatus(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task.status === 'completed') {
                task.status = 'pending';
            } else {
                task.status = 'completed';
            }
            // Solo guardar en Firebase (NO localStorage)
            saveToFirebase('tasks', task); // Guardar en Firebase
            
            // Set filter to show only pending/in-progress by default when completing
            if (task.status === 'completed') {
                const filterStatus = document.getElementById('filterStatus');
                if (filterStatus && filterStatus.value === 'all') {
                    filterStatus.value = 'pending';
                }
            }
            
            renderTasks();
            updateDashboardStats();
            
            if (task.status === 'completed') {
                showNotification('¬°Tarea completada! üéâ', 'success');
            }
        }
        
        function filterTasks() {
            renderTasks();
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('es-ES', options);
        }
        
        function updateDashboardStats() {
            const pending = tasks.filter(t => t.status !== 'completed').length;
            const completedToday = tasks.filter(t => {
                const today = new Date().toDateString();
                return t.status === 'completed' && new Date(t.createdAt).toDateString() === today;
            }).length;
            const overdue = tasks.filter(t => {
                return new Date(t.dueDate) < new Date() && t.status !== 'completed';
            }).length;
            
            // Update top cards
            const pendingCountEl = document.getElementById('dashPendingCount');
            const pendingTextEl = document.getElementById('dashPendingText');
            if (pendingCountEl) {
                pendingCountEl.textContent = pending;
                if (pendingTextEl) {
                    if (pending === 0) {
                        pendingTextEl.textContent = '¬°Excelente! No tienes tareas pendientes';
                        pendingTextEl.className = 'text-xs text-green-600';
                    } else {
                        pendingTextEl.textContent = `Tienes ${pending} tarea${pending > 1 ? 's' : ''} por completar`;
                        pendingTextEl.className = 'text-xs text-orange-600';
                    }
                }
            }
            
            const completedCountEl = document.getElementById('dashCompletedCount');
            const completedTextEl = document.getElementById('dashCompletedText');
            if (completedCountEl) {
                completedCountEl.textContent = completedToday;
                if (completedTextEl) {
                    if (completedToday === 0) {
                        completedTextEl.textContent = 'A√∫n no has completado tareas hoy';
                    } else {
                        completedTextEl.textContent = `¬°Buen trabajo! ${completedToday} completada${completedToday > 1 ? 's' : ''} hoy`;
                        completedTextEl.className = 'text-xs text-green-600';
                    }
                }
            }
            
            const overdueCountEl = document.getElementById('dashOverdueCount');
            const overdueTextEl = document.getElementById('dashOverdueText');
            if (overdueCountEl) {
                overdueCountEl.textContent = overdue;
                if (overdueTextEl) {
                    if (overdue === 0) {
                        overdueTextEl.textContent = 'Todo al d√≠a';
                        overdueTextEl.className = 'text-xs text-green-600';
                    } else {
                        overdueTextEl.textContent = `¬°Atenci√≥n! ${overdue} tarea${overdue > 1 ? 's' : ''} vencida${overdue > 1 ? 's' : ''}`;
                        overdueTextEl.className = 'text-xs text-red-600';
                    }
                }
            }
            
            // Update high priority tasks
            const highPriorityTasks = tasks.filter(t => t.priority === 'high' && t.status !== 'completed').slice(0, 3);
            const highPriorityContainer = document.getElementById('dashHighPriorityTasks');
            if (highPriorityContainer) {
                if (highPriorityTasks.length === 0) {
                    highPriorityContainer.innerHTML = `
                        <div class="text-center py-16">
                            <i class="fas fa-check-circle text-6xl text-gray-200 mb-4"></i>
                            <h4 class="text-lg font-semibold mb-2">¬°Excelente!</h4>
                            <p class="text-gray-600">No tienes tareas de alta prioridad pendientes.</p>
                        </div>
                    `;
                } else {
                    highPriorityContainer.innerHTML = highPriorityTasks.map(task => `
                        <div class="flex items-center gap-3 p-3 bg-red-50 rounded-lg border border-red-200">
                            <i class="fas fa-exclamation-circle text-red-500"></i>
                            <div class="flex-1">
                                <p class="font-medium text-sm">${task.title}</p>
                                <p class="text-xs text-gray-600">Vence: ${formatDate(task.dueDate)}</p>
                            </div>
                        </div>
                    `).join('');
                }
            }
            
            // Update upcoming tasks
            const today = new Date();
            const in7Days = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            const upcomingTasks = tasks.filter(t => {
                const dueDate = new Date(t.dueDate);
                return t.status !== 'completed' && dueDate >= today && dueDate <= in7Days;
            }).slice(0, 3);
            
            const upcomingContainer = document.getElementById('dashUpcomingTasks');
            if (upcomingContainer) {
                if (upcomingTasks.length === 0) {
                    upcomingContainer.innerHTML = `
                        <div class="text-center py-16">
                            <i class="fas fa-calendar text-6xl text-gray-200 mb-4"></i>
                            <h4 class="text-lg font-semibold mb-2">Sin tareas pr√≥ximas</h4>
                            <p class="text-gray-600">No tienes tareas que venzan en los pr√≥ximos 7 d√≠as.</p>
                        </div>
                    `;
                } else {
                    upcomingContainer.innerHTML = upcomingTasks.map(task => {
                        const priorityColors = {high: 'red', medium: 'yellow', low: 'green'};
                        const color = priorityColors[task.priority] || 'gray';
                        return `
                            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                <i class="fas fa-circle text-${color}-500 text-xs"></i>
                                <div class="flex-1">
                                    <p class="font-medium text-sm">${task.title}</p>
                                    <p class="text-xs text-gray-600">Vence: ${formatDate(task.dueDate)}</p>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                info: 'info-circle'
            };
            
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${colors[type]} text-white font-medium`;
            notification.innerHTML = `<i class="fas fa-${icons[type]} mr-2"></i>${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Courses and Materials Management System
        const COURSES_KEY = 'rayan_courses';
        const MATERIALS_KEY = 'rayan_materials';
        let courses = JSON.parse(localStorage.getItem(COURSES_KEY)) || [];
        let materials = JSON.parse(localStorage.getItem(MATERIALS_KEY)) || [];
        let editingCourseId = null;
        let currentCourseId = null;
        let selectedFile = null;
        
        function toggleMaterialInput() {
            const type = document.getElementById('materialType').value;
            const fileSection = document.getElementById('fileUploadSection');
            const linkSection = document.getElementById('linkInputSection');
            const linkInput = document.getElementById('materialLink');
            const fileInput = document.getElementById('materialFile');
            
            if (type === 'link') {
                fileSection.style.display = 'none';
                linkSection.style.display = 'block';
                linkInput.required = true;
                fileInput.required = false;
            } else {
                fileSection.style.display = 'block';
                linkSection.style.display = 'none';
                linkInput.required = false;
                fileInput.required = true;
            }
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB in bytes
            if (file.size > maxSize) {
                showNotification('El archivo es demasiado grande. M√°ximo 10MB', 'error');
                event.target.value = '';
                return;
            }
            
            selectedFile = file;
            
            // Show preview
            const preview = document.getElementById('filePreview');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const fileIcon = document.getElementById('fileIcon');
            
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            
            // Set icon based on file type
            const extension = file.name.split('.').pop().toLowerCase();
            const iconClasses = {
                pdf: 'fa-file-pdf text-red-500',
                doc: 'fa-file-word text-blue-600',
                docx: 'fa-file-word text-blue-600',
                txt: 'fa-file-alt text-gray-500',
                jpg: 'fa-file-image text-green-500',
                jpeg: 'fa-file-image text-green-500',
                png: 'fa-file-image text-green-500',
                gif: 'fa-file-image text-green-500',
                mp4: 'fa-file-video text-purple-500',
                mp3: 'fa-file-audio text-orange-500'
            };
            
            fileIcon.className = `fas ${iconClasses[extension] || 'fa-file text-gray-500'} text-2xl`;
            preview.style.display = 'block';
            
            // Auto-fill title if empty
            const titleInput = document.getElementById('materialTitle');
            if (!titleInput.value) {
                titleInput.value = file.name.replace(/\.[^/.]+$/, ''); // Remove extension
            }
        }
        
        function clearFileSelection() {
            selectedFile = null;
            document.getElementById('materialFile').value = '';
            document.getElementById('filePreview').style.display = 'none';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        function getFileType(filename) {
            const extension = filename.split('.').pop().toLowerCase();
            const types = {
                pdf: 'pdf',
                doc: 'document',
                docx: 'document',
                txt: 'document',
                jpg: 'image',
                jpeg: 'image',
                png: 'image',
                gif: 'image',
                webp: 'image',
                mp4: 'video',
                avi: 'video',
                mov: 'video',
                mp3: 'video',
                wav: 'video'
            };
            return types[extension] || 'other';
        }
        
        function renderCourses() {
            console.log('renderCourses() llamada');
            const coursesList = document.getElementById('coursesList');
            const emptyState = document.getElementById('coursesEmptyState');
            
            console.log('coursesList:', coursesList);
            console.log('emptyState:', emptyState);
            console.log('courses.length:', courses.length);
            
            if (!coursesList || !emptyState) {
                console.error('ERROR: No se encontraron elementos coursesList o emptyState');
                return;
            }
            
            if (courses.length === 0) {
                coursesList.style.display = 'none';
                emptyState.style.display = 'block';
                updateCoursesStats();
                return;
            }
            
            coursesList.style.display = 'grid';
            emptyState.style.display = 'none';
            
            const colorClasses = {
                blue: 'bg-blue-500',
                green: 'bg-green-500',
                red: 'bg-red-500',
                yellow: 'bg-yellow-500',
                purple: 'bg-purple-500',
                pink: 'bg-pink-500'
            };
            
            coursesList.innerHTML = courses.map(course => {
                const courseMaterials = materials.filter(m => m.courseId === course.id);
                const materialsCount = courseMaterials.length;
                
                return `
                    <div class="bg-white rounded-xl p-6 border border-gray-200 hover:shadow-lg transition cursor-pointer" onclick="openCourseDetail('${course.id}')">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-12 h-12 ${colorClasses[course.color] || 'bg-blue-500'} rounded-lg flex items-center justify-center">
                                <i class="fas fa-book text-white text-xl"></i>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="event.stopPropagation(); editCourse('${course.id}')" class="text-blue-500 hover:text-blue-700" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="event.stopPropagation(); deleteCourse('${course.id}')" class="text-red-500 hover:text-red-700" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold mb-1">${course.name}</h3>
                        ${course.code ? `<p class="text-sm text-gray-500 mb-2">${course.code}</p>` : ''}
                        ${course.teacher ? `<p class="text-sm text-gray-600 mb-3"><i class="fas fa-user-tie mr-1"></i>${course.teacher}</p>` : ''}
                        <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                            <span class="text-sm text-gray-600">
                                <i class="fas fa-folder mr-1"></i>${materialsCount} material${materialsCount !== 1 ? 'es' : ''}
                            </span>
                            ${course.credits ? `<span class="text-sm text-gray-600">${course.credits} cr√©ditos</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            console.log('Cursos renderizados en HTML, innerHTML.length:', coursesList.innerHTML.length);
            console.log('coursesList.style.display:', coursesList.style.display);
            
            updateCoursesStats();
        }
        
        function updateCoursesStats() {
            const totalCoursesEl = document.getElementById('totalCoursesCount');
            const totalMaterialsEl = document.getElementById('totalMaterialsCount');
            const totalCreditsEl = document.getElementById('totalCreditsCount');
            const uploadedTodayEl = document.getElementById('uploadedTodayCount');
            
            if (totalCoursesEl) totalCoursesEl.textContent = courses.length;
            if (totalMaterialsEl) totalMaterialsEl.textContent = materials.length;
            
            const totalCredits = courses.reduce((sum, course) => sum + (parseFloat(course.credits) || 0), 0);
            if (totalCreditsEl) totalCreditsEl.textContent = totalCredits;
            
            const today = new Date().toDateString();
            const uploadedToday = materials.filter(m => new Date(m.createdAt).toDateString() === today).length;
            if (uploadedTodayEl) uploadedTodayEl.textContent = uploadedToday;
        }
        
        function openCourseModal(courseId = null) {
            editingCourseId = courseId;
            const modal = document.getElementById('courseModal');
            const modalTitle = document.getElementById('courseModalTitle');
            
            if (courseId) {
                const course = courses.find(c => c.id === courseId);
                modalTitle.textContent = 'Editar Curso';
                document.getElementById('courseName').value = course.name;
                document.getElementById('courseCode').value = course.code || '';
                document.getElementById('courseDescription').value = course.description || '';
                document.getElementById('courseTeacher').value = course.teacher || '';
                document.getElementById('courseCredits').value = course.credits || '';
                document.getElementById('courseColor').value = course.color || 'blue';
            } else {
                modalTitle.textContent = 'Nuevo Curso';
                document.getElementById('courseForm').reset();
            }
            
            modal.style.display = 'flex';
        }
        
        function closeCourseModal() {
            document.getElementById('courseModal').style.display = 'none';
            document.getElementById('courseForm').reset();
            editingCourseId = null;
        }
        
        function saveCourse(e) {
            e.preventDefault();
            
            const course = {
                id: editingCourseId || 'course_' + Date.now(),
                name: document.getElementById('courseName').value,
                code: document.getElementById('courseCode').value,
                description: document.getElementById('courseDescription').value,
                teacher: document.getElementById('courseTeacher').value,
                credits: document.getElementById('courseCredits').value,
                color: document.getElementById('courseColor').value,
                createdAt: editingCourseId ? courses.find(c => c.id === editingCourseId).createdAt : new Date().toISOString()
            };
            
            if (editingCourseId) {
                const index = courses.findIndex(c => c.id === editingCourseId);
                courses[index] = course;
            } else {
                courses.push(course);
            }
            
            // Solo guardar en Firebase (NO localStorage)
            saveToFirebase('courses', course); // Guardar en Firebase
            closeCourseModal();
            renderCourses();
            
            const message = editingCourseId ? 'Curso actualizado correctamente' : 'Curso creado correctamente';
            showNotification(message, 'success');
        }
        
        function editCourse(courseId) {
            openCourseModal(courseId);
        }
        
        function deleteCourse(courseId) {
            const course = courses.find(c => c.id === courseId);
            if (!course) return;
            
            if (confirm(`¬øEst√°s seguro de que quieres eliminar el curso "${course.name}"? Esto tambi√©n eliminar√° todos sus materiales.`)) {
                // Eliminar materiales asociados
                const courseMaterials = materials.filter(m => m.courseId === courseId);
                courseMaterials.forEach(material => {
                    deleteFromFirebase('materials', material.id);
                });
                materials = materials.filter(m => m.courseId !== courseId);
                // Solo eliminar de Firebase (NO localStorage)
                
                // Eliminar curso
                courses = courses.filter(c => c.id !== courseId);
                // Solo eliminar de Firebase (NO localStorage)
                deleteFromFirebase('courses', courseId);
                
                renderCourses();
                showNotification('Curso y sus materiales eliminados correctamente', 'success');
            }
        }
        
        function editCurrentCourse() {
            if (currentCourseId) {
                openCourseModal(currentCourseId);
            }
        }
        
        function openCourseDetail(courseId) {
            currentCourseId = courseId;
            const course = courses.find(c => c.id === courseId);
            
            if (!course) return;
            
            // Hide courses list, show detail view
            document.getElementById('coursesListView').style.display = 'none';
            document.getElementById('courseDetailView').style.display = 'block';
            
            // Update course info
            document.getElementById('courseDetailName').textContent = course.name;
            const infoText = [
                course.code,
                course.teacher ? `Profesor: ${course.teacher}` : null,
                course.credits ? `${course.credits} cr√©ditos` : null
            ].filter(Boolean).join(' ‚Ä¢ ');
            document.getElementById('courseDetailInfo').textContent = infoText;
            
            // Render materials
            renderMaterials();
        }
        
        function backToCoursesListd() {
            currentCourseId = null;
            document.getElementById('courseDetailView').style.display = 'none';
            document.getElementById('coursesListView').style.display = 'block';
        }
        
        function renderMaterials() {
            if (!currentCourseId) return;
            
            const courseMaterials = materials.filter(m => m.courseId === currentCourseId);
            const materialsList = document.getElementById('materialsList');
            const emptyState = document.getElementById('materialsEmptyState');
            
            // Update stats
            updateMaterialsStats(courseMaterials);
            
            // Apply filters
            const searchTerm = document.getElementById('searchMaterials')?.value.toLowerCase() || '';
            const typeFilter = document.getElementById('filterMaterialType')?.value || 'all';
            
            let filteredMaterials = courseMaterials.filter(material => {
                const matchesSearch = material.title.toLowerCase().includes(searchTerm) || 
                                     (material.description && material.description.toLowerCase().includes(searchTerm));
                const matchesType = typeFilter === 'all' || material.type === typeFilter;
                return matchesSearch && matchesType;
            });
            
            if (filteredMaterials.length === 0) {
                materialsList.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            materialsList.style.display = 'grid';
            emptyState.style.display = 'none';
            
            const typeIcons = {
                pdf: 'fa-file-pdf',
                image: 'fa-file-image',
                video: 'fa-file-video',
                link: 'fa-link',
                document: 'fa-file-word',
                other: 'fa-file'
            };
            
            const typeColors = {
                pdf: 'text-red-500',
                image: 'text-green-500',
                video: 'text-purple-500',
                link: 'text-blue-500',
                document: 'text-blue-600',
                other: 'text-gray-500'
            };
            
            materialsList.innerHTML = filteredMaterials.map(material => {
                const icon = typeIcons[material.type] || 'fa-file';
                const color = typeColors[material.type] || 'text-gray-500';
                const date = new Date(material.createdAt).toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                return `
                    <div class="bg-white rounded-lg p-4 border border-gray-200 hover:shadow-md transition">
                        <div class="flex items-start justify-between mb-3">
                            <i class="fas ${icon} ${color} text-3xl"></i>
                            <button onclick="deleteMaterial('${material.id}')" class="text-gray-400 hover:text-red-500">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <h4 class="font-semibold text-gray-900 mb-1">${material.title}</h4>
                        ${material.description ? `<p class="text-sm text-gray-600 mb-2">${material.description}</p>` : ''}
                        ${material.fileName ? `<p class="text-xs text-gray-500 mb-2"><i class="fas fa-file mr-1"></i>${material.fileName} (${formatFileSize(material.fileSize)})</p>` : ''}
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span><i class="fas fa-clock mr-1"></i>${date}</span>
                            ${material.link ? `<a href="${material.link}" target="_blank" class="text-blue-500 hover:underline"><i class="fas fa-external-link-alt mr-1"></i>Abrir</a>` : 
                              material.fileData ? `<button onclick="downloadMaterial('${material.id}')" class="text-blue-500 hover:underline"><i class="fas fa-download mr-1"></i>Descargar</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateMaterialsStats(courseMaterials) {
            const totalEl = document.getElementById('courseMaterialsCount');
            const pdfEl = document.getElementById('coursePDFCount');
            const imagesEl = document.getElementById('courseImagesCount');
            const videosEl = document.getElementById('courseVideosCount');
            
            if (totalEl) totalEl.textContent = courseMaterials.length;
            if (pdfEl) pdfEl.textContent = courseMaterials.filter(m => m.type === 'pdf').length;
            if (imagesEl) imagesEl.textContent = courseMaterials.filter(m => m.type === 'image').length;
            if (videosEl) videosEl.textContent = courseMaterials.filter(m => m.type === 'video').length;
        }
        
        function openMaterialModal() {
            if (!currentCourseId) {
                showNotification('Selecciona un curso primero', 'error');
                return;
            }
            
            document.getElementById('materialModal').style.display = 'flex';
        }
        
        function closeMaterialModal() {
            document.getElementById('materialModal').style.display = 'none';
            document.getElementById('materialForm').reset();
            clearFileSelection();
        }
        
        async function saveMaterial(e) {
            e.preventDefault();
            
            const type = document.getElementById('materialType').value;
            
            if (type === 'link') {
                // Save link
                const material = {
                    id: 'material_' + Date.now(),
                    courseId: currentCourseId,
                    title: document.getElementById('materialTitle').value,
                    description: document.getElementById('materialDescription').value,
                    type: 'link',
                    link: document.getElementById('materialLink').value,
                    createdAt: new Date().toISOString()
                };
                
                materials.push(material);
                // Solo guardar en Firebase (NO localStorage)
                saveToFirebase('materials', material); // Guardar en Firebase
                
                closeMaterialModal();
                renderMaterials();
                renderCourses();
                
                showNotification('Enlace guardado correctamente', 'success');
            } else {
                // Save file
                if (!selectedFile) {
                    showNotification('Por favor selecciona un archivo', 'error');
                    return;
                }
                
                // Show loading
                showNotification('Subiendo archivo...', 'info');
                
                // Convert file to base64
                const reader = new FileReader();
                reader.onload = function(event) {
                    const fileData = event.target.result;
                    
                    const material = {
                        id: 'material_' + Date.now(),
                        courseId: currentCourseId,
                        title: document.getElementById('materialTitle').value,
                        description: document.getElementById('materialDescription').value,
                        type: getFileType(selectedFile.name),
                        fileName: selectedFile.name,
                        fileSize: selectedFile.size,
                        fileData: fileData, // base64 data
                        createdAt: new Date().toISOString()
                    };
                    
                    materials.push(material);
                    
                    // Solo guardar en Firebase (NO localStorage)
                    saveToFirebase('materials', material); // Guardar en Firebase
                    
                    closeMaterialModal();
                    renderMaterials();
                    renderCourses();
                    
                    showNotification('Archivo subido correctamente', 'success');
                };
                
                reader.onerror = function() {
                    showNotification('Error al leer el archivo', 'error');
                };
                
                reader.readAsDataURL(selectedFile);
            }
        }
        
        function deleteMaterial(materialId) {
            if (confirm('¬øEliminar este material?')) {
                materials = materials.filter(m => m.id !== materialId);
                // Solo eliminar de Firebase (NO localStorage)
                deleteFromFirebase('materials', materialId); // Eliminar de Firebase
                renderMaterials();
                renderCourses();
                showNotification('Material eliminado correctamente', 'success');
            }
        }
        
        function downloadMaterial(materialId) {
            const material = materials.find(m => m.id === materialId);
            if (!material || !material.fileData) {
                showNotification('Archivo no encontrado', 'error');
                return;
            }
            
            // Create download link
            const link = document.createElement('a');
            link.href = material.fileData;
            link.download = material.fileName || 'archivo';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Descarga iniciada', 'success');
        }
        
        function filterMaterials() {
            renderMaterials();
        }
        
        // Calendar Management System
        const EVENTS_KEY = 'rayan_events';
        let events = JSON.parse(localStorage.getItem(EVENTS_KEY)) || [];
        let currentCalendarDate = new Date();
        let editingEventId = null;
        
        function renderCalendar() {
            console.log('renderCalendar() llamada, currentCalendarDate:', currentCalendarDate);
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const monthYearEl = document.getElementById('currentMonthYear');
            console.log('monthYearEl:', monthYearEl);
            if (monthYearEl) {
                monthYearEl.textContent = `${monthNames[month]} ${year}`;
            }
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            const grid = document.getElementById('calendarGrid');
            console.log('calendarGrid:', grid);
            if (!grid) {
                console.error('ERROR: No se encontr√≥ calendarGrid');
                return;
            }
            grid.innerHTML = '';
            
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
            const todayDate = today.getDate();
            
            const allCalendarItems = getCalendarItemsForMonth(year, month);
            
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const cell = createDayCell(day, true, year, month - 1, []);
                grid.appendChild(cell);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = isCurrentMonth && day === todayDate;
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayItems = allCalendarItems.filter(item => item.date === dateKey);
                const cell = createDayCell(day, false, year, month, dayItems, isToday);
                grid.appendChild(cell);
            }
            
            const totalCells = firstDay + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let day = 1; day <= remainingCells; day++) {
                const cell = createDayCell(day, true, year, month + 1, []);
                grid.appendChild(cell);
            }
            
            renderUpcomingEvents();
        }
        
        function createDayCell(day, isOtherMonth, year, month, items, isToday = false) {
            const cell = document.createElement('div');
            cell.className = `bg-white p-2 min-h-[100px] text-sm ${isOtherMonth ? 'text-gray-400' : ''} ${isToday ? 'bg-blue-50 font-semibold text-blue-600' : ''} cursor-pointer hover:bg-gray-50 transition`;
            
            const dayNumber = document.createElement('div');
            dayNumber.className = 'font-medium mb-1';
            dayNumber.textContent = day;
            cell.appendChild(dayNumber);
            
            const colorClasses = {
                blue: 'bg-blue-500',
                green: 'bg-green-500',
                red: 'bg-red-500',
                yellow: 'bg-yellow-500',
                purple: 'bg-purple-500',
                pink: 'bg-pink-500'
            };
            
            items.slice(0, 3).forEach(item => {
                const indicator = document.createElement('div');
                indicator.className = `text-[10px] ${colorClasses[item.color] || 'bg-blue-500'} text-white px-1 py-0.5 rounded mb-1 truncate`;
                indicator.textContent = item.title;
                indicator.title = item.title;
                cell.appendChild(indicator);
            });
            
            if (items.length > 3) {
                const more = document.createElement('div');
                more.className = 'text-[10px] text-gray-500 mt-1';
                more.textContent = `+${items.length - 3} m√°s`;
                cell.appendChild(more);
            }
            
            if (!isOtherMonth) {
                cell.onclick = () => {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    openEventModal(null, dateStr);
                };
            }
            
            return cell;
        }
        
        function getCalendarItemsForMonth(year, month) {
            const items = [];
            
            // Solo mostrar EVENTOS en el calendario (no tareas)
            events.forEach(event => {
                const eventDate = new Date(event.date);
                if (eventDate.getFullYear() === year && eventDate.getMonth() === month) {
                    items.push({...event, type: 'event'});
                }
            });
            
            return items;
        }
        
        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }
        
        function openEventModal(eventId = null, presetDate = null) {
            editingEventId = eventId;
            const modal = document.getElementById('eventModal');
            const modalTitle = document.getElementById('eventModalTitle');
            
            if (eventId) {
                const event = events.find(e => e.id === eventId);
                modalTitle.textContent = 'Editar Evento';
                document.getElementById('eventTitle').value = event.title;
                document.getElementById('eventDescription').value = event.description || '';
                document.getElementById('eventDate').value = event.date;
                document.getElementById('eventTime').value = event.time || '';
                document.getElementById('eventType').value = event.eventType || 'event';
                document.getElementById('eventColor').value = event.color || 'blue';
            } else {
                modalTitle.textContent = 'Nuevo Evento';
                document.getElementById('eventForm').reset();
                if (presetDate) {
                    document.getElementById('eventDate').value = presetDate;
                } else {
                    document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
                }
            }
            
            modal.style.display = 'flex';
        }
        
        function closeEventModal() {
            document.getElementById('eventModal').style.display = 'none';
            document.getElementById('eventForm').reset();
            editingEventId = null;
        }
        
        function saveEvent(e) {
            e.preventDefault();
            
            const event = {
                id: editingEventId || 'evt_' + Date.now(),
                title: document.getElementById('eventTitle').value,
                description: document.getElementById('eventDescription').value,
                date: document.getElementById('eventDate').value,
                time: document.getElementById('eventTime').value,
                eventType: document.getElementById('eventType').value,
                color: document.getElementById('eventColor').value,
                createdAt: editingEventId ? events.find(e => e.id === editingEventId).createdAt : new Date().toISOString()
            };
            
            if (editingEventId) {
                const index = events.findIndex(e => e.id === editingEventId);
                events[index] = event;
            } else {
                events.push(event);
            }
            
            // Solo guardar en Firebase (NO localStorage)
            saveToFirebase('events', event); // Guardar en Firebase
            closeEventModal();
            renderCalendar();
            
            const message = editingEventId ? 'Evento actualizado correctamente' : 'Evento creado correctamente';
            showNotification(message, 'success');
        }
        
        function renderUpcomingEvents() {
            const upcomingList = document.getElementById('upcomingEventsList');
            if (!upcomingList) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const upcoming = [];
            
            // Solo mostrar EVENTOS en la lista de pr√≥ximos (no tareas)
            events.forEach(event => {
                const eventDate = new Date(event.date);
                if (eventDate >= today) {
                    upcoming.push({...event, dateObj: eventDate, type: 'event'});
                }
            });
            
            upcoming.sort((a, b) => a.dateObj - b.dateObj);
            
            if (upcoming.length === 0) {
                upcomingList.innerHTML = '<p class="text-sm text-gray-600">No hay eventos pr√≥ximos</p>';
                return;
            }
            
            const colorClasses = {
                blue: 'bg-blue-100 text-blue-700',
                green: 'bg-green-100 text-green-700',
                red: 'bg-red-100 text-red-700',
                yellow: 'bg-yellow-100 text-yellow-700',
                purple: 'bg-purple-100 text-purple-700',
                pink: 'bg-pink-100 text-pink-700'
            };
            
            upcomingList.innerHTML = upcoming.slice(0, 10).map(item => {
                const formattedDate = formatDate(item.date);
                
                return `
                    <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg mb-2">
                        <i class="fas fa-calendar-day ${colorClasses[item.color] || 'text-blue-600'} mt-1"></i>
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">${item.title}</h4>
                            ${item.description ? `<p class="text-sm text-gray-600">${item.description}</p>` : ''}
                            <p class="text-xs text-gray-500 mt-1">
                                <i class="fas fa-clock mr-1"></i>${formattedDate}
                                ${item.time ? ` - ${item.time}` : ''}
                                <span class="ml-2 px-2 py-0.5 ${colorClasses[item.color] || 'bg-blue-100 text-blue-700'} rounded-full text-xs">
                                    Evento
                                </span>
                            </p>
                        </div>
                        <button onclick="deleteEvent('${item.id}')" class="w-8 h-8 flex items-center justify-center bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition" title="Eliminar evento">
                            <i class="fas fa-trash text-sm"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        function deleteEvent(eventId) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este evento?')) {
                events = events.filter(e => e.id !== eventId);
                // Solo eliminar de Firebase (NO localStorage)
                deleteFromFirebase('events', eventId); // Eliminar de Firebase
                renderCalendar();
                renderUpcomingEvents();
                showNotification('Evento eliminado correctamente', 'success');
            }
        }
        
        // Button handlers for various actions
        function createTask() {
            openTaskModal();
        }
        
        function createCourse() {
            openCourseModal();
        }
        
        function uploadMaterial() {
            showNotification('Por favor, primero selecciona o crea un curso', 'info');
            navigateTo('cursos');
        }
        
        function generateWithAI() {
            showNotification('Funcionalidad de generaci√≥n con IA en desarrollo', 'info');
        }
        
        function createEvent() {
            openEventModal();
        }
        
        function connectGoogle() {
            initiateGoogleSignIn();
        }
        
        function generateFlashcards() {
            navigateTo('materiales');
            setTimeout(() => {
                alert('Para generar flashcards, primero necesitas subir materiales o conectar Google Classroom.');
            }, 500);
        }
        
        function optimizeSchedule() {
            navigateTo('calendario');
            setTimeout(() => {
                alert('Para optimizar tu horario, primero necesitas agregar tus cursos y tareas.');
            }, 500);
        }
        
        function analyzeProgress() {
            navigateTo('cursos');
            setTimeout(() => {
                alert('Para analizar tu progreso, primero necesitas agregar cursos y completar algunas tareas.');
            }, 500);
        }
        
        // Variables globales de Firebase (declaradas por separado para evitar conflictos)
        let db = null;
        let auth = null;
        let currentUser = null;
        
        // Placeholder functions (se redefinir√°n cuando Firebase est√© listo)
        window.signInWithGoogle = function() {
            console.log('Esperando inicializaci√≥n de Firebase...');
        };
        
        window.signOut = function() {
            console.log('Esperando inicializaci√≥n de Firebase...');
        };
        
        // Guardar en Firebase
        window.saveToFirebase = function(collection, data) {
            console.log(`üîµ saveToFirebase llamado: collection="${collection}", id="${data.id}"`);
            
            if (!currentUser) {
                console.warn('‚ö†Ô∏è No hay currentUser, no se puede guardar en Firebase');
                return Promise.resolve();
            }
            
            if (!db) {
                console.warn('‚ö†Ô∏è No hay db, no se puede guardar en Firebase');
                return Promise.resolve();
            }
            
            console.log(`üîµ currentUser.uid: ${currentUser.uid}`);
            
            const userRef = db.collection('users').doc(currentUser.uid);
            const docRef = userRef.collection(collection).doc(data.id);
            
            return docRef.set(data, { merge: true })
                .then(() => console.log(`‚úÖ ${collection}/${data.id} guardado en Firebase`))
                .catch((error) => {
                    console.error(`‚ùå Error guardando ${collection}/${data.id}:`, error);
                    console.error(`‚ùå Error code: ${error.code}, message: ${error.message}`);
                });
        };
        
        // Eliminar de Firebase
        window.deleteFromFirebase = function(collection, docId) {
            if (!currentUser || !db) return Promise.resolve();
            
            const userRef = db.collection('users').doc(currentUser.uid);
            return userRef.collection(collection).doc(docId).delete()
                .then(() => console.log(`‚úÖ ${collection}/${docId} eliminado de Firebase`))
                .catch((error) => console.error(`‚ùå Error eliminando ${collection}:`, error));
        };
        
        // Add event listeners to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            // ========================================
            // MOBILE MENU FUNCTIONALITY - SIMPLE
            // ========================================
            const sidebar = document.querySelector('.sidebar');
            console.log('üîç Sidebar element:', sidebar);
            console.log('üîç Sidebar classList:', sidebar ? sidebar.classList : 'NO ENCONTRADO');
            
            // Funci√≥n para ABRIR sidebar
            window.openMobileSidebar = function() {
                console.log('====================================');
                console.log('üîµ ABRIR SIDEBAR - Iniciando...');
                console.log('üìç Sidebar element:', sidebar);
                console.log('üìç Sidebar classes ANTES:', sidebar.classList);
                
                sidebar.classList.add('open');
                
                // FORZAR REFLOW - Critical para que el cambio se vea
                void sidebar.offsetWidth;
                
                console.log('üìç Sidebar classes DESPU√âS:', sidebar.classList);
                console.log('üìç Sidebar computed left:', window.getComputedStyle(sidebar).left);
                console.log('‚úÖ Sidebar ABIERTO');
                console.log('====================================');
            }
            
            // Funci√≥n para CERRAR sidebar
            window.closeMobileSidebar = function() {
                console.log('====================================');
                console.log('üî¥ CERRAR SIDEBAR - Iniciando...');
                console.log('üìç Sidebar element:', sidebar);
                console.log('üìç Sidebar classes ANTES:', sidebar.classList);
                
                sidebar.classList.remove('open');
                
                // FORZAR REFLOW - Critical para que el cambio se vea
                void sidebar.offsetWidth;
                
                console.log('üìç Sidebar classes DESPU√âS:', sidebar.classList);
                console.log('üìç Sidebar computed left:', window.getComputedStyle(sidebar).left);
                console.log('‚úÖ Sidebar CERRADO');
                console.log('====================================');
            }
            
            // Toggle (para mantener compatibilidad)
            window.toggleMobileMenu = function() {
                if (sidebar.classList.contains('open')) {
                    window.closeMobileSidebar();
                } else {
                    window.openMobileSidebar();
                }
            }
            
            // Cerrar men√∫ al navegar en m√≥vil
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth < 1024) {
                        window.closeMobileSidebar();
                    }
                });
            });
            
            // Cerrar con tecla ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && sidebar.classList.contains('open')) {
                    window.closeMobileSidebar();
                }
            });
            
            // Detectar tipo de dispositivo
            function detectDevice() {
                const width = window.innerWidth;
                
                console.log('üì± Ancho de pantalla detectado:', width + 'px');
                
                if (width < 1024) {
                    // M√≥vil y tablets
                    document.body.classList.add('mobile');
                    document.body.classList.remove('desktop');
                    
                    // NO tocar estilos inline - dejar que CSS maneje todo
                } else {
                    // Desktop
                    document.body.classList.add('desktop');
                    document.body.classList.remove('mobile');
                    
                    // NO tocar estilos inline - dejar que CSS maneje todo
                }
            }
            
            detectDevice();
            window.addEventListener('resize', detectDevice);
            
            // Detectar cambios de orientaci√≥n en dispositivos plegables
            if (window.screen && window.screen.orientation) {
                window.screen.orientation.addEventListener('change', detectDevice);
            }
            
            // ========================================
            // FIREBASE INITIALIZATION
            // ========================================
            // Esperar a que Firebase est√© disponible
            function initFirebase() {
                if (typeof firebase === 'undefined') {
                    console.log('Esperando Firebase...');
                    setTimeout(initFirebase, 100);
                    return;
                }
                
                console.log('‚úÖ Firebase cargado correctamente');
                
                // CONFIGURACI√ìN FIREBASE
            const firebaseConfig = {
                apiKey: "AIzaSyBOqVtB-yzG05eBFV26Hhtc8d9Nqb3FFQI",
                authDomain: "proyectorayan.firebaseapp.com",
                projectId: "proyectorayan",
                storageBucket: "proyectorayan.firebasestorage.app",
                messagingSenderId: "357810647560",
                appId: "1:357810647560:web:c3276bbc871e9cf5ead7bd"
            };
            
            // Inicializar Firebase
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            
            // Google Sign-In
            window.signInWithGoogle = function() {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider)
                    .then((result) => {
                        currentUser = result.user;
                        console.log('‚úÖ Usuario autenticado con Google:', currentUser.displayName);
                        showNotification(`¬°Bienvenido, ${currentUser.displayName}!`, 'success');
                        
                        // Actualizar nombre en sidebar
                        document.getElementById('userName').textContent = currentUser.displayName || 'Usuario';
                        
                        // Ocultar pantalla de login
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'block';
                        
                        // Cargar datos desde Firebase
                        loadDataFromFirebase();
                        
                        // Sincronizar cambios en tiempo real
                        setupRealtimeSync();
                    })
                    .catch((error) => {
                        console.error('‚ùå Error de autenticaci√≥n:', error);
                        showNotification('Error al iniciar sesi√≥n con Google', 'error');
                    });
            }
            
            // Cerrar sesi√≥n
            window.signOut = function() {
                auth.signOut().then(() => {
                    currentUser = null;
                    document.getElementById('loginScreen').style.display = 'flex';
                    document.getElementById('mainApp').style.display = 'none';
                    showNotification('Sesi√≥n cerrada', 'success');
                });
            };
            
            // Verificar si ya est√° autenticado
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    console.log('‚úÖ Usuario ya autenticado:', user.displayName);
                    
                    // Actualizar nombre en sidebar
                    document.getElementById('userName').textContent = user.displayName || 'Usuario';
                    
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    
                    // Cargar datos desde Firebase
                    loadDataFromFirebase();
                    
                    // Sincronizar cambios en tiempo real
                    setupRealtimeSync();
                } else {
                    document.getElementById('loginScreen').style.display = 'flex';
                    document.getElementById('mainApp').style.display = 'none';
                }
            });
            
            // Cargar datos desde Firebase
            function loadDataFromFirebase() {
                if (!currentUser) return;
                
                const userRef = db.collection('users').doc(currentUser.uid);
                
                // Cargar tareas
                userRef.collection('tasks').get().then((snapshot) => {
                    if (!snapshot.empty) {
                        tasks = snapshot.docs.map(doc => ({...doc.data(), id: doc.id}));
                        // NO guardar en localStorage, Firebase es la √∫nica fuente de verdad
                        renderTasks();
                        updateDashboardStats();
                        console.log(`‚úÖ ${tasks.length} tareas cargadas desde Firebase`);
                    }
                });
                
                // Cargar eventos
                userRef.collection('events').get().then((snapshot) => {
                    if (!snapshot.empty) {
                        events = snapshot.docs.map(doc => ({...doc.data(), id: doc.id}));
                        // NO guardar en localStorage, Firebase es la √∫nica fuente de verdad
                        renderCalendar();
                        renderUpcomingEvents();
                        console.log(`‚úÖ ${events.length} eventos cargados desde Firebase`);
                    }
                });
                
                // Cargar horario
                userRef.collection('schedule').get().then((snapshot) => {
                    if (!snapshot.empty) {
                        schedule = snapshot.docs.map(doc => ({...doc.data(), id: doc.id}));
                        // NO guardar en localStorage, Firebase es la √∫nica fuente de verdad
                        renderSchedule();
                        console.log(`‚úÖ ${schedule.length} clases cargadas desde Firebase`);
                    }
                });
                
                // Cargar cursos
                userRef.collection('courses').get().then((snapshot) => {
                    if (!snapshot.empty) {
                        courses = snapshot.docs.map(doc => ({...doc.data(), id: doc.id}));
                        // NO guardar en localStorage, Firebase es la √∫nica fuente de verdad
                        renderCourses();
                        console.log(`‚úÖ ${courses.length} cursos cargados desde Firebase`);
                    }
                });
                
                // Cargar materiales
                userRef.collection('materials').get().then((snapshot) => {
                    if (!snapshot.empty) {
                        materials = snapshot.docs.map(doc => ({...doc.data(), id: doc.id}));
                        // NO guardar en localStorage, Firebase es la √∫nica fuente de verdad
                        renderMaterials();
                        console.log(`‚úÖ ${materials.length} materiales cargados desde Firebase`);
                    }
                });
            }
            
            // Sincronizaci√≥n en tiempo real
            function setupRealtimeSync() {
                if (!currentUser) return;
                
                const userRef = db.collection('users').doc(currentUser.uid);
                
                // Escuchar cambios en tareas
                userRef.collection('tasks').onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added' || change.type === 'modified') {
                            const task = {...change.doc.data(), id: change.doc.id};
                            const index = tasks.findIndex(t => t.id === task.id);
                            if (index === -1) {
                                tasks.push(task);
                            } else {
                                tasks[index] = task;
                            }
                        } else if (change.type === 'removed') {
                            tasks = tasks.filter(t => t.id !== change.doc.id);
                        }
                    });
                    localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
                    renderTasks();
                    updateDashboardStats();
                });
            }
            
            // SISTEMA DE NOTIFICACIONES AUTOM√ÅTICAS
            function checkUpcomingTasksAndEvents() {
                const now = new Date();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                
                const tomorrowStr = tomorrow.toISOString().split('T')[0];
                const todayStr = now.toISOString().split('T')[0];
                
                // Revisar tareas para ma√±ana
                tasks.forEach(task => {
                    if (task.status !== 'completed' && task.dueDate === tomorrowStr) {
                        sendNotification('üìö Tarea para ma√±ana', {
                            body: `${task.title} - Prioridad: ${task.priority}`,
                            tag: `task-${task.id}`
                        });
                    }
                });
                
                // Revisar eventos de hoy
                events.forEach(event => {
                    if (event.date === todayStr) {
                        sendNotification('üìÖ Evento hoy', {
                            body: `${event.title}${event.time ? ' a las ' + event.time : ''}`,
                            tag: `event-${event.id}`
                        });
                    }
                });
            }
            
            // Revisar notificaciones al cargar y cada hora
            setTimeout(() => {
                if (Notification.permission === 'granted') {
                    checkUpcomingTasksAndEvents();
                }
            }, 3000);
            
            setInterval(() => {
                if (Notification.permission === 'granted') {
                    checkUpcomingTasksAndEvents();
                }
            }, 3600000); // Cada hora
            
            } // Fin de initFirebase
            
            // Iniciar Firebase
            initFirebase();
            
            // REGISTRAR SERVICE WORKER (archivo externo)
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registrado:', registration);
                    })
                    .catch(error => {
                        console.log('‚ö†Ô∏è Error al registrar Service Worker:', error);
                    });
            }
            
            // SISTEMA DE NOTIFICACIONES
            window.requestNotificationPermission = async function() {
                if (!('Notification' in window)) {
                    console.log('Este navegador no soporta notificaciones');
                    return false;
                }
                
                if (Notification.permission === 'granted') {
                    return true;
                }
                
                if (Notification.permission !== 'denied') {
                    const permission = await Notification.requestPermission();
                    return permission === 'granted';
                }
                
                return false;
            };
            
            // Funci√≥n para enviar notificaci√≥n
            window.sendNotification = function(title, options = {}) {
                if (Notification.permission === 'granted') {
                    const notification = new Notification(title, {
                        icon: 'icon-192.png',
                        badge: 'icon-192.png',
                        vibrate: [200, 100, 200],
                        ...options
                    });
                    
                    notification.onclick = () => {
                        window.focus();
                        notification.close();
                    };
                }
            };
            
            // Pedir permisos al cargar (opcional, puedes comentar esta l√≠nea)
            // setTimeout(() => requestNotificationPermission(), 2000);
            
            console.log('Rayan Platform initialized successfully!');
            
            // Setup navigation clicks
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.dataset.page;
                    if (page) {
                        console.log('Click en navegaci√≥n:', page);
                        navigateTo(page);
                    }
                });
            });
            
            // Load tasks
            loadTasks();
            
            // Render calendar
            console.log('Renderizando calendario inicial...');
            renderCalendar();
            renderUpcomingEvents();
            
            // Render courses
            console.log('Renderizando cursos inicial...');
            renderCourses();
            updateCoursesStats();
            
            // Render schedule
            renderSchedule();
            
            // Populate current origin for Google setup
            const currentOriginEl = document.getElementById('currentOrigin');
            const currentRedirectEl = document.getElementById('currentRedirectUri');
            if (currentOriginEl) {
                currentOriginEl.textContent = window.location.origin;
            }
            if (currentRedirectEl) {
                currentRedirectEl.textContent = window.location.origin;
            }
            
            // Initialize Google APIs with delay to ensure scripts are loaded
            setTimeout(() => {
                console.log('Inicializando Google APIs...');
                if (typeof gapi !== 'undefined') {
                    gapiLoaded();
                } else {
                    console.log('gapi no disponible a√∫n, reintentando...');
                    setTimeout(() => {
                        if (typeof gapi !== 'undefined') gapiLoaded();
                    }, 1000);
                }
                
                if (typeof google !== 'undefined' && google.accounts) {
                    gisLoaded();
                } else {
                    console.log('google identity services no disponible a√∫n, reintentando...');
                    setTimeout(() => {
                        if (typeof google !== 'undefined' && google.accounts) gisLoaded();
                    }, 1000);
                }
            }, 500);
            
            // Wait a bit for DOM to be fully ready
            setTimeout(() => {
                // Make sure chat input exists before adding listener
                const chatInput = document.getElementById('chatInput');
                if (chatInput && !chatInput.dataset.listenerAdded) {
                    chatInput.addEventListener('keypress', e => {
                        if (e.key === 'Enter') {
                            sendMessage();
                        }
                    });
                    chatInput.dataset.listenerAdded = 'true';
                }
            }, 100);
        });
        
        
        // ========================================
        //  SISTEMA DE TEMAS PERSONALIZABLES
        // ========================================
        
        const THEME_KEY = 'rayan_theme';
        
        // Temas predefinidos
        const themePresets = {
            default: {
                primary: '#3b82f6',
                secondary: '#8b5cf6',
                bg: '#f9fafb',
                sidebar: '#ffffff',
                gradient: false
            },
            dark: {
                primary: '#60a5fa',
                secondary: '#a78bfa',
                bg: '#1f2937',
                sidebar: '#111827',
                gradient: false
            },
            sunset: {
                primary: '#f97316',
                secondary: '#ec4899',
                bg: '#fff7ed',
                sidebar: '#ffffff',
                gradient: true,
                gradientColor1: '#fb923c',
                gradientColor2: '#ec4899',
                gradientAngle: '135'
            },
            ocean: {
                primary: '#0ea5e9',
                secondary: '#06b6d4',
                bg: '#f0f9ff',
                sidebar: '#ffffff',
                gradient: true,
                gradientColor1: '#38bdf8',
                gradientColor2: '#0284c7',
                gradientAngle: '135'
            },
            forest: {
                primary: '#10b981',
                secondary: '#059669',
                bg: '#f0fdf4',
                sidebar: '#ffffff',
                gradient: true,
                gradientColor1: '#34d399',
                gradientColor2: '#047857',
                gradientAngle: '135'
            },
            fire: {
                primary: '#ef4444',
                secondary: '#f97316',
                bg: '#fef2f2',
                sidebar: '#ffffff',
                gradient: true,
                gradientColor1: '#fbbf24',
                gradientColor2: '#dc2626',
                gradientAngle: '135'
            },
            purple: {
                primary: '#a855f7',
                secondary: '#8b5cf6',
                bg: '#faf5ff',
                sidebar: '#ffffff',
                gradient: true,
                gradientColor1: '#c084fc',
                gradientColor2: '#7c3aed',
                gradientAngle: '135'
            },
            neon: {
                primary: '#06b6d4',
                secondary: '#d946ef',
                bg: '#0f172a',
                sidebar: '#1e293b',
                gradient: true,
                gradientColor1: '#22d3ee',
                gradientColor2: '#e879f9',
                gradientAngle: '135'
            },
            pastel: {
                primary: '#f472b6',
                secondary: '#c084fc',
                bg: '#fdf4ff',
                sidebar: '#ffffff',
                gradient: true,
                gradientColor1: '#fbcfe8',
                gradientColor2: '#ddd6fe',
                gradientAngle: '135'
            },
            sepia: {
                primary: '#d97706',
                secondary: '#b45309',
                bg: '#fffbeb',
                sidebar: '#fef3c7',
                gradient: false
            }
        };
        
        // Aplicar preset
        function applyPreset(presetName) {
            const theme = themePresets[presetName];
            if (!theme) return;
            
            document.getElementById('primaryColor').value = theme.primary;
            document.getElementById('primaryColorHex').value = theme.primary;
            document.getElementById('secondaryColor').value = theme.secondary;
            document.getElementById('secondaryColorHex').value = theme.secondary;
            document.getElementById('bgColor').value = theme.bg;
            document.getElementById('bgColorHex').value = theme.bg;
            document.getElementById('sidebarColor').value = theme.sidebar;
            document.getElementById('sidebarColorHex').value = theme.sidebar;
            
            if (theme.gradient) {
                document.getElementById('enableGradient').checked = true;
                document.getElementById('gradientControls').style.display = 'block';
                document.getElementById('gradientColor1').value = theme.gradientColor1;
                document.getElementById('gradientColor2').value = theme.gradientColor2;
                document.getElementById('gradientAngle').value = theme.gradientAngle || 135;
                document.getElementById('gradientAngleValue').textContent = theme.gradientAngle || 135;
            } else {
                document.getElementById('enableGradient').checked = false;
                document.getElementById('gradientControls').style.display = 'none';
            }
            
            updateThemePreview();
            applyCustomTheme();
        }
        
        // Toggle degradado
        function toggleGradient() {
            const enabled = document.getElementById('enableGradient').checked;
            document.getElementById('gradientControls').style.display = enabled ? 'block' : 'none';
            updateThemePreview();
        }
        
        // Actualizar √°ngulo del degradado
        function updateGradientAngle() {
            const angle = document.getElementById('gradientAngle').value;
            document.getElementById('gradientAngleValue').textContent = angle;
            updateThemePreview();
        }
        
        // Actualizar color desde hex input
        function updateColorFromHex(type) {
            const hexInput = document.getElementById(`${type}ColorHex`);
            const colorPicker = document.getElementById(`${type}Color`);
            colorPicker.value = hexInput.value;
            updateThemePreview();
        }
        
        // Actualizar vista previa
        function updateThemePreview() {
            const preview = document.getElementById('themePreview');
            const primary = document.getElementById('primaryColor').value;
            const bg = document.getElementById('bgColor').value;
            const gradientEnabled = document.getElementById('enableGradient').checked;
            
            if (gradientEnabled) {
                const color1 = document.getElementById('gradientColor1').value;
                const color2 = document.getElementById('gradientColor2').value;
                const angle = document.getElementById('gradientAngle').value;
                preview.style.background = `linear-gradient(${angle}deg, ${color1}, ${color2})`;
            } else {
                preview.style.background = bg;
            }
            
            preview.querySelector('.w-12').style.background = primary;
        }
        
        // Aplicar tema personalizado
        function applyCustomTheme() {
            const theme = {
                primary: document.getElementById('primaryColor').value,
                secondary: document.getElementById('secondaryColor').value,
                bg: document.getElementById('bgColor').value,
                sidebar: document.getElementById('sidebarColor').value,
                gradient: document.getElementById('enableGradient').checked
            };
            
            if (theme.gradient) {
                theme.gradientColor1 = document.getElementById('gradientColor1').value;
                theme.gradientColor2 = document.getElementById('gradientColor2').value;
                theme.gradientAngle = document.getElementById('gradientAngle').value;
            }
            
            applyThemeToDOM(theme);
            saveThemeToFirebase(theme);
            
            // Notificaci√≥n
            alert('‚úÖ Tema aplicado correctamente');
        }
        
        // Aplicar tema al DOM
        function applyThemeToDOM(theme) {
            const root = document.documentElement;
            root.style.setProperty('--color-primary', theme.primary);
            root.style.setProperty('--color-secondary', theme.secondary);
            root.style.setProperty('--color-bg', theme.bg);
            root.style.setProperty('--color-sidebar', theme.sidebar);
            
            if (theme.gradient) {
                root.style.setProperty('--gradient-color1', theme.gradientColor1);
                root.style.setProperty('--gradient-color2', theme.gradientColor2);
                root.style.setProperty('--gradient-angle', theme.gradientAngle + 'deg');
                document.body.classList.add('gradient-enabled');
            } else {
                document.body.classList.remove('gradient-enabled');
            }
            
            localStorage.setItem(THEME_KEY, JSON.stringify(theme));
        }
        
        // Guardar tema en Firebase
        async function saveThemeToFirebase(theme) {
            if (!currentUser) return;
            
            try {
                await db.collection('users').doc(currentUser.uid).set({
                    theme: theme
                }, { merge: true });
                console.log('‚úÖ Tema guardado en Firebase');
            } catch (error) {
                console.error('Error guardando tema:', error);
            }
        }
        
        // Cargar tema desde Firebase
        async function loadThemeFromFirebase() {
            if (!currentUser) return;
            
            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                if (doc.exists && doc.data().theme) {
                    const theme = doc.data().theme;
                    applyThemeToDOM(theme);
                    console.log('‚úÖ Tema cargado desde Firebase');
                }
            } catch (error) {
                console.error('Error cargando tema:', error);
            }
        }
        
        // Resetear tema
        function resetTheme() {
            if (confirm('¬øResetear al tema por defecto?')) {
                applyPreset('default');
            }
        }
        
        // Cargar tema al iniciar
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem(THEME_KEY);
            if (savedTheme) {
                try {
                    const theme = JSON.parse(savedTheme);
                    applyThemeToDOM(theme);
                } catch (e) {
                    console.error('Error cargando tema:', e);
                }
            }
        });
        
        // Sincronizar inputs de color
        ['primary', 'secondary', 'bg', 'sidebar'].forEach(type => {
            const colorPicker = document.getElementById(`${type}Color`);
            const hexInput = document.getElementById(`${type}ColorHex`);
            
            if (colorPicker && hexInput) {
                colorPicker.addEventListener('input', (e) => {
                    hexInput.value = e.target.value;
                    updateThemePreview();
                });
            }
        });
        
        ['gradientColor1', 'gradientColor2'].forEach(id => {
            const picker = document.getElementById(id);
            if (picker) {
                picker.addEventListener('input', updateThemePreview);
            }
        });
        
        
        // ========================================
        //  CENTRO DE SELECTIVIDAD / PAU
        // ========================================
        
        const FECHA_PAU_KEY = 'rayan_fecha_pau';
        const PROGRESO_PAU_KEY = 'rayan_progreso_pau';
        const CHECKLIST_PAU_KEY = 'rayan_checklist_pau';
        
        // Fecha por defecto: 5 de junio de 2025
        let fechaPAU = new Date('2025-06-05T08:00:00');
        
        // Cargar fecha guardada
        const savedFecha = localStorage.getItem(FECHA_PAU_KEY);
        if (savedFecha) {
            fechaPAU = new Date(savedFecha);
        }
        
        // Actualizar contador
        function actualizarContadorPAU() {
            const ahora = new Date();
            const diff = fechaPAU - ahora;
            
            if (diff < 0) {
                document.getElementById('diasRestantes').textContent = '0';
                document.getElementById('horasRestantes').textContent = '0';
                document.getElementById('minutosRestantes').textContent = '0';
                return;
            }
            
            const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
            const horas = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            document.getElementById('diasRestantes').textContent = dias;
            document.getElementById('horasRestantes').textContent = horas;
            document.getElementById('minutosRestantes').textContent = minutos;
        }
        
        // Actualizar cada minuto
        setInterval(actualizarContadorPAU, 60000);
        actualizarContadorPAU();
        
        // Configurar fecha PAU
        function abrirConfigFechaPAU() {
            const fechaActual = fechaPAU.toISOString().split('T')[0];
            const nuevaFecha = prompt('Fecha de tu primer examen de PAU (YYYY-MM-DD):', fechaActual);
            
            if (nuevaFecha) {
                fechaPAU = new Date(nuevaFecha + 'T08:00:00');
                localStorage.setItem(FECHA_PAU_KEY, fechaPAU.toISOString());
                actualizarContadorPAU();
                
                const opciones = { day: 'numeric', month: 'long', year: 'numeric' };
                document.getElementById('fechaPAUDisplay').textContent = fechaPAU.toLocaleDateString('es-ES', opciones);
            }
        }
        
        // Calculadora nota PAU
        function calcularNotaPAU() {
            const notaBach = parseFloat(document.getElementById('notaBach').value) || 0;
            const lengua = parseFloat(document.getElementById('notaLengua').value) || 0;
            const historia = parseFloat(document.getElementById('notaHistoria').value) || 0;
            const ingles = parseFloat(document.getElementById('notaIngles').value) || 0;
            const modalidad = parseFloat(document.getElementById('notaModalidad').value) || 0;
            
            // Nota de acceso = 40% Bach + 60% Fase General
            const faseGeneral = (lengua + historia + ingles + modalidad) / 4;
            const notaAcceso = (notaBach * 0.4) + (faseGeneral * 0.6);
            
            document.getElementById('notaAcceso').textContent = notaAcceso.toFixed(2);
            
            // Tambi√©n calcular admisi√≥n si hay datos
            calcularNotaAdmision();
        }
        
        // Calculadora nota de admisi√≥n
        function calcularNotaAdmision() {
            const notaAccesoText = document.getElementById('notaAcceso').textContent;
            if (notaAccesoText === '--') {
                document.getElementById('notaAdmision').textContent = '--';
                return;
            }
            
            const notaAcceso = parseFloat(notaAccesoText);
            
            const esp1 = parseFloat(document.getElementById('especifica1').value) || 0;
            const esp2 = parseFloat(document.getElementById('especifica2').value) || 0;
            const esp3 = parseFloat(document.getElementById('especifica3').value) || 0;
            const esp4 = parseFloat(document.getElementById('especifica4').value) || 0;
            
            const pond1 = parseFloat(document.getElementById('ponderacion1').value);
            const pond2 = parseFloat(document.getElementById('ponderacion2').value);
            const pond3 = parseFloat(document.getElementById('ponderacion3').value);
            const pond4 = parseFloat(document.getElementById('ponderacion4').value);
            
            const faseEspecifica = (esp1 * pond1) + (esp2 * pond2) + (esp3 * pond3) + (esp4 * pond4);
            const notaAdmision = notaAcceso + faseEspecifica;
            
            document.getElementById('notaAdmision').textContent = Math.min(14, notaAdmision).toFixed(2);
        }
        
        // Base de datos de notas de corte (ejemplo)
        const notasCorte = {
            ucm: {
                informatica: { nombre: 'Ingenier√≠a Inform√°tica', nota: 12.850 },
                medicina: { nombre: 'Medicina', nota: 13.498 },
                derecho: { nombre: 'Derecho', nota: 12.127 },
                ade: { nombre: 'Administraci√≥n y Direcci√≥n de Empresas', nota: 11.890 },
                psicologia: { nombre: 'Psicolog√≠a', nota: 12.456 }
            },
            uam: {
                informatica: { nombre: 'Ingenier√≠a Inform√°tica', nota: 12.750 },
                medicina: { nombre: 'Medicina', nota: 13.450 },
                fisica: { nombre: 'F√≠sica', nota: 9.500 },
                matematicas: { nombre: 'Matem√°ticas', nota: 10.200 }
            },
            upm: {
                informatica: { nombre: 'Ingenier√≠a Inform√°tica', nota: 12.900 },
                industrial: { nombre: 'Ingenier√≠a Industrial', nota: 13.100 },
                aeroespacial: { nombre: 'Ingenier√≠a Aeroespacial', nota: 13.350 },
                telecomunicaciones: { nombre: 'Ingenier√≠a de Telecomunicaci√≥n', nota: 12.800 }
            },
            uc3m: {
                informatica: { nombre: 'Ingenier√≠a Inform√°tica', nota: 13.050 },
                industrial: { nombre: 'Ingenier√≠a Industrial', nota: 13.200 },
                derecho: { nombre: 'Derecho', nota: 12.800 },
                ade: { nombre: 'Administraci√≥n y Direcci√≥n de Empresas', nota: 12.500 }
            },
            urjc: {
                informatica: { nombre: 'Ingenier√≠a Inform√°tica', nota: 11.500 },
                videojuegos: { nombre: 'Dise√±o y Desarrollo de Videojuegos', nota: 12.200 },
                derecho: { nombre: 'Derecho', nota: 10.800 }
            }
        };
        
        // Cargar grados seg√∫n universidad
        function cargarGrados() {
            const uni = document.getElementById('universidadSelect').value;
            const gradoSelect = document.getElementById('gradoSelect');
            
            gradoSelect.innerHTML = '<option value="">Selecciona un grado...</option>';
            document.getElementById('resultadoSimulador').style.display = 'none';
            
            if (!uni || !notasCorte[uni]) return;
            
            Object.keys(notasCorte[uni]).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = notasCorte[uni][key].nombre;
                gradoSelect.appendChild(option);
            });
        }
        
        // Mostrar nota de corte y probabilidad
        function mostrarNotaCorte() {
            const uni = document.getElementById('universidadSelect').value;
            const grado = document.getElementById('gradoSelect').value;
            
            if (!uni || !grado || !notasCorte[uni][grado]) {
                document.getElementById('resultadoSimulador').style.display = 'none';
                return;
            }
            
            const info = notasCorte[uni][grado];
            const notaAdmisionText = document.getElementById('notaAdmision').textContent;
            
            document.getElementById('nombreGrado').textContent = info.nombre;
            document.getElementById('nombreUniversidad').textContent = document.getElementById('universidadSelect').options[document.getElementById('universidadSelect').selectedIndex].text;
            document.getElementById('notaCorte').textContent = info.nota.toFixed(3);
            
            // Calcular probabilidad
            if (notaAdmisionText !== '--') {
                const miNota = parseFloat(notaAdmisionText);
                const diferencia = miNota - info.nota;
                
                let mensaje, color;
                if (diferencia >= 0.5) {
                    mensaje = '‚úÖ ALTA probabilidad de entrar';
                    color = 'text-green-600 bg-green-50';
                } else if (diferencia >= 0) {
                    mensaje = '‚ö†Ô∏è MEDIA probabilidad de entrar (ajustado)';
                    color = 'text-yellow-600 bg-yellow-50';
                } else if (diferencia >= -0.5) {
                    mensaje = '‚ö†Ô∏è BAJA probabilidad (necesitas subir nota)';
                    color = 'text-orange-600 bg-orange-50';
                } else {
                    mensaje = '‚ùå Muy dif√≠cil con esta nota';
                    color = 'text-red-600 bg-red-50';
                }
                
                document.getElementById('probabilidadEntrada').innerHTML = `
                    <div class="inline-block px-6 py-3 rounded-lg ${color} font-semibold">
                        ${mensaje}
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Tu nota: ${miNota.toFixed(2)} | Diferencia: ${diferencia >= 0 ? '+' : ''}${diferencia.toFixed(2)}</p>
                `;
            }
            
            document.getElementById('resultadoSimulador').style.display = 'block';
        }
        
        // Gestionar progreso de estudio
        function abrirGestionProgreso() {
            alert('Pr√≥ximamente: Gestor completo de progreso por temas');
        }
        
        // Guardar checklist
        function guardarChecklist() {
            const checks = [];
            for (let i = 1; i <= 8; i++) {
                checks.push(document.getElementById(`check${i}`).checked);
            }
            
            localStorage.setItem(CHECKLIST_PAU_KEY, JSON.stringify(checks));
            
            const completados = checks.filter(c => c).length;
            document.getElementById('checklistCompletados').textContent = completados;
        }
        
        // Cargar checklist
        function cargarChecklist() {
            const saved = localStorage.getItem(CHECKLIST_PAU_KEY);
            if (saved) {
                const checks = JSON.parse(saved);
                checks.forEach((checked, i) => {
                    const checkbox = document.getElementById(`check${i + 1}`);
                    if (checkbox) checkbox.checked = checked;
                });
                guardarChecklist(); // Para actualizar contador
            }
        }
        
        // Cargar checklist al iniciar
        setTimeout(cargarChecklist, 500);
        
        // ========================================
        //  PIZARRA DIGITAL - CANVAS
        // ========================================
        
        let pizarraCanvas, pizarraCtx;
        let dibujando = false;
        let herramientaActual = 'pencil';
        let colorActual = '#000000';
        let grosorActual = 3;
        let historialPizarra = [];
        let indiceHistorial = -1;
        let puntoInicio = { x: 0, y: 0 };
        
        const PIZARRAS_KEY = 'rayan_pizarras';
        
        // Inicializar canvas
        function inicializarPizarra() {
            pizarraCanvas = document.getElementById('pizarraCanvas');
            if (!pizarraCanvas) return;
            
            pizarraCtx = pizarraCanvas.getContext('2d');
            
            // Ajustar tama√±o del canvas
            ajustarTama√±oCanvas();
            window.addEventListener('resize', ajustarTama√±oCanvas);
            
            // Fondo blanco
            pizarraCtx.fillStyle = '#ffffff';
            pizarraCtx.fillRect(0, 0, pizarraCanvas.width, pizarraCanvas.height);
            
            // Event listeners
            pizarraCanvas.addEventListener('mousedown', iniciarDibujo);
            pizarraCanvas.addEventListener('mousemove', dibujar);
            pizarraCanvas.addEventListener('mouseup', finalizarDibujo);
            pizarraCanvas.addEventListener('mouseout', finalizarDibujo);
            
            // Touch events para m√≥vil
            pizarraCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                pizarraCanvas.dispatchEvent(mouseEvent);
            });
            
            pizarraCanvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                pizarraCanvas.dispatchEvent(mouseEvent);
            });
            
            pizarraCanvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup', {});
                pizarraCanvas.dispatchEvent(mouseEvent);
            });
            
            guardarEnHistorial();
            cargarListaPizarras();
        }
        
        function ajustarTama√±oCanvas() {
            const rect = pizarraCanvas.parentElement.getBoundingClientRect();
            pizarraCanvas.width = rect.width;
            pizarraCanvas.height = rect.height;
        }
        
        function obtenerPosicionMouse(e) {
            const rect = pizarraCanvas.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }
        
        function iniciarDibujo(e) {
            dibujando = true;
            const pos = obtenerPosicionMouse(e);
            puntoInicio = pos;
            
            pizarraCtx.beginPath();
            pizarraCtx.moveTo(pos.x, pos.y);
        }
        
        function dibujar(e) {
            if (!dibujando) return;
            
            const pos = obtenerPosicionMouse(e);
            
            if (herramientaActual === 'pencil' || herramientaActual === 'marker' || herramientaActual === 'eraser') {
                pizarraCtx.lineWidth = herramientaActual === 'eraser' ? grosorActual * 3 : grosorActual;
                pizarraCtx.lineCap = 'round';
                pizarraCtx.lineJoin = 'round';
                
                if (herramientaActual === 'eraser') {
                    pizarraCtx.globalCompositeOperation = 'destination-out';
                } else {
                    pizarraCtx.globalCompositeOperation = 'source-over';
                    pizarraCtx.strokeStyle = colorActual;
                    
                    if (herramientaActual === 'marker') {
                        pizarraCtx.globalAlpha = 0.5;
                    } else {
                        pizarraCtx.globalAlpha = 1;
                    }
                }
                
                pizarraCtx.lineTo(pos.x, pos.y);
                pizarraCtx.stroke();
                pizarraCtx.beginPath();
                pizarraCtx.moveTo(pos.x, pos.y);
            }
        }
        
        function finalizarDibujo(e) {
            if (!dibujando) return;
            
            const pos = obtenerPosicionMouse(e);
            
            // Dibujar formas
            if (herramientaActual === 'line') {
                pizarraCtx.strokeStyle = colorActual;
                pizarraCtx.lineWidth = grosorActual;
                pizarraCtx.beginPath();
                pizarraCtx.moveTo(puntoInicio.x, puntoInicio.y);
                pizarraCtx.lineTo(pos.x, pos.y);
                pizarraCtx.stroke();
            } else if (herramientaActual === 'circle') {
                const radius = Math.sqrt(Math.pow(pos.x - puntoInicio.x, 2) + Math.pow(pos.y - puntoInicio.y, 2));
                pizarraCtx.strokeStyle = colorActual;
                pizarraCtx.lineWidth = grosorActual;
                pizarraCtx.beginPath();
                pizarraCtx.arc(puntoInicio.x, puntoInicio.y, radius, 0, 2 * Math.PI);
                pizarraCtx.stroke();
            } else if (herramientaActual === 'square') {
                const width = pos.x - puntoInicio.x;
                const height = pos.y - puntoInicio.y;
                pizarraCtx.strokeStyle = colorActual;
                pizarraCtx.lineWidth = grosorActual;
                pizarraCtx.strokeRect(puntoInicio.x, puntoInicio.y, width, height);
            }
            
            dibujando = false;
            pizarraCtx.globalAlpha = 1;
            guardarEnHistorial();
        }
        
        function cambiarHerramienta(herramienta) {
            herramientaActual = herramienta;
            
            // Actualizar UI
            document.querySelectorAll('.pizarra-tool').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('tool-' + herramienta).classList.add('active');
        }
        
        function actualizarGrosor() {
            grosorActual = parseInt(document.getElementById('brushSize').value);
            document.getElementById('brushSizeValue').textContent = grosorActual + 'px';
        }
        
        function cambiarColorRapido(color) {
            colorActual = color;
            document.getElementById('brushColor').value = color;
        }
        
        // Historial (deshacer/rehacer)
        function guardarEnHistorial() {
            const imageData = pizarraCanvas.toDataURL();
            
            // Eliminar estados futuros si estamos en medio del historial
            if (indiceHistorial < historialPizarra.length - 1) {
                historialPizarra = historialPizarra.slice(0, indiceHistorial + 1);
            }
            
            historialPizarra.push(imageData);
            indiceHistorial++;
            
            // Limitar historial a 50 estados
            if (historialPizarra.length > 50) {
                historialPizarra.shift();
                indiceHistorial--;
            }
        }
        
        function deshacerPizarra() {
            if (indiceHistorial > 0) {
                indiceHistorial--;
                cargarImagenEnCanvas(historialPizarra[indiceHistorial]);
            }
        }
        
        function rehacerPizarra() {
            if (indiceHistorial < historialPizarra.length - 1) {
                indiceHistorial++;
                cargarImagenEnCanvas(historialPizarra[indiceHistorial]);
            }
        }
        
        function cargarImagenEnCanvas(dataUrl) {
            const img = new Image();
            img.onload = function() {
                pizarraCtx.clearRect(0, 0, pizarraCanvas.width, pizarraCanvas.height);
                pizarraCtx.drawImage(img, 0, 0);
            };
            img.src = dataUrl;
        }
        
        function limpiarPizarra() {
            if (confirm('¬øLimpiar toda la pizarra?')) {
                pizarraCtx.fillStyle = '#ffffff';
                pizarraCtx.fillRect(0, 0, pizarraCanvas.width, pizarraCanvas.height);
                guardarEnHistorial();
            }
        }
        
        // Guardar/Cargar pizarras
        function guardarPizarra() {
            const nombre = prompt('Nombre de la pizarra:', 'Pizarra ' + new Date().toLocaleDateString());
            if (!nombre) return;
            
            const imageData = pizarraCanvas.toDataURL();
            const pizarras = JSON.parse(localStorage.getItem(PIZARRAS_KEY) || '[]');
            
            pizarras.push({
                id: Date.now(),
                nombre: nombre,
                fecha: new Date().toISOString(),
                data: imageData
            });
            
            localStorage.setItem(PIZARRAS_KEY, JSON.stringify(pizarras));
            cargarListaPizarras();
            alert('‚úÖ Pizarra guardada: ' + nombre);
        }
        
        function cargarListaPizarras() {
            const pizarras = JSON.parse(localStorage.getItem(PIZARRAS_KEY) || '[]');
            const container = document.getElementById('pizarrasGuardadas');
            
            if (!container) return;
            
            if (pizarras.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8 col-span-3">
                        <i class="fas fa-folder-open text-4xl mb-2"></i>
                        <p>No hay pizarras guardadas</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = pizarras.map(p => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                    <img src="${p.data}" class="w-full h-32 object-cover rounded mb-3 border border-gray-200">
                    <h3 class="font-semibold text-sm mb-1 truncate">${p.nombre}</h3>
                    <p class="text-xs text-gray-500 mb-3">${new Date(p.fecha).toLocaleDateString()}</p>
                    <div class="flex gap-2">
                        <button onclick="cargarPizarraGuardada(${p.id})" class="flex-1 bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600">
                            Cargar
                        </button>
                        <button onclick="eliminarPizarraGuardada(${p.id})" class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function cargarPizarra() {
            cargarListaPizarras();
            // La lista ya tiene botones para cargar cada pizarra
        }
        
        function cargarPizarraGuardada(id) {
            const pizarras = JSON.parse(localStorage.getItem(PIZARRAS_KEY) || '[]');
            const pizarra = pizarras.find(p => p.id === id);
            
            if (pizarra) {
                cargarImagenEnCanvas(pizarra.data);
                guardarEnHistorial();
            }
        }
        
        function eliminarPizarraGuardada(id) {
            if (!confirm('¬øEliminar esta pizarra?')) return;
            
            let pizarras = JSON.parse(localStorage.getItem(PIZARRAS_KEY) || '[]');
            pizarras = pizarras.filter(p => p.id !== id);
            localStorage.setItem(PIZARRAS_KEY, JSON.stringify(pizarras));
            cargarListaPizarras();
        }
        
        function exportarPizarra() {
            const link = document.createElement('a');
            link.download = 'pizarra-' + new Date().getTime() + '.png';
            link.href = pizarraCanvas.toDataURL();
            link.click();
        }
        
        // Sincronizar color picker
        document.addEventListener('DOMContentLoaded', () => {
            const colorPicker = document.getElementById('brushColor');
            if (colorPicker) {
                colorPicker.addEventListener('input', (e) => {
                    colorActual = e.target.value;
                });
            }
            
            // Inicializar widgets
            actualizarWidgets();
            setInterval(actualizarWidgets, 60000); // Actualizar cada minuto
        });
        
        // ========================================
        //  SISTEMA DE WIDGETS Y NOTIFICACIONES
        // ========================================
        
        const NOTIF_CONFIG_KEY = 'rayan_notif_config';
        
        // Configuraci√≥n de notificaciones
        let notifConfig = {
            clases: true,
            tareas: true,
            pau: true,
            tiempoAntes: 15 // minutos antes de clase
        };
        
        // Cargar configuraci√≥n
        const savedConfig = localStorage.getItem(NOTIF_CONFIG_KEY);
        if (savedConfig) {
            notifConfig = JSON.parse(savedConfig);
        }
        
        // Actualizar widgets del dashboard
        function actualizarWidgets() {
            actualizarWidgetProximaClase();
            actualizarWidgetDiasPAU();
            actualizarWidgetProgreso();
        }
        
        // Widget: Pr√≥xima Clase
        function actualizarWidgetProximaClase() {
            const widgetEl = document.getElementById('widgetProximaClase');
            if (!widgetEl) return;
            
            const ahora = new Date();
            const diaActual = ahora.getDay() === 0 ? 7 : ahora.getDay(); // Domingo = 7
            const horaActual = ahora.getHours() * 60 + ahora.getMinutes();
            
            // Buscar pr√≥xima clase
            let proximaClase = null;
            let menorDiferencia = Infinity;
            
            schedule.forEach(clase => {
                const [horaInicio, minInicio] = clase.startTime.split(':').map(Number);
                const minutoClase = horaInicio * 60 + minInicio;
                
                // Misma d√≠a
                if (clase.day === diaActual && minutoClase > horaActual) {
                    const diff = minutoClase - horaActual;
                    if (diff < menorDiferencia) {
                        menorDiferencia = diff;
                        proximaClase = { ...clase, diferencia: diff, esMismoDia: true };
                    }
                }
                // Pr√≥ximos d√≠as
                else if (clase.day > diaActual) {
                    const diffDias = (clase.day - diaActual) * 24 * 60;
                    const diff = diffDias + (minutoClase - horaActual);
                    if (diff < menorDiferencia) {
                        menorDiferencia = diff;
                        proximaClase = { ...clase, diferencia: diff, esMismoDia: false };
                    }
                }
            });
            
            if (proximaClase) {
                const dias = ['', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
                const horas = Math.floor(proximaClase.diferencia / 60);
                const minutos = proximaClase.diferencia % 60;
                
                let tiempoTexto;
                if (proximaClase.esMismoDia) {
                    if (horas === 0) {
                        tiempoTexto = `en ${minutos} min`;
                    } else {
                        tiempoTexto = `en ${horas}h ${minutos}min`;
                    }
                } else {
                    tiempoTexto = dias[proximaClase.day];
                }
                
                widgetEl.innerHTML = `
                    <p class="text-2xl font-bold text-blue-900 mb-1">${proximaClase.subject}</p>
                    <p class="text-sm text-gray-600 mb-1">${proximaClase.startTime} - ${proximaClase.endTime}</p>
                    <p class="text-sm text-blue-600 font-medium">${tiempoTexto}</p>
                    <p class="text-xs text-gray-500 mt-1">${proximaClase.room || 'Aula por confirmar'}</p>
                `;
                
                // Programar notificaci√≥n
                if (notifConfig.clases && proximaClase.esMismoDia && proximaClase.diferencia <= notifConfig.tiempoAntes && proximaClase.diferencia > 0) {
                    programarNotificacionClase(proximaClase);
                }
            } else {
                widgetEl.innerHTML = `
                    <p class="text-sm text-gray-600">No hay m√°s clases hoy</p>
                    <p class="text-xs text-gray-500 mt-2">¬°Disfruta tu tiempo libre!</p>
                `;
            }
        }
        
        // Widget: D√≠as hasta PAU
        function actualizarWidgetDiasPAU() {
            const widgetNum = document.getElementById('widgetDiasNumber');
            if (!widgetNum) return;
            
            const ahora = new Date();
            const diff = fechaPAU - ahora;
            
            if (diff < 0) {
                widgetNum.textContent = '0';
                return;
            }
            
            const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
            widgetNum.textContent = dias;
            
            // Notificaci√≥n semanal
            if (notifConfig.pau && dias % 7 === 0 && dias > 0) {
                programarNotificacionPAU(dias);
            }
        }
        
        // Widget: Progreso Semanal
        function actualizarWidgetProgreso() {
            const completadasEl = document.getElementById('widgetTareasCompletadas');
            const barEl = document.getElementById('widgetProgresoBar');
            if (!completadasEl || !barEl) return;
            
            const ahora = new Date();
            const inicioSemana = new Date(ahora);
            inicioSemana.setDate(ahora.getDate() - ahora.getDay() + 1); // Lunes
            inicioSemana.setHours(0, 0, 0, 0);
            
            const finSemana = new Date(inicioSemana);
            finSemana.setDate(inicioSemana.getDate() + 7);
            
            const tareasSemana = tasks.filter(t => {
                const fecha = new Date(t.dueDate);
                return fecha >= inicioSemana && fecha < finSemana;
            });
            
            const completadas = tareasSemana.filter(t => t.completed).length;
            const total = tareasSemana.length;
            const porcentaje = total > 0 ? Math.round((completadas / total) * 100) : 0;
            
            completadasEl.textContent = `${completadas}/${total}`;
            barEl.style.width = porcentaje + '%';
        }
        
        // Configurar notificaciones
        function configurarNotificaciones() {
            const config = `
                <div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 400px;">
                    <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">‚öôÔ∏è Configurar Notificaciones</h2>
                    
                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        <input type="checkbox" ${notifConfig.clases ? 'checked' : ''} id="notifClases">
                        Notificar antes de clases
                    </label>
                    
                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        <input type="checkbox" ${notifConfig.tareas ? 'checked' : ''} id="notifTareas">
                        Notificar tareas por vencer
                    </label>
                    
                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        <input type="checkbox" ${notifConfig.pau ? 'checked' : ''} id="notifPAU">
                        Recordatorio semanal PAU
                    </label>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Tiempo antes de clase:</label>
                        <input type="number" id="notifTiempo" value="${notifConfig.tiempoAntes}" min="5" max="60" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 0.5rem;">
                        <p style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">minutos</p>
                    </div>
                    
                    <button onclick="guardarConfigNotif()" style="width: 100%; background: #3b82f6; color: white; padding: 0.75rem; border: none; border-radius: 0.5rem; font-weight: 500; cursor: pointer;">
                        Guardar
                    </button>
                </div>
            `;
            
            // Modal simple
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
            modal.innerHTML = config;
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            document.body.appendChild(modal);
        }
        
        function guardarConfigNotif() {
            notifConfig.clases = document.getElementById('notifClases').checked;
            notifConfig.tareas = document.getElementById('notifTareas').checked;
            notifConfig.pau = document.getElementById('notifPAU').checked;
            notifConfig.tiempoAntes = parseInt(document.getElementById('notifTiempo').value);
            
            localStorage.setItem(NOTIF_CONFIG_KEY, JSON.stringify(notifConfig));
            
            document.querySelector('[style*="position: fixed"]').remove();
            alert('‚úÖ Configuraci√≥n guardada');
        }
        
        // Enviar notificaci√≥n de prueba
        function enviarNotificacionPrueba() {
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    new Notification('üéì Rayan App', {
                        body: '¬°Las notificaciones est√°n funcionando correctamente!',
                        icon: 'icon-192.png',
                        badge: 'icon-192.png'
                    });
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            enviarNotificacionPrueba();
                        }
                    });
                } else {
                    alert('‚ö†Ô∏è Las notificaciones est√°n bloqueadas. Act√≠valas en la configuraci√≥n de tu navegador.');
                }
            } else {
                alert('‚ö†Ô∏è Tu navegador no soporta notificaciones.');
            }
        }
        
        // Programar notificaciones
        function programarNotificacionClase(clase) {
            const key = `notif_clase_${clase.id}_${new Date().toDateString()}`;
            if (localStorage.getItem(key)) return; // Ya notificado hoy
            
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(`üìö Pr√≥xima clase: ${clase.subject}`, {
                    body: `En ${notifConfig.tiempoAntes} minutos - ${clase.room || 'Ver horario'}`,
                    icon: 'icon-192.png',
                    badge: 'icon-192.png'
                });
                localStorage.setItem(key, 'true');
            }
        }
        
        function programarNotificacionPAU(dias) {
            const key = `notif_pau_${dias}`;
            if (localStorage.getItem(key)) return;
            
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('üéì Recordatorio PAU', {
                    body: `Quedan ${dias} d√≠as para la Selectividad. ¬°Sigue as√≠!`,
                    icon: 'icon-512.png',
                    badge: 'icon-512.png'
                });
                localStorage.setItem(key, 'true');
            }
        }
        
        // ========================================
        //  SISTEMA DE COMPARTIR Y EXPORTAR
        // ========================================
        
        let currentImageData = null;
        
        // Compartir Horario
        function compartirHorario() {
            const estilo = document.getElementById('horarioEstilo').value;
            const canvas = document.getElementById('shareCanvas');
            const ctx = canvas.getContext('2d');
            
            // Tama√±o Instagram Story (1080x1920)
            canvas.width = 1080;
            canvas.height = 1920;
            
            // Estilos seg√∫n selecci√≥n
            let bgColor, textColor, accentColor, secondaryColor;
            
            switch(estilo) {
                case 'dark':
                    bgColor = '#1f2937';
                    textColor = '#ffffff';
                    accentColor = '#3b82f6';
                    secondaryColor = '#6b7280';
                    break;
                case 'colorful':
                    bgColor = '#fef3c7';
                    textColor = '#1f2937';
                    accentColor = '#f59e0b';
                    secondaryColor = '#92400e';
                    break;
                case 'gradient':
                    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                    gradient.addColorStop(0, '#667eea');
                    gradient.addColorStop(1, '#764ba2');
                    bgColor = gradient;
                    textColor = '#ffffff';
                    accentColor = '#fbbf24';
                    secondaryColor = '#e0e7ff';
                    break;
                default: // clean
                    bgColor = '#ffffff';
                    textColor = '#1f2937';
                    accentColor = '#3b82f6';
                    secondaryColor = '#6b7280';
            }
            
            // Fondo
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // T√≠tulo
            ctx.fillStyle = textColor;
            ctx.font = 'bold 80px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('üìÖ Mi Horario', canvas.width / 2, 150);
            
            ctx.font = '40px Arial';
            ctx.fillStyle = secondaryColor;
            ctx.fillText('Semana Acad√©mica', canvas.width / 2, 220);
            
            // D√≠as de la semana
            const dias = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes'];
            const startY = 350;
            const rowHeight = 280;
            
            dias.forEach((dia, idx) => {
                const y = startY + (idx * rowHeight);
                
                // Caja del d√≠a
                ctx.fillStyle = accentColor;
                ctx.fillRect(80, y, 920, 70);
                
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 50px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(dia, 120, y + 50);
                
                // Clases del d√≠a
                const clasesDelDia = schedule.filter(c => c.day === idx + 1);
                
                if (clasesDelDia.length > 0) {
                    clasesDelDia.slice(0, 3).forEach((clase, claseIdx) => {
                        const claseY = y + 120 + (claseIdx * 60);
                        
                        ctx.fillStyle = textColor;
                        ctx.font = '35px Arial';
                        ctx.fillText(`${clase.startTime} - ${clase.endTime}`, 120, claseY);
                        
                        ctx.font = 'bold 38px Arial';
                        ctx.fillText(clase.subject, 400, claseY);
                    });
                } else {
                    ctx.fillStyle = secondaryColor;
                    ctx.font = 'italic 35px Arial';
                    ctx.fillText('Sin clases', 120, y + 120);
                }
            });
            
            // Pie de p√°gina
            ctx.fillStyle = secondaryColor;
            ctx.font = '30px Arial';
            ctx.textAlign = 'center';
            const ahora = new Date();
            ctx.fillText(`Generado el ${ahora.toLocaleDateString()}`, canvas.width / 2, canvas.height - 50);
            
            mostrarPreview(canvas);
        }
        
        // Compartir Tareas
        function compartirTareas() {
            const filtro = document.getElementById('tareasFiltro').value;
            const canvas = document.getElementById('shareCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 1080;
            canvas.height = 1920;
            
            // Fondo degradado
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#10b981');
            gradient.addColorStop(1, '#059669');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // T√≠tulo
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 80px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('‚úÖ Mis Tareas', canvas.width / 2, 150);
            
            // Filtrar tareas
            let tareasFiltradas = tasks;
            const ahora = new Date();
            
            switch(filtro) {
                case 'pending':
                    tareasFiltradas = tasks.filter(t => !t.completed);
                    break;
                case 'high':
                    tareasFiltradas = tasks.filter(t => !t.completed && t.priority === 'high');
                    break;
                case 'today':
                    tareasFiltradas = tasks.filter(t => {
                        const fecha = new Date(t.dueDate);
                        return fecha.toDateString() === ahora.toDateString() && !t.completed;
                    });
                    break;
                case 'week':
                    const finSemana = new Date(ahora);
                    finSemana.setDate(ahora.getDate() + 7);
                    tareasFiltradas = tasks.filter(t => {
                        const fecha = new Date(t.dueDate);
                        return fecha >= ahora && fecha <= finSemana && !t.completed;
                    });
                    break;
            }
            
            // Subt√≠tulo con conteo
            ctx.font = '45px Arial';
            ctx.fillText(`${tareasFiltradas.length} tareas`, canvas.width / 2, 230);
            
            // Listar tareas (m√°ximo 12)
            const startY = 350;
            tareasFiltradas.slice(0, 12).forEach((tarea, idx) => {
                const y = startY + (idx * 120);
                
                // Caja de tarea
                ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
                ctx.fillRect(80, y, 920, 100);
                
                // Checkbox
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 4;
                ctx.strokeRect(120, y + 25, 50, 50);
                
                // Texto de tarea
                ctx.fillStyle = '#1f2937';
                ctx.font = 'bold 38px Arial';
                ctx.textAlign = 'left';
                const textoCorto = tarea.title.length > 35 ? tarea.title.substring(0, 35) + '...' : tarea.title;
                ctx.fillText(textoCorto, 200, y + 50);
                
                // Fecha y prioridad
                ctx.font = '28px Arial';
                ctx.fillStyle = '#6b7280';
                const fecha = new Date(tarea.dueDate).toLocaleDateString();
                ctx.fillText(fecha, 200, y + 80);
                
                // Indicador de prioridad
                const prioColor = tarea.priority === 'high' ? '#ef4444' : tarea.priority === 'medium' ? '#f59e0b' : '#10b981';
                ctx.fillStyle = prioColor;
                ctx.fillRect(920, y + 30, 50, 40);
            });
            
            // Mostrar si hay m√°s tareas
            if (tareasFiltradas.length > 12) {
                ctx.fillStyle = '#ffffff';
                ctx.font = '35px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`+ ${tareasFiltradas.length - 12} tareas m√°s`, canvas.width / 2, canvas.height - 100);
            }
            
            mostrarPreview(canvas);
        }
        
        // Compartir Progreso
        function compartirProgreso() {
            const periodo = document.getElementById('progresoFiltro').value;
            const canvas = document.getElementById('shareCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 1080;
            canvas.height = 1920;
            
            // Fondo degradado p√∫rpura
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#8b5cf6');
            gradient.addColorStop(1, '#6366f1');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // T√≠tulo
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 80px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('üìä Mi Progreso', canvas.width / 2, 150);
            
            // Calcular estad√≠sticas
            let tareasRelevantes = tasks;
            const ahora = new Date();
            let periodoTexto = '';
            
            if (periodo === 'week') {
                const inicioSemana = new Date(ahora);
                inicioSemana.setDate(ahora.getDate() - ahora.getDay() + 1);
                inicioSemana.setHours(0, 0, 0, 0);
                tareasRelevantes = tasks.filter(t => new Date(t.dueDate) >= inicioSemana);
                periodoTexto = 'Esta Semana';
            } else if (periodo === 'month') {
                const inicioMes = new Date(ahora.getFullYear(), ahora.getMonth(), 1);
                tareasRelevantes = tasks.filter(t => new Date(t.dueDate) >= inicioMes);
                periodoTexto = 'Este Mes';
            } else {
                periodoTexto = 'Todo el Tiempo';
            }
            
            ctx.font = '45px Arial';
            ctx.fillText(periodoTexto, canvas.width / 2, 230);
            
            const completadas = tareasRelevantes.filter(t => t.completed).length;
            const total = tareasRelevantes.length;
            const porcentaje = total > 0 ? Math.round((completadas / total) * 100) : 0;
            
            // C√≠rculo de progreso grande
            const centerX = canvas.width / 2;
            const centerY = 550;
            const radius = 250;
            
            // C√≠rculo de fondo
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 40;
            ctx.stroke();
            
            // C√≠rculo de progreso
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, -Math.PI / 2, (-Math.PI / 2) + (2 * Math.PI * porcentaje / 100));
            ctx.strokeStyle = '#fbbf24';
            ctx.lineWidth = 40;
            ctx.lineCap = 'round';
            ctx.stroke();
            
            // Porcentaje en el centro
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 120px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`${porcentaje}%`, centerX, centerY + 20);
            
            // Estad√≠sticas detalladas
            const statsY = 900;
            const stats = [
                { icon: '‚úÖ', label: 'Completadas', value: completadas },
                { icon: '‚è≥', label: 'Pendientes', value: total - completadas },
                { icon: 'üìö', label: 'Total', value: total }
            ];
            
            stats.forEach((stat, idx) => {
                const x = 200 + (idx * 280);
                
                // Caja de estad√≠stica
                ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
                ctx.fillRect(x - 100, statsY, 240, 200);
                
                ctx.fillStyle = '#ffffff';
                ctx.font = '70px Arial';
                ctx.fillText(stat.icon, x, statsY + 80);
                
                ctx.font = 'bold 60px Arial';
                ctx.fillText(stat.value, x, statsY + 140);
                
                ctx.font = '30px Arial';
                ctx.fillText(stat.label, x, statsY + 180);
            });
            
            // Cursos con m√°s progreso
            const cursoStats = {};
            tareasRelevantes.forEach(t => {
                if (!cursoStats[t.course]) {
                    cursoStats[t.course] = { total: 0, completadas: 0 };
                }
                cursoStats[t.course].total++;
                if (t.completed) cursoStats[t.course].completadas++;
            });
            
            const topCursos = Object.entries(cursoStats)
                .map(([curso, stats]) => ({
                    curso,
                    porcentaje: stats.total > 0 ? Math.round((stats.completadas / stats.total) * 100) : 0
                }))
                .sort((a, b) => b.porcentaje - a.porcentaje)
                .slice(0, 3);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 45px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('üèÜ Top Cursos', canvas.width / 2, 1200);
            
            topCursos.forEach((curso, idx) => {
                const y = 1280 + (idx * 100);
                ctx.font = '38px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`${idx + 1}. ${curso.curso}`, 150, y);
                
                ctx.textAlign = 'right';
                ctx.fillText(`${curso.porcentaje}%`, 930, y);
                
                // Barra de progreso
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.fillRect(150, y + 15, 780, 20);
                ctx.fillStyle = '#fbbf24';
                ctx.fillRect(150, y + 15, 780 * (curso.porcentaje / 100), 20);
            });
            
            // Fecha
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.font = '30px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`Actualizado: ${ahora.toLocaleDateString()}`, canvas.width / 2, canvas.height - 80);
            
            mostrarPreview(canvas);
        }
        
        // Compartir PAU
        function compartirPAU() {
            const incluirDias = document.getElementById('incluirDias').checked;
            const incluirNota = document.getElementById('incluirNota').checked;
            
            const canvas = document.getElementById('shareCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 1080;
            canvas.height = 1920;
            
            // Fondo degradado naranja/amarillo
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#f97316');
            gradient.addColorStop(1, '#ea580c');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // T√≠tulo
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 90px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('üéì SELECTIVIDAD', canvas.width / 2, 180);
            
            ctx.font = '50px Arial';
            ctx.fillText('PAU 2025', canvas.width / 2, 260);
            
            let currentY = 450;
            
            // D√≠as restantes
            if (incluirDias) {
                const ahora = new Date();
                const diff = fechaPAU - ahora;
                const dias = Math.max(0, Math.floor(diff / (1000 * 60 * 60 * 24)));
                
                ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.fillRect(150, currentY, 780, 400);
                
                ctx.fillStyle = '#f97316';
                ctx.font = 'bold 200px Arial';
                ctx.fillText(dias, canvas.width / 2, currentY + 180);
                
                ctx.font = 'bold 55px Arial';
                ctx.fillText('D√çAS RESTANTES', canvas.width / 2, currentY + 270);
                
                ctx.font = '40px Arial';
                ctx.fillStyle = '#6b7280';
                ctx.fillText(fechaPAU.toLocaleDateString(), canvas.width / 2, currentY + 340);
                
                currentY += 480;
            }
            
            // Nota estimada
            if (incluirNota) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.fillRect(150, currentY, 780, 300);
                
                ctx.fillStyle = '#10b981';
                ctx.font = 'bold 140px Arial';
                ctx.fillText(notaMediaEstimada.toFixed(2), canvas.width / 2, currentY + 150);
                
                ctx.font = 'bold 50px Arial';
                ctx.fillStyle = '#6b7280';
                ctx.fillText('NOTA ESTIMADA', canvas.width / 2, currentY + 230);
                
                currentY += 380;
            }
            
            // Mensaje motivacional
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 55px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('¬°T√ö PUEDES!', canvas.width / 2, currentY + 80);
            
            ctx.font = '40px Arial';
            ctx.fillText('Sigue trabajando duro', canvas.width / 2, currentY + 150);
            
            // Pie de p√°gina
            ctx.font = '35px Arial';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.fillText('üí™ #PAU2025 #Selectividad', canvas.width / 2, canvas.height - 100);
            
            mostrarPreview(canvas);
        }
        
        // Mostrar preview
        function mostrarPreview(canvas) {
            currentImageData = canvas.toDataURL('image/png');
            const previewDiv = document.getElementById('sharePreview');
            const previewImg = document.getElementById('sharePreviewImg');
            
            previewImg.src = currentImageData;
            previewDiv.style.display = 'block';
            
            // Scroll hacia preview
            previewDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Descargar imagen
        function descargarImagen() {
            if (!currentImageData) return;
            
            const link = document.createElement('a');
            link.download = `rayan-app-${Date.now()}.png`;
            link.href = currentImageData;
            link.click();
        }
        
        // Copiar imagen al portapapeles
        async function copiarImagen() {
            if (!currentImageData) return;
            
            try {
                const blob = await (await fetch(currentImageData)).blob();
                await navigator.clipboard.write([
                    new ClipboardItem({ 'image/png': blob })
                ]);
                alert('‚úÖ Imagen copiada al portapapeles');
            } catch (err) {
                alert('‚ö†Ô∏è No se pudo copiar. Usa el bot√≥n Descargar.');
            }
        }
        
        // Cerrar preview
        function cerrarPreview() {
            document.getElementById('sharePreview').style.display = 'none';
        }
        
        
        
        // ========================================
        //  PIZARRA INFINITA (Microsoft Whiteboard style)
        // ========================================
        
        let infinitaCanvas, infinitaCtx;
        let infinitaDibujando = false;
        let infinitaHerramienta = 'pencil';
        let infinitaColor = '#000000';
        let infinitaGrosor = 3;
        let infinitaOffsetX = 0, infinitaOffsetY = 0;
        let infinitaZoom = 1;
        let infinitaIsPanning = false;
        let infinitaLastX = 0, infinitaLastY = 0;
        let infinitaTrazos = [];
        
        function inicializarPizarraInfinita() {
            infinitaCanvas = document.getElementById('infinitaCanvas');
            if (!infinitaCanvas) return;
            
            infinitaCtx = infinitaCanvas.getContext('2d');
            
            // Tama√±o infinito (grande)
            infinitaCanvas.width = 5000;
            infinitaCanvas.height = 5000;
            
            // Fondo blanco
            infinitaCtx.fillStyle = '#ffffff';
            infinitaCtx.fillRect(0, 0, infinitaCanvas.width, infinitaCanvas.height);
            
            const container = document.getElementById('infinitaContainer');
            
            // Mouse events
            container.addEventListener('mousedown', (e) => {
                if (e.button === 1 || (e.button === 0 && e.ctrlKey)) {
                    infinitaIsPanning = true;
                    infinitaLastX = e.clientX;
                    infinitaLastY = e.clientY;
                    container.style.cursor = 'grabbing';
                } else {
                    iniciarDibujoInfinita(e);
                }
            });
            
            container.addEventListener('mousemove', (e) => {
                if (infinitaIsPanning) {
                    const dx = e.clientX - infinitaLastX;
                    const dy = e.clientY - infinitaLastY;
                    infinitaOffsetX += dx;
                    infinitaOffsetY += dy;
                    infinitaLastX = e.clientX;
                    infinitaLastY = e.clientY;
                    actualizarPosicionCanvas();
                } else {
                    dibujarInfinita(e);
                }
            });
            
            container.addEventListener('mouseup', () => {
                infinitaIsPanning = false;
                container.style.cursor = 'grab';
                finalizarDibujoInfinita();
            });
            
            // Zoom con rueda
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                infinitaZoom *= delta;
                infinitaZoom = Math.max(0.1, Math.min(infinitaZoom, 3));
                actualizarPosicionCanvas();
            });
            
            actualizarPosicionCanvas();
        }
        
        function actualizarPosicionCanvas() {
            infinitaCanvas.style.transform = `translate(${infinitaOffsetX}px, ${infinitaOffsetY}px) scale(${infinitaZoom})`;
        }
        
        function obtenerPosInfinita(e) {
            const rect = infinitaCanvas.getBoundingClientRect();
            return {
                x: (e.clientX - rect.left) / infinitaZoom,
                y: (e.clientY - rect.top) / infinitaZoom
            };
        }
        
        function iniciarDibujoInfinita(e) {
            infinitaDibujando = true;
            const pos = obtenerPosInfinita(e);
            infinitaCtx.beginPath();
            infinitaCtx.moveTo(pos.x, pos.y);
        }
        
        function dibujarInfinita(e) {
            if (!infinitaDibujando) return;
            
            const pos = obtenerPosInfinita(e);
            
            infinitaCtx.lineWidth = infinitaGrosor;
            infinitaCtx.lineCap = 'round';
            infinitaCtx.lineJoin = 'round';
            
            if (infinitaHerramienta === 'eraser') {
                infinitaCtx.globalCompositeOperation = 'destination-out';
                infinitaCtx.lineWidth = infinitaGrosor * 3;
            } else {
                infinitaCtx.globalCompositeOperation = 'source-over';
                infinitaCtx.strokeStyle = infinitaColor;
            }
            
            infinitaCtx.lineTo(pos.x, pos.y);
            infinitaCtx.stroke();
            infinitaCtx.beginPath();
            infinitaCtx.moveTo(pos.x, pos.y);
        }
        
        function finalizarDibujoInfinita() {
            infinitaDibujando = false;
        }
        
        function cambiarHerramientaInfinita(herramienta) {
            infinitaHerramienta = herramienta;
            document.querySelectorAll('#page-pizarra-infinita .pizarra-tool').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('inf-tool-' + herramienta).classList.add('active');
        }
        
        function limpiarPizarraInfinita() {
            if (confirm('¬øLimpiar toda la pizarra infinita?')) {
                infinitaCtx.fillStyle = '#ffffff';
                infinitaCtx.fillRect(0, 0, infinitaCanvas.width, infinitaCanvas.height);
            }
        }
        
        function resetZoomInfinita() {
            infinitaOffsetX = 0;
            infinitaOffsetY = 0;
            infinitaZoom = 1;
            actualizarPosicionCanvas();
        }
        
        function guardarPizarraInfinita() {
            const data = infinitaCanvas.toDataURL();
            const link = document.createElement('a');
            link.download = 'pizarra-infinita-' + Date.now() + '.png';
            link.href = data;
            link.click();
        }
        
        // Sincronizar inputs
        document.addEventListener('DOMContentLoaded', () => {
            const colorPicker = document.getElementById('infinitaBrushColor');
            const sizePicker = document.getElementById('infinitaBrushSize');
            
            if (colorPicker) {
                colorPicker.addEventListener('input', (e) => {
                    infinitaColor = e.target.value;
                });
            }
            
            if (sizePicker) {
                sizePicker.addEventListener('input', (e) => {
                    infinitaGrosor = parseInt(e.target.value);
                });
            }
        });
        
        // ========================================
        //  CONFIGURACI√ìN - PERSONALIZAR FONDO
        // ========================================
        
        const FONDO_CONFIG_KEY = 'rayan_fondo_config';
        
        function cambiarTipoFondo() {
            const tipo = document.getElementById('tipoFondo').value;
            
            document.getElementById('configColorSolido').style.display = tipo === 'color' ? 'block' : 'none';
            document.getElementById('configGradiente').style.display = tipo === 'gradiente' ? 'block' : 'none';
            document.getElementById('configImagen').style.display = tipo === 'imagen' ? 'block' : 'none';
            
            actualizarPreviewFondo();
        }
        
        function actualizarPreviewFondo() {
            const tipo = document.getElementById('tipoFondo').value;
            const preview = document.getElementById('fondoPreview');
            
            if (tipo === 'color') {
                const color = document.getElementById('fondoColor').value;
                preview.style.background = color;
            } else if (tipo === 'gradiente') {
                const color1 = document.getElementById('gradienteColor1App').value;
                const color2 = document.getElementById('gradienteColor2App').value;
                const dir = document.getElementById('gradienteDireccion').value;
                preview.style.background = `linear-gradient(${dir}, ${color1}, ${color2})`;
            } else if (tipo === 'imagen') {
                const url = document.getElementById('fondoImagenURL').value;
                if (url) {
                    preview.style.background = `url(${url}) center/cover`;
                }
            }
        }
        
        function aplicarGradientePreset(preset) {
            const presets = {
                sunset: ['#ff6b6b', '#ffa500'],
                ocean: ['#667eea', '#764ba2'],
                forest: ['#11998e', '#38ef7d'],
                fire: ['#f12711', '#f5af19'],
                purple: ['#8e2de2', '#4a00e0'],
                pink: ['#ff6a88', '#ffc868'],
                blue: ['#4facfe', '#00f2fe'],
                green: ['#43e97b', '#38f9d7']
            };
            
            const colors = presets[preset];
            document.getElementById('gradienteColor1App').value = colors[0];
            document.getElementById('gradienteColor2App').value = colors[1];
            actualizarPreviewFondo();
        }
        
        function aplicarFondoConfig() {
            const tipo = document.getElementById('tipoFondo').value;
            const mainContent = document.querySelector('.main-content');
            
            if (!mainContent) return;
            
            const config = { tipo };
            
            if (tipo === 'color') {
                const color = document.getElementById('fondoColor').value;
                mainContent.style.background = color;
                config.color = color;
            } else if (tipo === 'gradiente') {
                const color1 = document.getElementById('gradienteColor1App').value;
                const color2 = document.getElementById('gradienteColor2App').value;
                const dir = document.getElementById('gradienteDireccion').value;
                const gradient = `linear-gradient(${dir}, ${color1}, ${color2})`;
                mainContent.style.background = gradient;
                mainContent.style.backgroundAttachment = 'fixed';
                config.gradient = { color1, color2, dir };
            } else if (tipo === 'imagen') {
                const url = document.getElementById('fondoImagenURL').value;
                mainContent.style.background = `url(${url}) center/cover fixed`;
                config.imagen = url;
            }
            
            localStorage.setItem(FONDO_CONFIG_KEY, JSON.stringify(config));
            alert('‚úÖ Fondo aplicado correctamente');
        }
        
        function resetFondoConfig() {
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.style.background = '#f9fafb';
            }
            localStorage.removeItem(FONDO_CONFIG_KEY);
            document.getElementById('tipoFondo').value = 'color';
            document.getElementById('fondoColor').value = '#f9fafb';
            cambiarTipoFondo();
            alert('‚úÖ Fondo reseteado');
        }
        
        // Cargar fondo guardado al iniciar
        function cargarFondoGuardado() {
            const saved = localStorage.getItem(FONDO_CONFIG_KEY);
            if (!saved) return;
            
            try {
                const config = JSON.parse(saved);
                const mainContent = document.querySelector('.main-content');
                
                if (config.tipo === 'color') {
                    mainContent.style.background = config.color;
                } else if (config.tipo === 'gradiente') {
                    const { color1, color2, dir } = config.gradient;
                    mainContent.style.background = `linear-gradient(${dir}, ${color1}, ${color2})`;
                    mainContent.style.backgroundAttachment = 'fixed';
                } else if (config.tipo === 'imagen') {
                    mainContent.style.background = `url(${config.imagen}) center/cover fixed`;
                }
            } catch (e) {
                console.error('Error cargando fondo:', e);
            }
        }
        
        // Cargar al iniciar
        window.addEventListener('DOMContentLoaded', cargarFondoGuardado);
        
        // Listeners para preview en tiempo real
        document.addEventListener('DOMContentLoaded', () => {
            ['fondoColor', 'gradienteColor1App', 'gradienteColor2App', 'gradienteDireccion', 'fondoImagenURL'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', actualizarPreviewFondo);
                    el.addEventListener('change', actualizarPreviewFondo);
                }
            });
        });
        
        // Make gapiLoaded and gisLoaded available globally for the Google scripts
        window.gapiLoaded = gapiLoaded;
        window.gisLoaded = gisLoaded;
    </script>
    </div> <!-- End of mainApp -->
</body>
</html>
